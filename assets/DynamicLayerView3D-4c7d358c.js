import{n as F,e as _,y as x,a as Y}from"./JSONSupport-32b5ad86.js";import{c as k,b as B}from"./asyncUtils-8de18dd2.js";import{s as R}from"./Error-62cc7aff.js";import{t as G,w as N,r as H}from"./typedArrayUtil-70e1d79e.js";import{x as X,j as $,E as Z,v as J,p as K,a as U,f as j}from"./promiseUtils-59dab60c.js";import{j as Q}from"./reactiveUtils-e6d6c898.js";import"./ensureType-249b88cd.js";import{e as V}from"./Extent-2ad2c9a9.js";import{s as S,l as E,E as ee,I as te,u as D,a as b,U as ie}from"./aaBoundingRect-42f9721f.js";import{R as ae,S as re,e as se,C as ne,T as oe,V as C,W as v,X as he,Y as le}from"./index-8cd323f3.js";import{n as de}from"./LayerView3D-d0c2db8b.js";import{s as O}from"./Attribute-f72d3f37.js";import{n as me}from"./MeshComponent-76cc0acf.js";import{v as ce}from"./objectResourceUtils-f1a10a8c.js";import{O as p}from"./VertexAttribute-15d1866a.js";import{l as ge}from"./projectExtentUtils-6749f5fc.js";import{G as ue}from"./Texture-2b2e584f.js";import{c as fe}from"./ImageMaterial-4e661db5.js";import{u as pe}from"./LayerView-facba986.js";import{i as ye}from"./RefreshableLayerView-e9eef719.js";import{D as z}from"./enums-fc527c7c.js";function we(i,e,t){const r=S(i)/E(i),a={width:t,height:t};return r>1.0001?a.height=t/r:r<.9999&&(a.width=t*r),a.width=Math.round(a.width/(S(i)/S(e))),a.height=Math.round(a.height/(E(i)/E(e))),a}function W(i,e){return ae(i,[[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}function _e(i,e,t){if(!ee(e,t))return W(i,t);const r=[e[1]-t[1],Math.min(e[3],t[3])-Math.max(e[1],t[1]),t[3]-e[3],123456],a=[e[0]-t[0],Math.min(e[2],t[2])-Math.max(e[0],t[0]),t[2]-e[2],123456],h=t[2]-t[0],n=t[3]-t[1],s=a[0]>0&&a[2]>0?3:2,o=r[0]>0&&r[2]>0?3:2,l=(o+1)*(s+1),m=me(3*l),c=re(2*l),d=new Array(6*(o*s-1));let I=0,A=0,T=0,g=0,f=0;for(let y=0;y<4;y++){const L=r[y];if(L<=0)continue;let M=0;for(let w=0;w<4;w++){const P=a[w];P<=0||(m[A++]=t[0]+M,m[A++]=t[1]+I,m[A++]=-1,c[T++]=M/h,c[T++]=I/n,w<3&&y<3&&(w!==1||y!==1)&&(d[f++]=g,d[f++]=g+1,d[f++]=g+s+1,d[f++]=g+1,d[f++]=g+s+2,d[f++]=g+s+1),g++,M+=P)}I+=L}const q=new Array(d.length);return new ce(i,[[p.POSITION,new O(m,3,!0)],[p.NORMAL,new O(xe,3,!0)],[p.UV0,new O(c,2,!0)]],[[p.POSITION,d],[p.NORMAL,q],[p.UV0,d]])}const xe=[0,0,1];let u=class extends ye(de(pe)){constructor(){super(...arguments),this.drapeSourceType=se.RasterImage,this.updatePolicy=ne.SYNC,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this._drapeSourceRenderer=null,this.refreshDebounced=X(async i=>{this.destroyed||await this._doRefresh(i).catch(e=>{$(e)||R.getLogger(this.declaredClass).error(e)})},2e3)}initialize(){this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this),this.handles.add(F(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))),this.addResolvingPromise(ge(this).then(i=>this._set("fullExtentInLocalViewSpatialReference",i))),this.updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler()),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{})),this._isScaleRangeLayer()&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.notifyChange("suspended"))}destroy(){this.clear()}setDrapingExtent(i,e){this._spatialReference=e,i.forEach(t=>{this._overlays[t.index]=t,this._updateImageExtent(t)})}_updateImageExtent(i){const e=this._clippedExtent(i.extent,Re);if(G(e))return;const t=we(i.extent,e,i.resolution);let r=i.pixelRatio*this.view.state.pixelRatio;const{layer:a}=this;if("imageMaxWidth"in a&&a.imageMaxWidth!=null||"imageMaxHeight"in a&&a.imageMaxHeight!=null){const n=a.imageMaxWidth,s=a.imageMaxHeight;if(t.width>n){const o=n/t.width;t.height=Math.floor(t.height*o),t.width=n,r*=o}if(t.height>s){const o=s/t.height;t.width=Math.floor(t.width*o),t.height=s,r*=o}}const h=this._extents[i.index];h&&te(h.extent,e)&&this._imageSizeEquals(e,h.imageSize,t)||(this._extents[i.index]={extent:D(e),imageSize:t,pixelRatio:r},this.suspended||this._fetch(i.index).catch(n=>{$(n)||R.getLogger(this.declaredClass).error(n)}))}clear(){for(let i=0;i<this._images.length;i++)this._clearImage(i)}async doRefresh(){return this._doRefresh()}async _doRefresh(i){if(this.suspended)return;const e=[];for(let t=0;t<this._extents.length;t++)this._extents[t]&&e.push(this._fetch(t,i));await Z(e)}canResume(){if(!super.canResume())return!1;const i=this.layer;if(this._isScaleRangeActive()){const{minScale:e,maxScale:t}=i.effectiveScaleRange,r=this.view.scale;if(r<t||e>0&&r>e)return!1}return!0}isUpdating(){return this._images.some(i=>!!i.loadingPromise)}async processResult(i,e,t){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(i.image=e)}findExtentInfoAt(i){for(const e of this._extents){const t=e.extent;if(new V(t[0],t[1],t[2],t[3],this._spatialReference).contains(i))return e}return null}getFetchOptions(){}async redraw(i,e){await k(this._images,async(t,r)=>{t&&(await i(t,e),await this._createStageObjects(r,t.image,e))})}_imageSizeEquals(i,e,t){if(!this.maximumDataResolution)return!1;const r=S(i)/this.maximumDataResolution.x,a=E(i)/this.maximumDataResolution.y,h=r/e.width,n=a/e.height,s=r/t.width,o=a/t.height,l=Math.abs(h-s),m=Math.abs(n-o),c=oe.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return l<=c&&m<=c}async _fetch(i,e){if(this.suspended)return;const t=this._extents[i],r=t.extent;this._images[i]||(this._images[i]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:D(r)});const a=this._images[i];a.loadingAbortController=N(a.loadingAbortController);const h=new V(r[0],r[1],r[2],r[3],this._spatialReference);if(h.width===0||h.height===0)return void this._clearImage(i);const n=new AbortController;a.loadingAbortController=n,J(e,()=>n.abort());const s=n.signal,o=this._waitFetchReady(s).then(async()=>{const l={requestAsImageElement:!0,pixelRatio:this._overlays[i].pixelRatio,...this.getFetchOptions(),signal:s},{height:m,width:c}=t.imageSize;return this.layer.fetchImage(h,c,m,l)}).then(l=>{if(K(s))throw R.getLogger(this.declaredClass).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),U();return this.processResult(a,l)}).then(()=>{b(a.renderExtent,r)}).finally(()=>{o===a.loadingPromise&&(a.loadingPromise=null,a.loadingAbortController=null)});a.loadingPromise=o,this.notifyChange("updating"),await o.then(async()=>{if(s.aborted)throw U();await this._createStageObjects(i,a.image,s),this.notifyChange("updating")}).catch(l=>{throw l&&!$(l)&&R.getLogger(this.declaredClass).error(l),this.notifyChange("updating"),l})}_clearImage(i){const e=this._images[i];if(e){H(e.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([e.renderGeometry],C.UPDATE),e.renderGeometry=null);const t=this.view._stage;t.remove(e.texture),e.texture=null,t.remove(e.material),e.material=null,e.loadingAbortController=N(e.loadingAbortController),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(i,e,t){const r=this.view._stage,a=this._images[i],h=()=>{r.remove(a.texture),a.texture=null,H(a.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([a.renderGeometry],C.UPDATE),a.renderGeometry=null)};if(e){const n=new ue(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:z.CLAMP_TO_EDGE,t:z.CLAMP_TO_EDGE}});let s;if(await B(this._images[i===v.INNER?v.OUTER:v.INNER].loadingPromise),j(t),h(),r.add(n),await r.loadImmediate(n),a.texture=n,G(a.material)?(a.material=new fe({transparent:!0,textureId:n.id}),r.add(a.material)):a.material.setParameters({textureId:n.id}),i===v.INNER)s=W(a.material,a.renderExtent);else{const o=this._images[0].renderExtent;if(!o)return void h();s=_e(a.material,o,a.renderExtent)}a.renderGeometry=new he(s),a.renderGeometry.localOrigin=this._overlays[i].renderLocalOrigin,this._drapeSourceRenderer.addGeometries([a.renderGeometry],C.UPDATE)}else h(),r.remove(a.material),a.material=null}_isScaleRangeLayer(){return"effectiveScaleRange"in this.layer}_isScaleRangeActive(){const i=this.layer;if(!this._isScaleRangeLayer())return!1;const{minScale:e,maxScale:t}=i.effectiveScaleRange;return le(e,t)}_clippedExtent(i,e){if(this.view.viewingMode!=="local")return b(e,i);const t=this.view.basemapTerrain;return t.ready?ie(i,t.extent,e):b(e,i)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(i){await Q(()=>this.view.stationary,i),j(i)}};_([x()],u.prototype,"layer",void 0),_([x()],u.prototype,"suspended",void 0),_([x({readOnly:!0})],u.prototype,"fullExtentInLocalViewSpatialReference",void 0),_([x()],u.prototype,"updating",void 0),u=_([Y("esri.views.3d.layers.DynamicLayerView3D")],u);const We=u,Re=D();export{We as q};

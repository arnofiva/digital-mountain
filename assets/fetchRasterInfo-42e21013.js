import{e as b,y as T,a as ce,l as me,H as fe}from"./JSONSupport-32b5ad86.js";import{p as P}from"./string-7a2f1d87.js";import"./ensureType-249b88cd.js";import{o as $e}from"./enumeration-504d95a2.js";import{o as ne,r as Me,p as Fe,e as z,f as Ae,w as Ie}from"./Extent-2ad2c9a9.js";import"./geometry-f89ca072.js";import{r as m,t as v,e as A}from"./typedArrayUtil-70e1d79e.js";import{v as _e}from"./Polyline-cf51ad23.js";import{v as je}from"./jsonUtils-6d0a72e3.js";import{p as J,b as Pe,k as Ve,x as Be}from"./DimensionalDefinition-89a02a09.js";import{a as g}from"./Error-62cc7aff.js";import{u as Je}from"./workers-591e0dfc.js";import{b as S,J as Ue,_ as ae}from"./vectorFieldUtils-b0aae2f9.js";import{l as j}from"./Color-5a385b27.js";import{y as Le}from"./Field-efd8d6fa.js";import{u as de}from"./dataUtils-fc7a03b6.js";import{j as Re,f as re,T as ze}from"./UniqueValueRenderer-31cfe725.js";import"./generateRendererUtils-9fa055c1.js";import{a as he}from"./colorRamps-844ba070.js";import{U as C}from"./request-f01affa1.js";import{f as Ee,s as Ye,i as We}from"./normalizeUtils-11faac16.js";import{x as qe}from"./FeatureSet-adc6c42d.js";var E;const V=new Set(["raster","raster2","dem","fillraster"]),B=new Set(["rasters"]),ie=t=>t&&t.rasterFunction?p.fromJSON(t):t,R=t=>t&&t instanceof p?t.toJSON():t,Y=t=>(t==null?void 0:t.functionName)&&!t.declaredClass,se=t=>Y(t)?new p(t):t,Ge=t=>{if(t==null)return null;t=P(t);const e={};for(const n of Object.keys(t))V.has(n.toLowerCase())?e[n]=ie(t[n]):B.has(n.toLowerCase())&&Array.isArray(t[n])?e[n]=t[n].map(ie):e[n]=t[n];return e};let p=E=class extends me{constructor(t){super(t),this.functionName=null,this.outputPixelType="unknown",this.variableName=null,this.rasterFunctionDefinition=null}set functionArguments(t){if(t){const e=Object.keys(t);if(e.some(n=>V.has(n.toLowerCase())&&Y(t[n]))||e.some(n=>B.has(n.toLowerCase())&&Array.isArray(t[n])&&t[n].some(a=>Y(a)))){t=P(t);for(const n of e)V.has(n.toLowerCase())?t[n]=se(t[n]):B.has(n.toLowerCase())&&Array.isArray(t[n])&&(t[n]=t[n].map(a=>se(a)))}}this._set("functionArguments",t)}readFunctionArguments(t){return Ge(t)}writeFunctionArguments(t,e,n){const a={};for(const r of Object.keys(t))V.has(r.toLowerCase())?a[r]=R(t[r]):B.has(r.toLowerCase())&&Array.isArray(t[r])?a[r]=t[r].map(R):a[r]=R(t[r]);e[n]=a}readFunctionName(t,e){const n=e.rasterFunctionInfos;return e.name||(n&&n.length&&n[0].name!=="None"?n[0].name:e.rasterFunctionDefinition?e.rasterFunctionDefinition.name:e.rasterFunction)}clone(){return new E({functionName:this.functionName,functionArguments:P(this.functionArguments),outputPixelType:this.outputPixelType,variableName:this.variableName,rasterFunctionDefinition:P(this.rasterFunctionDefinition)})}};b([T({json:{type:Object,name:"rasterFunctionArguments"}})],p.prototype,"functionArguments",null),b([ne("functionArguments")],p.prototype,"readFunctionArguments",null),b([Me("functionArguments")],p.prototype,"writeFunctionArguments",null),b([T({json:{type:String,write:{target:"rasterFunction"}}})],p.prototype,"functionName",void 0),b([ne("functionName",["rasterFunction","rasterFunctionInfos","rasterFunctionDefinition"])],p.prototype,"readFunctionName",null),b([$e({C128:"c128",C64:"c64",F32:"f32",F64:"f64",S16:"s16",S32:"s32",S8:"s8",U1:"u1",U16:"u16",U2:"u2",U32:"u32",U4:"u4",U8:"u8",UNKNOWN:"unknown"},{ignoreUnknown:!1}),T({json:{default:"unknown"}})],p.prototype,"outputPixelType",void 0),b([T({type:String,json:{read:!0,write:!0}})],p.prototype,"variableName",void 0),b([T({type:Object,json:{name:"rasterFunctionDefinition"}})],p.prototype,"rasterFunctionDefinition",void 0),p=E=b([ce("esri.layers.support.RasterFunction")],p);const Jt=p,Ut=fe()({RSP_NearestNeighbor:"nearest",RSP_BilinearInterpolation:"bilinear",RSP_CubicConvolution:"cubic",RSP_Majority:"majority"}),Lt=fe()({esriNoDataMatchAny:"any",esriNoDataMatchAll:"all"});var W;const He={base:Fe,key:"type",typeMap:{extent:z,polygon:_e}};let N=W=class extends me{constructor(t){super(t),this.areaOfInterest=null,this.subsetDefinitions=null}get dimensions(){const{subsetDefinitions:t}=this;if(t==null||t.length===0)return[];const e=new Map;t.forEach(a=>{if(!a.dimensionName)return;let r,i;if(Array.isArray(a.values[0])){const s=a.values;r=s[0][0],i=s[a.values.length-1][1]}else{const s=a.values;r=s[0],i=s[a.values.length-1]}if(e.has(a.dimensionName)){const s=e.get(a.dimensionName);s[0]=Math.min(r,s[0]),s[1]=Math.max(i,s[1])}else e.set(a.dimensionName,[r,i])});const n=[];for(const a of e)n.push({name:a[0],extent:a[1]});return n}get variables(){const{subsetDefinitions:t}=this;if(t==null||t.length===0)return[];const e=new Set;return t.forEach(n=>{n.variableName&&e.add(n.variableName)}),[...e]}clone(){var n;const t=(n=this.subsetDefinitions)==null?void 0:n.map(a=>a.clone()),e=this.areaOfInterest?this.areaOfInterest.clone():this.areaOfInterest;return new W({areaOfInterest:e,subsetDefinitions:t})}};b([T({types:He,json:{read:je,write:!0}})],N.prototype,"areaOfInterest",void 0),b([T({readOnly:!0})],N.prototype,"dimensions",null),b([T({readOnly:!0})],N.prototype,"variables",null),b([T({type:[J],json:{write:!0}})],N.prototype,"subsetDefinitions",void 0),N=W=b([ce("esri.layers.support.MultidimensionalSubset")],N);const Rt=N;class zt{constructor(){this._workerThread=null,this._destroyed=!1}async initialize(){const e=await Je("RasterWorker");this._destroyed?e.close():this._workerThread=e}destroy(){this._destroyed=!0,this._workerThread&&(this._workerThread.close(),this._workerThread=null)}async convertVectorFieldData(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");const a=await this._workerThread.invoke("convertVectorFieldData",{pixelBlock:e.pixelBlock.toJSON(),type:e.dataType},n);return a?new S(a):null}async decode(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");const a=await this._workerThread.invoke("decode",e,n);return a?new S(a):null}async symbolize(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");const a={extent:e.extent&&e.extent.toJSON(),pixelBlock:m(e.pixelBlock)&&e.pixelBlock.toJSON(),simpleStretchParams:e.simpleStretchParams,bandIds:e.bandIds},r=await this._workerThread.invoke("symbolize",a,n);return r?new S(r):null}async updateSymbolizer(e,n){var r;if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");const a=(r=e==null?void 0:e.rendererJSON)==null?void 0:r.histograms;await Promise.all(this._workerThread.broadcast("updateSymbolizer",{symbolizerJSON:e.toJSON(),histograms:a},n))}async updateRasterFunction(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");await Promise.all(this._workerThread.broadcast("updateRasterFunction",{rasterFunctionJSON:e.toJSON()},n))}async process(e,n){var r;if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");const a=await this._workerThread.invoke("process",{extent:(r=e.extent)==null?void 0:r.toJSON(),primaryPixelBlocks:e.primaryPixelBlocks.map(i=>m(i)?i.toJSON():null),primaryRasterIds:e.primaryRasterIds},n);return a?new S(a):null}async stretch(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");if(!(e!=null&&e.pixelBlock))return null;const a={srcPixelBlock:e.pixelBlock.toJSON(),stretchParams:e.stretchParams},r=await this._workerThread.invoke("stretch",a,n);return r?new S(r):null}async split(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");if(!(e!=null&&e.pixelBlock))return null;const a={srcPixelBlock:e.pixelBlock.toJSON(),tileSize:e.tileSize,maximumPyramidLevel:e.maximumPyramidLevel},r=await this._workerThread.invoke("split",a,n);return r&&r.forEach((i,s)=>{r.set(s,i?S.fromJSON(i):null)}),r}async estimateStatisticsHistograms(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");if(!(e!=null&&e.pixelBlock))return null;const a={srcPixelBlock:e.pixelBlock.toJSON()};return await this._workerThread.invoke("estimateStatisticsHistograms",a,n)}async mosaicAndTransform(e,n){var i;if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");if(!((i=e==null?void 0:e.srcPixelBlocks)!=null&&i.length))return{pixelBlock:null};const a={...e,srcPixelBlocks:e.srcPixelBlocks.map(s=>m(s)?s.toJSON():null)},r=await this._workerThread.invoke("mosaicAndTransform",a,n);return{pixelBlock:r.pixelBlock?new S(r.pixelBlock):null,localNorthDirections:r.localNorthDirections}}async createFlowMesh(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");const a={buffer:e.flowData.data.buffer,maskBuffer:e.flowData.mask.buffer,width:e.flowData.width,height:e.flowData.height},{meshType:r,simulationSettings:i}=e,s=await this._workerThread.invoke("createFlowMesh",{meshType:r,flowData:a,simulationSettings:i},{...n,transferList:[a.buffer,a.maskBuffer]});return{vertexData:new Float32Array(s.vertexBuffer),indexData:new Uint32Array(s.indexBuffer)}}getProjectionOffsetGrid(e,n){if(!this._workerThread)throw new g("raster-jobhandler:no-connection","no available worker connection");const a=m(e.datumTransformation)?e.datumTransformation.steps.map(s=>({wkid:s.wkid,wkt:s.wkt,isInverse:s.isInverse})):null,r=m(e.rasterTransform)?e.rasterTransform.toJSON():null,i={projectedExtent:e.projectedExtent.toJSON(),srcBufferExtent:e.srcBufferExtent.toJSON(),pixelSize:e.pixelSize,hasWrapAround:e.hasWrapAround,spacing:e.spacing,datumTransformationSteps:a,rasterTransform:r,isAdaptive:e.isAdaptive,includeGCSGrid:e.includeGCSGrid};return this._workerThread.invoke("getProjectionOffsetGrid",i,n)}}function pe(t,e,n){var i;const a=e.shift();if(n.length===0){const s=[];n.push({sliceId:-1,multidimensionalDefinition:s})}const r=n.length;for(let s=0;s<r;s++){const o=n.shift().multidimensionalDefinition;(i=a.values)==null||i.forEach(c=>{n.push({sliceId:-1,multidimensionalDefinition:[...o,{variableName:t,dimensionName:a.name,values:[c]}]})})}e.length&&pe(t,e,n)}function Et(t,e){const n=[];let a=0;return(e?t.variables.filter(r=>r.name.toLowerCase()===e.toLowerCase()):[...t.variables].sort((r,i)=>r.name>i.name?1:-1)).forEach(r=>{const i=[],s=[...r.dimensions].sort((o,c)=>o.name>c.name?-1:1);pe(r.name,s,i),i.forEach(o=>{n.push({...o,sliceId:a++})})}),n}function Yt(t,e,n){let a=t;if(e&&(e=[...e].sort((r,i)=>r.dimensionName<i.dimensionName?-1:1)).forEach(({dimensionName:r,values:i,isSlice:s})=>{i.length&&(a=a.filter(o=>{const c=o.multidimensionalDefinition.find(u=>u.dimensionName===r);if(c==null)return!1;const l=c.values[0];return typeof l=="number"?typeof i[0]=="number"?i.includes(l):i.some(u=>u[0]<=l&&u[1]>=l):typeof i[0]=="number"?i.some(u=>l[0]<=u&&l[1]>=u):s?i.some(u=>u[0]===l[0]&&u[0]===l[1]):i.some(u=>u[0]>=l[0]&&u[0]<=l[1]||u[1]>=l[0]&&u[1]<=l[1]||u[0]<l[0]&&u[1]>l[1])}))}),a.length&&n&&m(n.start)&&m(n.end)){const r=n.start.getTime(),i=n.end.getTime(),s=a[0].multidimensionalDefinition.findIndex(o=>o.dimensionName==="StdTime");s>-1&&(a=a.filter(o=>{const c=o.multidimensionalDefinition[s].values[0];return r<=c&&i>=c}))}return a.map(r=>r.sliceId)}function be(t,e){return Array.isArray(t)?e[0]===e[1]?t[0]===e[0]||t[1]===e[0]:t[0]>=e[0]&&t[0]<=e[1]&&t[1]>=e[0]&&t[1]<=e[1]:t>=e[0]&&t<=e[1]}function Xe(t,e){return t[0]<=e[0]&&t[1]>=e[0]||t[0]<=e[1]&&t[1]>=e[1]||t[0]>=e[0]&&t[1]<=e[1]}function we(t){return t.length===1?[t[0],t[0]]:[t[0],t[t.length-1]]}function ye(t,e,n){var s,o,c;if(!((s=e==null?void 0:e.subsetDefinitions)!=null&&s.length))return t;let a;if(n){const{variables:l}=e;if(l.length&&!l.includes(n))return null;const u=e.subsetDefinitions.find(f=>f.dimensionName===t.name&&f.variableName===n);if(!((o=u==null?void 0:u.values)!=null&&o.length))return t;a=we(u.values)}else a=(c=e.dimensions.find(({name:l})=>l===t.name))==null?void 0:c.extent;const r=a;if(!r||!(r!=null&&r.length))return t;const i=t.values.filter(l=>be(l,r));return{...t,extent:[...r],values:i}}function ge(t,e,n){var r;if(!((r=e==null?void 0:e.subsetDefinitions)!=null&&r.length))return!1;const{variables:a}=e;if(a.length&&t.some(({variableName:i})=>i&&!a.includes(i)))return!0;for(let i=0;i<t.length;i++){const s=t[i],o=e.subsetDefinitions.find(c=>(s.variableName===""||c.variableName===s.variableName)&&c.dimensionName===s.dimensionName);if(o!=null&&o.values.length){const c=we(o.values);if(!s.isSlice&&s.values.length===2&&!Array.isArray(s.values[0])&&s.values[0]!==s.values[1]&&n){if(!Xe(s.values,c))return!0}else if(s.values.some(l=>!be(l,c)))return!0}}return!1}function Wt(t,e){if(v(t))return{isOutside:!1};const{geometry:n,timeExtent:a,multidimensionalDefinition:r}=e;let i=null;if(m(a)&&(i=Ke(t,a),v(i)))return{isOutside:!0};const{areaOfInterest:s}=t;if(s&&n){const o=n.type==="point"?n:n.type==="extent"?n.center:n.type==="polygon"?n.centroid:null;if(o&&!s.contains(o))return{isOutside:!0}}return m(r)&&r.length&&ge(r,t,!0)?{isOutside:!0}:{isOutside:!1,intersection:{geometry:n,timeExtent:i,multidimensionalDefinition:r}}}function Ke(t,e){const n=t.dimensions.find(({name:s})=>s==="StdTime");if(n==null||v(e.start)&&v(e.end))return e;e=e.clone();const{start:a,end:r}=e.toJSON(),i=a===r?[a]:a!=null&&r!=null?[a,r]:[a??r];return i.length===2&&(n!=null&&n.extent.length)&&(i[0]=Math.max(i[0],n.extent[0]),i[1]=Math.min(i[1],n.extent[1]??n.extent[0]),i[1]<i[0])||ge([new J({variableName:"",dimensionName:"StdTime",isSlice:i.length===1,values:i})],t,!0)?null:(e.start=new Date(i[0]),e.end=new Date(i[1]??i[0]),e)}function Qe(t,e={}){var u,f;const{multidimensionalInfo:n,keyProperties:a}=t;if(v(n))return null;const{variableName:r,multidimensionalSubset:i,multidimensionalDefinition:s}=e,o=m(s)?(u=s[0])==null?void 0:u.variableName:null,c=r||o||(a==null?void 0:a.DefaultVariable);let{variables:l}=n;return(f=i==null?void 0:i.variables)!=null&&f.length&&(l=l.filter(({name:y})=>i.variables.includes(y))),c?l.find(({name:y})=>y===c)??l[0]:l[0]}function qt(t,e={}){const n=Qe(t,e);if(!n)return null;const a=[],{dimensions:r,name:i}=n;if(r.length===0)return[new J({variableName:i,dimensionName:"",values:[],isSlice:!0})];for(let s=0;s<r.length;s++){const o=ye(r[s],e.multidimensionalSubset,i);if(!o)return null;const{values:c,extent:l}=o;let u=(c==null?void 0:c[0])??l[0];o.name.toLowerCase()==="stdz"&&!o.hasRanges&&Math.abs(l[1])<=Math.abs(l[0])&&(u=c!=null&&c.length?c[c.length-1]:l[1]),a.push(new J({variableName:i,dimensionName:o.name,values:[u],isSlice:!e.useRangeForRangedDimensionInfo||!!o.hasRanges}))}return a}function Gt(t){return!(v(t)||!t.length)&&t.some(e=>{if(e.values==null)return!0;const n=e.values.length;return n===0||n>1||!e.isSlice&&Array.isArray(e.values[0])})}function Ht(t,e){var a;if(v(e)||v(t))return null;let n=e.variables.map(r=>({...r}));return(a=t==null?void 0:t.variables)!=null&&a.length&&(n=n.filter(({name:r})=>t.variables.includes(r)),n.forEach(r=>{r.dimensions=r.dimensions.map(i=>ye(i,t,r.name)).filter(m)})),n}function Ze(t,e){var o;const{values:n}=e;if(n!=null&&n.length)return Array.isArray(n[0])!==Array.isArray(t)?-1:Array.isArray(n[0])?n.findIndex(c=>c[0]===t[0]&&c[1]===t[1]):n.indexOf(t);const{extent:a}=e;if(Array.isArray(t)||t<a[0]||t>a[1])return-1;const r=e.interval||1;if(e.unit!=="ISO8601")return Math.round((t-a[0])/r);const i=a[0];let s=-1;switch(((o=e.intervalUnit)==null?void 0:o.toLowerCase())||"seconds"){case"seconds":s=Math.round((t-i)/1e3/r);break;case"minutes":s=Math.round((t-i)/6e4/r);break;case"hours":s=Math.round((t-i)/36e5/r);break;case"days":s=Math.round((t-i)/864e5/r);break;case"months":{const c=new Date(t).getUTCFullYear()-new Date(i).getUTCFullYear(),l=new Date(i).getUTCMonth(),u=new Date(t).getUTCMonth();s=c===0?u-l:u+11-l+12*(c-1)}break;case"years":s=Math.round((new Date(t).getUTCFullYear()-new Date(i).getUTCFullYear())/r);break;case"decades":s=Math.round((new Date(t).getUTCFullYear()-new Date(i).getUTCFullYear())/10/r)}return s}function oe(t){var s,o;let e=(s=t.values)==null?void 0:s.length;if(e)return e;const{extent:n,unit:a}=t,r=t.interval||1,i=n?n[1]-n[0]:0;if(a!=="ISO8601")return Math.round(i/r);switch(((o=t.intervalUnit)==null?void 0:o.toLowerCase())??"seconds"){case"seconds":e=Math.round(i/1e3/r);break;case"minutes":e=Math.round(i/6e4/r);break;case"hours":e=Math.round(i/36e5/r);break;case"days":e=Math.round(i/864e5/r);break;case"months":{const c=new Date(n[1]).getUTCFullYear()-new Date(n[0]).getUTCFullYear(),l=new Date(n[1][0]).getUTCMonth(),u=new Date(n[1][1]).getUTCMonth();e=c===0?u-l+1:u+11-l+12*(c-1)+1}break;case"years":e=Math.round((new Date(n[1]).getUTCFullYear()-new Date(n[0]).getUTCFullYear())/r);break;case"decades":e=Math.round((new Date(n[1]).getUTCFullYear()-new Date(n[0]).getUTCFullYear())/10/r);break;default:e=0}return e}function Xt(t,e){let n=0;const a=t[0].variableName,r=[...e.variables].sort((i,s)=>i.name>s.name?1:-1);for(let i=0;i<r.length;i++){const s=r[i],o=[...s.dimensions].sort((u,f)=>u.name>f.name?-1:1);if(s.name!==a){n+=o.map(u=>oe(u)).reduce((u,f)=>u*f);continue}const c=o.map(u=>oe(u)),l=o.length;for(let u=0;u<l;u++){const f=t.find(k=>k.dimensionName===o[u].name);if(f==null)return null;const y=Ze(f.values[0],o[u]);if(y===-1)return null;c.shift(),n+=u===l-1?y:y*c.reduce((k,d)=>k*d)}break}return n}const et=.25,tt=he.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),le=he.fromJSON(Ue[0]),ve=new Set(["scientific","standard-time","vector-uv","vector-magdir","vector-u","vector-v","vector-magnitude","vector-direction"]);function Kt(t,e){const{attributeTable:n,colormap:a}=t;if(q(t)){const r=pt(t);if(m(r))return r}if(m(a)){const r=ut(t);if(m(r))return r}if(m(n)){const r=ot(t);if(m(r))return r}return nt(t,e)}function Qt(t,e=!1){const n=["raster-stretch"];return Te(t)&&n.push("raster-colormap"),xe(t)&&n.push("unique-value"),mt(t,e)&&n.push("class-breaks"),ct(t)&&n.push("raster-shaded-relief"),q(t)&&n.push("vector-field"),dt(t)&&n.push("flow"),n}function Zt(t,e,n){const a=["nearest","bilinear","cubic","majority"].find(r=>r===(n==null?void 0:n.toLowerCase()));return e==="Map"?a??"bilinear":t.dataType==="standard-time"?a??"nearest":t.dataType==="thematic"||t.attributeTable||t.colormap?a==="nearest"||a==="majority"?a:"nearest":a??"bilinear"}function nt(t,e){t=at(t,e==null?void 0:e.variableName);const{bandCount:n}=t;let{bandIds:a,stretchType:r}=e||{};a!=null&&a.some(f=>f>=n)&&(a=null);let i=A(t.statistics),s=A(t.histograms);n>1?(a=a!=null&&a.length?a:rt(t),i=i==null?null:a==null?void 0:a.map(f=>i[f]),s=s==null?null:a==null?void 0:a.map(f=>s[f])):a=[0],r==null&&(r=st(t));let o=!1;switch(r){case"none":o=!1;break;case"percent-clip":o=!(s!=null&&s.length);break;default:o=!(i!=null&&i.length)}const{dataType:c}=t,l=(a==null?void 0:a.length)===1&&ve.has(c)?tt:null,u=new Pe({stretchType:r,dynamicRangeAdjustment:o,colorRamp:l,outputMin:0,outputMax:255,gamma:(a==null?void 0:a.length)===1?[1]:[1,1,1],useGamma:!1});return r==="percent-clip"?u.maxPercent=u.minPercent=et:r==="standard-deviation"&&(u.numberOfStandardDeviations=2),o||!m(t.multidimensionalInfo)&&!(e!=null&&e.includeStatisticsInStretch)||(r==="percent-clip"?u.histograms=s:r!=="min-max"&&r!=="standard-deviation"||(u.statistics=i)),u}function at(t,e){if(!e)return t;let n=A(t.statistics),a=A(t.histograms);const{multidimensionalInfo:r}=t;if(e&&m(r)){const i=r.variables.find(s=>s.name===e);if(i){const{statistics:s,histograms:o}=i;s!=null&&s.length&&(n=s),o!=null&&o.length&&(a=o)}}return de.fromJSON({...t.toJSON(),statistics:n,histograms:a})}function rt(t){const e=t.bandCount;if(e===1)return null;if(e===2)return[0];const n=t.keyProperties&&t.keyProperties.BandProperties;let a;if(n&&n.length===e){const{red:r,green:i,blue:s,nir:o}=it(n);r!=null&&i!=null&&s!=null?a=[r,i,s]:o!=null&&r!=null&&i!=null&&(a=[o,r,i])}return!a&&e>=3&&(a=[0,1,2]),a}function it(t){var n;const e={};for(let a=0;a<t.length;a++){const r=t[a],i=(n=r.BandName)==null?void 0:n.toLowerCase();if(i==="red")e.red=a;else if(i==="green")e.green=a;else if(i==="blue")e.blue=a;else if(i==="nearinfrared"||i==="nearinfrared_1"||i==="nir")e.nir=a;else if(r.WavelengthMax&&r.WavelengthMin){const s=r.WavelengthMin,o=r.WavelengthMax;e.blue==null&&s>=410&&s<=480&&o>=480&&o<=540?e.blue=a:e.green==null&&s>=490&&s<=560&&o>=560&&o<=610?e.green=a:e.red==null&&s>=595&&s<=670&&o>=660&&o<=730?e.red=a:e.nir==null&&s>=700&&s<=860&&o>=800&&o<=950&&(e.nir=a)}}return e}function st(t){let e="percent-clip";const{pixelType:n,dataType:a,histograms:r,statistics:i,multidimensionalInfo:s}=t,o=ve.has(a)||a==="generic"&&m(s);return n!=="u8"||a!=="processed"&&m(r)&&m(i)?n==="u8"||a==="elevation"||o?e="min-max":m(r)?e="percent-clip":m(i)&&(e="min-max"):e="none",e}function ot(t,e,n,a){if(!xe(t,e))return null;const{attributeTable:r,statistics:i}=t,s=ke(r,e),o=F(r,"red"),c=F(r,"green"),l=F(r,"blue"),u=new Re,f=[],y=new Set,k=!!(o&&c&&l);if(m(r))r.features.forEach(d=>{const h=d.attributes[s.name];if(!y.has(d.attributes[s.name])&&h!=null){y.add(h);const x=k&&(o.type==="single"||o.type==="double")&&(c.type==="single"||c.type==="double")&&(l.type==="single"||l.type==="double")&&!r.features.some(O=>O.attributes[o.name]>1||O.attributes[c.name]>1||O.attributes[l.name]>1),D=x?255:1;f.push(new re({value:d.attributes[s.name],label:d.attributes[s.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new j(k?[d.attributes[o.name]*D,d.attributes[c.name]*D,d.attributes[l.name]*D,1]:[0,0,0,0])}}))}});else if(i!=null&&i[0])for(let d=i[0].min;d<=i[0].max;d++)f.push(new re({value:d,label:d.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new j([0,0,0,0])}}));if(f.sort((d,h)=>d.value&&typeof d.value.valueOf()=="string"?0:d.value>h.value?1:-1),!k){const d=ae(le,{numColors:f.length});f.forEach((h,x)=>h.symbol.color=new j(d[x].slice(1,4))),u.colorRamp=le}if(n||a){const d=n||ae(a,{numColors:f.length}).map(h=>h.slice(1));f.forEach((h,x)=>h.symbol.color=new j(d[x])),u.colorRamp=a}return new ze({field:s.name,uniqueValueInfos:f,authoringInfo:u})}function ke(t,e,n){let a;return m(t)?(a=e?t.fields.find(r=>e.toLowerCase()===r.name.toLowerCase()):lt(t.fields),a||(n||(a=t.fields.find(r=>r.type==="string")),a||(a=F(t,"value")))):a=new Le({name:"value"}),a}function lt(t){let e;for(let n=0;n<t.length;n++){const a=t[n].name.toLowerCase();if(t[n].type==="string"){if(a.startsWith("class")){e=t[n];break}e==null&&(a.endsWith("name")||a.endsWith("type"))&&(e=t[n])}}return e}function F(t,e){return v(t)?null:t.fields.find(n=>n.name.toLowerCase()===e)}function xe(t,e){const{attributeTable:n,bandCount:a}=t;return v(n)&&ft(t)?!0:!(v(n)||a>1||e&&n.fields.find(r=>r.name.toLowerCase()===e.toLowerCase())==null)}function Te(t){const{bandCount:e,colormap:n}=t;return m(n)&&n.length>0&&e===1}function ut(t){if(!Te(t))return null;let e;const{attributeTable:n,colormap:a}=t;if(m(n)){const r=F(n,"value"),i=ke(n,null,!0);i.type==="string"&&(e={},n.features.forEach(s=>{const o=s.attributes;e[o[r.name]]=i?o[i.name]:o[r.name]}))}return Ve.createFromColormap(A(a),e)}function ct(t){const{bandCount:e,dataType:n,pixelType:a}=t;return n==="elevation"||n==="generic"&&e===1&&(a==="s16"||a==="s32"||a==="f32"||a==="f64")}function mt(t,e=!1){const{attributeTable:n,bandCount:a}=t;return a===1&&(!e||m(n)||m(t.histograms))}function ft(t){var e,n,a;return["u8","s8"].includes(t.pixelType)&&((n=(e=t.statistics)==null?void 0:e[0])==null?void 0:n.min)!=null&&((a=t.statistics[0])==null?void 0:a.max)!=null&&t.bandCount===1}function q(t){const{dataType:e}=t;return e==="vector-uv"||e==="vector-magdir"}function dt(t){const{dataType:e}=t;return e==="vector-uv"||e==="vector-magdir"}const ht=new Map([["m/s","meter-per-second"],["km/h","kilometer-per-hour"],["knots","knots"],["ft/s","feet-per-second"],["mph","mile-per-hour"]]);function pt(t){if(!q(t))return null;let e;if(m(t.statistics)&&t.statistics.length&&(t.dataType==="vector-magdir"||t.dataType==="vector-uv")){const{minMagnitude:r,maxMagnitude:i}=bt(t.dataType,t.statistics);e=[{type:"size",field:"Magnitude",minSize:10,maxSize:40,minDataValue:r,maxDataValue:i}]}const n=m(t.multidimensionalInfo)?ht.get(t.multidimensionalInfo.variables[0].unit):null,a=new Be({visualVariables:e,inputUnit:n,rotationType:"geographic"});return a.visualVariables=[...a.sizeVariables,...a.rotationVariables],a}function ue(t){var e;return{color:(e=t.symbolLayers[0].material)==null?void 0:e.color,type:"esriSFS",style:"esriSFSSolid"}}function en(t){var e,n,a;if(t.type==="uniqueValue"){const r=t.uniqueValueInfos,i=r==null?void 0:r[0].symbol;return(e=i==null?void 0:i.symbolLayers)!=null&&e.length&&(t.uniqueValueInfos=r==null?void 0:r.map(s=>({value:s.value,label:s.label,symbol:s.symbol?ue(s.symbol):null}))),t}if(t.type==="classBreaks"){const r=t.classBreakInfos;return(a=(n=r[0].symbol)==null?void 0:n.symbolLayers)!=null&&a.length&&(t.classBreakInfos=r.map(i=>({classMinValue:i.classMinValue,classMaxValue:i.classMaxValue,label:i.label,symbol:i.symbol?ue(i.symbol):null}))),t}return t}function bt(t,e){let n,a;if(t==="vector-magdir")n=e[0].min,a=e[0].max;else{const r=e[0].min,i=e[0].max,s=e[1].min,o=e[1].max;n=0,a=Math.max(Math.abs(r),Math.abs(s),Math.abs(i),Math.abs(o))}return{minMagnitude:n,maxMagnitude:a}}async function Se(t,e,n){var H,X,K,Q,Z,ee;const a=Ee(t),{renderingRule:r,sourceJSON:i}=e||{},s=r?JSON.stringify(r.rasterFunctionDefinition||r):null,o=Ye({...a.query,renderingRule:s,f:"json"}),c=We(o,n);t=a.path;const l=i||await C(t,c).then(w=>w.data),u=l.hasRasterAttributeTable?C(`${t}/rasterAttributeTable`,c):null,f=l.hasColormap?C(`${t}/colormap`,c):null,y=l.hasHistograms?C(`${t}/histograms`,c):null,k=l.currentVersion>=10.3?C(`${t}/keyProperties`,c):null,d=l.hasMultidimensions?C(`${t}/multidimensionalInfo`,c):null,h=await Promise.allSettled([u,f,y,k,d]);let x=null;if(l.minValues&&l.minValues.length===l.bandCount){x=[];for(let w=0;w<l.minValues.length;w++)x.push({min:l.minValues[w],max:l.maxValues[w],avg:l.meanValues[w],stddev:l.stdvValues[w]})}const D=z.fromJSON(l.extent),O=Math.ceil(D.width/l.pixelSizeX-.1),Ne=Math.ceil(D.height/l.pixelSizeY-.1),G=Ae.fromJSON(l.spatialReference||l.extent.spatialReference),De=h[0].status==="fulfilled"&&h[0].value?qe.fromJSON(h[0].value.data):null,Ce=h[1].status==="fulfilled"?(H=h[1].value)==null?void 0:H.data.colormap:null,Oe=h[2].status==="fulfilled"?(X=h[2].value)==null?void 0:X.data.histograms:null,$=h[3].status==="fulfilled"?((K=h[3].value)==null?void 0:K.data)??{}:{},M=h[4].status==="fulfilled"?(Q=h[4].value)==null?void 0:Q.data.multidimensionalInfo:null;(Z=M==null?void 0:M.variables)!=null&&Z.length&&M.variables.forEach(w=>{var te;(te=w.statistics)!=null&&te.length&&w.statistics.forEach(_=>{_.avg=_.mean,_.stddev=_.standardDeviation})});const{defaultVariable:U,serviceDataType:I}=l;U&&U!==$.DefaultVariable&&($.DefaultVariable=U),I&&I.includes("esriImageServiceDataTypeVector")&&!I.includes($.DataType)&&($.DataType=I.replace("esriImageServiceDataType",""));let L=l.noDataValue;return(ee=l.noDataValues)!=null&&ee.length&&l.noDataValues.some(w=>w!==L)&&(L=l.noDataValues),new de({width:O,height:Ne,bandCount:l.bandCount,extent:z.fromJSON(l.extent),spatialReference:G,pixelSize:new Ie({x:l.pixelSizeX,y:l.pixelSizeY,spatialReference:G}),pixelType:l.pixelType.toLowerCase(),statistics:x,attributeTable:De,colormap:Ce,histograms:Oe,keyProperties:$,noDataValue:L,multidimensionalInfo:M})}function tn(t,e,n){return Se(t,{sourceJSON:e},n)}function nn(t,e,n){return Se(t,{renderingRule:e},n)}export{en as $,rt as L,at as S,Zt as V,Wt as a,Et as b,Rt as c,ge as d,Qe as e,nn as f,Gt as g,qt as h,Lt as i,Kt as j,Qt as k,tn as m,zt as n,Ut as o,Yt as s,Ht as v,Jt as w,Xt as y};

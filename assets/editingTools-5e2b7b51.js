import{e as h,y as d,a as C,v as hi,n as Vt,z as Z,_ as Gt,a0 as ua,t as Wt,A as Na}from"./cast-8b575ab3.js";import{r as c,t as _,o as ti,B as Ua,a as P,e as D,p as Ot,v as Xa,l as it,n as Za}from"./typedArrayUtil-ce39e5f4.js";import{l as G,a as ka,h as St,f as Bt,w as ci,U as xe}from"./reactiveUtils-042dd05a.js";import"./ArrayPool-5813d861.js";import{G as Ya,n as V,o as nt,u as Pe,g as Le,r as k,U as Fa,e as ot,z as ei,P as ii,_ as jt,H as ma,v as Ba,s as we,A as ja,t as ga,p as qa,a as Be,q as ge}from"./vec3-015ca254.js";import{i as _a,s as Wa,u as Ei,f as z,d as Ja,g as Ka}from"./elevationInfoUtils-ab005f9a.js";import{x as va}from"./ElevationInfo-ad190ee6.js";import{i as Ve,x as Oi,d as Qa}from"./screenUtils-410d12c0.js";import"./Error-685fdf30.js";import{h as tn}from"./string-7a324480.js";import{j as en}from"./asyncUtils-623987a8.js";import{f as an}from"./promiseUtils-e37fe75d.js";import{i as nn,x as on,d as Ee,b as oe,a as se,e as je}from"./quantityFormatUtils-48a180ea.js";import{b as sn,r as Tt,v as ai,l as rn,A as ln,s as pn,o as hn}from"./vec2-8acac370.js";import{n as ae}from"./vec2f64-f35767d6.js";import{h as cn,z as dn,m as un}from"./Polyline-889037e7.js";import{u as mn}from"./messages-8a541332.js";import{x as gn}from"./TextOverlayItem-85184606.js";import{d as _n,a as xt,b as he,t as ze,m as vn,l as fn}from"./automaticLengthMeasurementUtils-51b1035b.js";import{bl as yn,au as Ai,b6 as Mn,aQ as Ti,ci as bn,X as Sn,aS as Di,cj as xn,a7 as Ce,a9 as di,ck as Oe,cl as fa,aZ as E,bb as ui,cm as wn,cn as En,bG as On,cg as Rt,co as An,cp as ya,bd as _e,bA as Gi,aX as yt,cf as Ma,cq as Tn,cr as Dn,bH as Gn,bC as ve,bD as Qt,ba as Rn}from"./index-334863ed.js";import{x as re,_ as Ri,y as g,v as mi,r as gi}from"./VerticesVisualElement-e62cefd1.js";import{n as dt}from"./Evented-d959ede6.js";import{D as qe,a as $i,r as $n}from"./vec4-c7a19f0d.js";import{x as In,j as Ii,g as Pn}from"./projection-582e07d8.js";import{a as ba,S as Sa,M as Pi,R as Ln}from"./aaBoundingBox-04c58f5a.js";import{M as ce}from"./dehydratedFeatures-55779981.js";import{t as Vn}from"./RightAngleQuadVisualElement-019b40c1.js";import{d as Ae,S as zn}from"./PointVisualElement-25a13433.js";import{n as Cn}from"./MeshComponent-f5ec9479.js";import{g as st}from"./VisualVariablePassParameters-8cb0a75a.js";import{O as Hn}from"./VertexAttribute-15d1866a.js";import{H as Nn,k as Un,B as Xn,c as Zn,o as kn,M as Li,A as Yn,G as Fn,S as fe,Y as Vi}from"./editPlaneUtils-0b1c2ba0.js";import{j as Bn}from"./Collection-47946fa8.js";import{a as xa,d as _i}from"./HandleOwner-f773ce72.js";import{i as K,e as w,R as bt,z as ni,L as te,G as wa,C as Ea,U as jn}from"./manipulatorUtils-ea52a52a.js";import{t as zt}from"./manipulatorUtils-d8bfd4d6.js";import{m as He,a as oi,b as le}from"./mathUtils-5b623c84.js";import{w as Oa}from"./aaBoundingRect-41e05474.js";import{l as Aa}from"./Color-ad49dc79.js";import{q as zi,R as qn,c as Se,p as Ta,g as Te,i as Wn,l as Jn,f as Da,b as Ci,x as Kn}from"./mat4-4714ff8c.js";import{e as Ne,t as Qn,o as to}from"./mat4f64-abdda1bb.js";import{c as $,e as q,p as Hi,b as Ni,t as eo,d as io}from"./sphere-8ab93b42.js";import{N as vi,G as Ga,h as ao,T as no,F as oo,P as so,C as si,o as ro}from"./Factory-0c42e0ab.js";import{x as lo,v as po,y as rt,P as ne,d as ho,D as Jt,C as Ra,q as Yt,p as Ue,z as co,M as uo,G as Ui}from"./InteractiveToolBase-711b78f1.js";import{n as fi}from"./basicInterfaces-7449a8bf.js";import{q as mo}from"./colorUtils-7641d345.js";import{j as go}from"./GraphicManipulator-a86ee6cf.js";import{V as Xe,A as Xi,P as _o,E as Mt,e as Zi}from"./EditGeometryOperations-73b6c5df.js";import{e as De}from"./SnappingContext-7b0a2e3a.js";import{m as Ge}from"./SnappingOperation-4f67e764.js";import{r as pe,p as Ze,a as yi,l as vo,c as fo,n as yo}from"./TranslateTooltipInfos-31727546.js";import{v as Re,x as Mo,D as bo}from"./euclideanLengthMeasurementUtils-29bab6b0.js";import"./geometry-bad16232.js";import{$ as ri,f as So,w as xo,aa as wo}from"./Extent-680ef92a.js";import{Y as de,_ as $a,p as Mi,J as Eo,x as ki}from"./plane-e5e66c24.js";import{w as Yi}from"./DimensionalDefinition-4b26df38.js";import{i as Oo}from"./automaticAreaMeasurementUtils-7a1fb373.js";import{l as li}from"./ViewingMode-5d7d590b.js";import{r as Ao}from"./Cyclical-34b2a5e3.js";import{e as To}from"./vec4f64-6d0e93be.js";import{g as Do,l as Go}from"./projection-c67d3c7f.js";import{r as Ia,s as Ro,N as $o,j as Io,u as Po,_ as Lo,k as Vo,o as Fi,q as zo,I as Co,B as Ho,K as No,J as Uo}from"./sliceToolUtils-bd6589df.js";import{i as Xo,p as Zo}from"./ExtentTooltipInfos-53945f70.js";import"./nextTick-3ee5a785.js";import"./common-d0b63c2d.js";import"./fieldUtils-1ecec444.js";import"./preload-helper-41c905a7.js";import"./arcadeOnDemand-a1bf65ec.js";import"./lengthUtils-1d09729e.js";import"./Ellipsoid-89682c5e.js";import"./Portal-7ecdc9f0.js";import"./request-fc61835a.js";import"./Loadable-695031ac.js";import"./Promise-e757e514.js";import"./locale-30120714.js";import"./PortalGroup-ea788274.js";import"./PortalUser-a1aa49cd.js";import"./IdentityManager-13ed5348.js";import"./intl-b84fb3c9.js";import"./number-134e9f14.js";import"./assets-5052bbaa.js";import"./uuid-73213768.js";import"./dom-2ec1e33c.js";import"./geometryEngine-68f880a9.js";import"./geometryEngineBase-e1a33b0a.js";import"./hydrated-61d2b3c5.js";import"./Graphic-96c42a4d.js";import"./PopupTemplate-8ac0cb61.js";import"./Clonable-2b8b60cc.js";import"./enumeration-4ec8d3f9.js";import"./Identifiable-96150ecf.js";import"./symbols-0f3de684.js";import"./CIMSymbol-cdddfd9c.js";import"./opacityUtils-6b5cbdc2.js";import"./symbolLayerUtils3D-51cc6d75.js";import"./persistableUrlUtils-1c5d7615.js";import"./Symbol3DAnchorPosition2D-142c1e90.js";import"./collectionUtils-25147e5f.js";import"./jsonUtils-03437bcd.js";import"./Basemap-f5ca570d.js";import"./deprecate-9828d7d2.js";import"./loadAll-8401c5ec.js";import"./PortalItem-6549afda.js";import"./writeUtils-ff257e5e.js";import"./layerUtils-0c01cb0c.js";import"./compilerUtils-175b9e40.js";import"./CollectionFlattener-9bc75576.js";import"./TablesMixin-b6031ef9.js";import"./Layer-b29c44e3.js";import"./MultiOriginJSONSupport-a1d33be9.js";import"./originUtils-1469eeaf.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./HeightModelInfo-42ae0f61.js";import"./arcgisLayerUrl-81a33ec5.js";import"./saveUtils-bf4b189a.js";import"./resourceUtils-e6e10558.js";import"./fieldType-232282e5.js";import"./OperationalLayer-c3a14c54.js";import"./TimeExtent-d116f9c4.js";import"./mat3-4fd89d48.js";import"./mat3f64-50f3b9f6.js";import"./Octree-d990d188.js";import"./Util-c12e93ba.js";import"./scaleUtils-87bb90d3.js";import"./lineSegment-b352e49e.js";import"./objectResourceUtils-8909e8c3.js";import"./devEnvironmentUtils-5002a058.js";import"./BufferView-da65c548.js";import"./vec33-8529ce65.js";import"./DefaultMaterial_COLOR_GAMMA-87d1f8e6.js";import"./types-e1c0a5bf.js";import"./enums-fc527c7c.js";import"./Version-419f71e1.js";import"./quat-99c4e099.js";import"./quatf64-f8f1c132.js";import"./resourceUtils-527631ac.js";import"./Indices-37e06e9a.js";import"./DefaultMaterial.glsl-7d7dc23e.js";import"./ForwardLinearDepth.glsl-a0929473.js";import"./Matrix3PassUniform-0b3b1bba.js";import"./ShaderBuilder-7bfc11d2.js";import"./vec3f32-01c06d8d.js";import"./View.glsl-03db830e.js";import"./mat4f32-60a2394b.js";import"./Texture2DPassUniform-70e1e126.js";import"./MixExternalColor.glsl-99b269fe.js";import"./ShaderTechniqueConfiguration-ee770726.js";import"./symbolColorUtils-834d5fca.js";import"./PhysicallyBasedRendering.glsl-32dfb9c7.js";import"./FloatPassUniform-e3702139.js";import"./Float4PassUniform-7f3c3ce8.js";import"./RgbaFloatEncoding.glsl-4a25e2a7.js";import"./Texture2DDrawUniform-02720a73.js";import"./PiUtils.glsl-5ee49495.js";import"./Slice.glsl-7975394d.js";import"./Transform.glsl-7294c426.js";import"./ObjectAndLayerIdColor.glsl-a64028da.js";import"./OutputDepth.glsl-f581dcdd.js";import"./OutputHighlight.glsl-08aacdf4.js";import"./VisualVariables.glsl-9e988d16.js";import"./DiscardOrAdjustAlphaBlend.glsl-f19054e7.js";import"./AlphaCutoff-96178e0d.js";import"./TransparencyPassType-a6b20292.js";import"./VertexColor.glsl-79a8c465.js";import"./VerticalOffset.glsl-5354e013.js";import"./Normals.glsl-0f400ece.js";import"./EvaluateSceneLighting.glsl-5da94bb7.js";import"./Texture-bf6b5582.js";import"./context-util-7ede29e5.js";import"./SSAOBlur.glsl-7265df26.js";import"./ScreenSpacePass.glsl-fee70090.js";import"./ReadLinearDepth.glsl-53a01bc1.js";import"./SSAO.glsl-c9cc39dd.js";import"./MultipassTerrainTest.glsl-43f42334.js";import"./vec2f32-eaf29605.js";import"./byteSizeEstimations-f0cab514.js";import"./Texture-87febf19.js";import"./TextureOnly.glsl-548e665f.js";import"./Attribute-f72d3f37.js";import"./InterleavedLayout-d75b8228.js";import"./DefaultTechniqueConfiguration-5fedee5c.js";import"./RealisticTree.glsl-1e8f0ea9.js";import"./Scheduler-3113abcd.js";import"./SimpleObservable-6f002ab0.js";import"./GraphicsLayer-70f87af0.js";import"./BlendLayer-291a2b49.js";import"./colorUtils-639f4d25.js";import"./ScaleRangeLayer-7ff6c0d3.js";import"./workers-c3882da6.js";import"./Connection-6bd43370.js";import"./spatialReferenceEllipsoidUtils-23733e37.js";import"./AttachmentInfo-6f2ba68c.js";import"./AttachmentQuery-061e93ef.js";import"./LegendOptions-de492976.js";import"./jsonUtils-b2e5d321.js";import"./UniqueValueRenderer-3904f4cc.js";import"./diffUtils-0c65d604.js";import"./colorRamps-ddfecb23.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-a1979e31.js";import"./typeUtils-700e0da4.js";import"./jsonUtils-e877a23b.js";import"./styleUtils-305d8f69.js";import"./DictionaryLoader-1438695d.js";import"./LRUCache-16cff7d8.js";import"./MemCache-1d0e264b.js";import"./heatmapUtils-bc76f08e.js";import"./Query-65d38c02.js";import"./Field-1bc3a16a.js";import"./executeQueryJSON-04f85be1.js";import"./normalizeUtils-6bee55d6.js";import"./normalizeUtilsCommon-17a95432.js";import"./query-b200d7cb.js";import"./pbfQueryUtils-f001828a.js";import"./pbf-68e00ce0.js";import"./OptimizedFeature-7f37a325.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./queryZScale-bd6bba60.js";import"./zscale-def794ea.js";import"./FeatureSet-cb704b51.js";import"./featureConversionUtils-c227ec85.js";import"./RelationshipQuery-0abdb3e2.js";import"./TopFeaturesQuery-3a519c5e.js";import"./FeatureLayer-f2f6536e.js";import"./serviceCapabilitiesUtils-6f645c61.js";import"./FeatureLayerBase-b19f7ee7.js";import"./TimeReference-aeda2bb8.js";import"./datetime-b6333958.js";import"./editsZScale-eefb35e6.js";import"./APIKeyMixin-d7cb7220.js";import"./ArcGISService-7ce81abb.js";import"./CustomParametersMixin-0dbce8f2.js";import"./EditBusLayer-faff46ba.js";import"./FeatureReductionLayer-55e6b2c4.js";import"./labelingInfo-8462538e.js";import"./labelUtils-61dff46d.js";import"./defaultsJSON-59981e75.js";import"./OrderedLayer-f840e564.js";import"./PortalLayer-7f6f61d4.js";import"./portalItemUtils-ba37e370.js";import"./RefreshableLayer-51d28698.js";import"./TemporalLayer-12ea8921.js";import"./FeatureTemplate-26b6ba5d.js";import"./FeatureType-474514d1.js";import"./fieldProperties-66b12497.js";import"./FieldsIndex-967913ce.js";import"./versionUtils-f77d2452.js";import"./styleUtils-4d62e921.js";import"./popupUtils-7d1e2de5.js";import"./callExpressionWithFeature-6f3761f2.js";import"./quantizationUtils-dc028b68.js";import"./webStyleSymbolUtils-0f876db3.js";import"./ElevationSamplerData-b8eeacdf.js";import"./TileInfo-f339e6a5.js";import"./WaterSurface.glsl-55a88d78.js";import"./NormalUtils.glsl-f259fe4a.js";import"./HUD.glsl-79bd614f.js";import"./edgeProcessing-fa6d4038.js";import"./deduplicate-dffc7dea.js";import"./VertexElementDescriptor-2925c6af.js";import"./HUDMaterial.glsl-caa3e151.js";import"./sdfPrimitives-86e63320.js";import"./floatRGBA-11065dbc.js";import"./labelFormatUtils-695eab3b.js";import"./orientedBoundingBox-8bbf4141.js";import"./quatf32-51a323b8.js";import"./LineCallout.glsl-ede36b7c.js";import"./earcut-61f7b102.js";import"./QueryEngineResult-c580d29f.js";import"./ItemCache-c0904c4f.js";import"./WhereClause-cbd158ef.js";import"./executionError-fb3f283a.js";import"./utils-f1e38d04.js";import"./generateRendererUtils-65ba2788.js";import"./json-48e3ea08.js";import"./MarkerSizing.glsl-0f21463c.js";import"./RibbonLine.glsl-376e988d.js";import"./LineStipple.glsl-dfd34f08.js";import"./LineMarker.glsl-b68d2081.js";import"./NativeLine.glsl-38506d53.js";import"./Path.glsl-5da6ce18.js";import"./ColorMaterial.glsl-d42d7e44.js";import"./Pattern.glsl-cc643bcf.js";import"./LercDecoder-e072a355.js";import"./enums-fb086c25.js";import"./config-f7904f35.js";import"./TileKey-ae8a9188.js";import"./workerHelper-7b69330e.js";import"./capabilities-8176ed28.js";import"./floating-ui-8c8de742.js";import"./StreamLayer-b816a6d3.js";import"./SceneFilter-8312e3bf.js";import"./persistable-63f0629a.js";import"./resourceExtension-a93bca74.js";import"./DimensionAnalysis-0ac2f8cd.js";import"./Analysis-cc5bd6fb.js";import"./ExportImageParameters-c93de02f.js";import"./sublayerUtils-7a7b4353.js";import"./vectorFieldUtils-3e325848.js";import"./cimSymbolUtils-bff8b59b.js";import"./utils-3d986af0.js";import"./LineVisualElement-b2465764.js";import"./VisualElementResources-04ba0905.js";import"./dehydratedFeatureComparison-d263905a.js";import"./ImageMaterial-29c669c5.js";import"./ImageMaterial.glsl-cead626d.js";import"./ShadedColorMaterial.glsl-a97ba27a.js";import"./drawUtils-5bdcf78c.js";import"./drapedUtils-4f3ec69d.js";import"./PointSnappingHint-d61d3bbf.js";import"./measurementUtils-7ae47288.js";import"./euclideanAreaMeasurementUtils-f8aad2db.js";const ko=3025,Yo={default:15,far:25};let ht=class extends hi{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=en(async n=>{const a=await mn("esri/core/t9n/Units");an(n),this._messagesUnits=a}),i=()=>ti(this.context,n=>n.editGeometryOperations);this.addHandles([G(()=>[c(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(n=>ka(i,n,()=>this._update())),Vt(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return _(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return Yo[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(_(t))return void this._destroyUnusedLabels();const{components:i,geometry:n,coordinateHelper:a}=t.editGeometryOperations.data;if(!n)return void this._destroyUnusedLabels();const o=i.length;for(let s=0;s<o;++s){const r=[];if(i[s].iterateVertices(M=>{r.push(a.toXYZ(M.pos))}),s===0&&c(this.stagedVertex)&&r.push(a.toXYZ(this.stagedVertex)),r.length<2)continue;const l=r[0],p=r[r.length-1];n.type==="polygon"&&r.length>2&&!Ya(l,p)&&r.push(l);const u=o===1&&!cn(r,!1,!1);let m=Fo,v=Bo;this.toScreenPointArray(t,l,m);for(let M=1;M<r.length;++M){const y=r[M-1],f=r[M];this.toScreenPointArray(t,f,v),this._addLabel(t,y,m,f,v,u),[m,v]=[v,m]}}this._destroyUnusedLabels()}_addLabel(t,i,n,a,o,s){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||sn(n,o)<ko)return void(r.visible=!1);const l=c(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":_a(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:p}=t.editGeometryOperations.data,u=_n(i,a,p,l),m=this._messagesUnits,v=nn(t.view);r.text=c(m)&&c(u)?on(m,u,v):"",r.visible=!0;const M=o[0]-n[0],y=o[1]-n[1];s?Tt(Q,-y,M):Tt(Q,y,-M),ai(Q,Q),rn(Q,Q,this._edgeDistancePixels),ln(ee,n,o,.5),pn(ee,ee,Q),r.position=[ee[0],ee[1]],Math.abs(Q[0])>Math.abs(Q[1])?r.anchor=Q[0]>0?"left":"right":r.anchor=-Q[1]<0?"top":"bottom"}_getOrCreateLabel(t){var a;if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const i=new gn({fontSize:10,anchor:"center"});(a=t.view.overlay)==null||a.items.add(i);const n={label:i};return this._labelInfos.push(n),this._nextLabelIndex=this._labelInfos.length,n}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){ti(this.context,i=>{var n;return(n=i.view.overlay)==null?void 0:n.items.remove(t)}),t.destroy()}};h([d()],ht.prototype,"context",void 0),h([d()],ht.prototype,"stagedVertex",void 0),h([d()],ht.prototype,"visible",void 0),h([d()],ht.prototype,"edgeDistance",void 0),h([d()],ht.prototype,"updating",null),h([d()],ht.prototype,"_messagesUnits",void 0),h([d()],ht.prototype,"_edgeDistancePixels",null),ht=h([C("esri.views.interactive")],ht);const Q=ae(),ee=ae(),Fo=Ve(),Bo=Ve();let $e=class extends ht{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:i,editGeometryOperations:n},a,o=Ve()){const{spatialReference:s}=n.data.coordinateHelper;return yn(a,s,i,t,Bi),t.state.camera.projectToScreen(Bi,o),o}};$e=h([C("esri.views.3d.interactive.SegmentLabels3D")],$e);const Bi=V();let Ht=class extends Vn{constructor(t){super(t),this._attachmentOrigin=ce(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new dt,this._geometry=null,this._width=1,this._color=Ai(1,0,1,1),this._innerWidth=0,this._innerColor=Ai(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=st.OccludeAndTransparentStencil,this._attachmentOrigin.spatialReference=t.view.spatialReference,this._laserline=new Ae({view:t.view}),this.applyProps(t),this.attached=t.attached??!0}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(t){return{view:t,createResources:i=>this._createObject3DResources(i),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:(i,n)=>{i.geometries.length=0,this._recreateGeometry(n,i.material,i.geometries)}}}createDrapedResourceFactory(t){return{view:t,createResources:()=>this._createDrapedResources(),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:i=>{i.geometries=this._createRenderGeometriesDraped(i.material),this._attachmentOriginChanged()}}}get _laserlineAttached(){return this.attached&&this.visible&&c(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}onAttachedChange(t){this._laserline.attached=this._laserlineAttached,t&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._updateMaterial())}get color(){return this._color}set color(t){qe(t,this._color)||($i(this._color,t),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){qe(t,this._innerColor)||($i(this._innerColor,t),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const i=c(t)!==c(this._stipplePattern);this._stipplePattern=t,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){t&&this._stippleOffColor&&qe(t,this._stippleOffColor)||(this._stippleOffColor=t?Mn(t):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,this._laserline.attached=this._laserlineAttached,c(t)&&(this._laserline.style=t)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get attachmentOrigin(){var n;if(!this._attachmentOriginDirty)return this._attachmentOrigin;const t=(n=Ua(this.object3dResources.resources))==null?void 0:n.geometries;if(!t||t.length===0)return null;nt(Nt,0,0,0);let i=0;for(const a of t)a.computeAttachmentOrigin(ji)&&(Pe(Nt,Nt,ji),i++);return i===0?null:(Le(Nt,Nt,1/i),this.view.renderCoordsHelper.fromRenderCoords(Nt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){c(this.object3dResources.resources)&&this.object3dResources.resources.material.setParameters(this._materialParameters),c(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this._materialParameters)}get _isClosed(){return c(this.geometry)&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===st.OccludeAndTransparentStencil?st.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(t,i,n){this._createRenderGeometries(i,n);for(const a of n)t.addGeometry(a);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_destroyExternalResources(t){t.geometries=[],t.material.dispose()}_createObject3DResources(t){const i=new Ti(this._materialParameters),n=new Array;return this._recreateGeometry(t,i,n),{material:i,geometries:n,forEach:a=>{a(i),n.forEach(a)}}}_createDrapedResources(){const t=new Ti(this._materialParameters);return{material:t,geometries:this._createRenderGeometriesDraped(t)}}_createRenderGeometriesDraped(t){const i=this.geometry;if(_(i)||_(this.view.basemapTerrain.spatialReference))return[];const n=bn(i,this.view.basemapTerrain.spatialReference),a=[];for(const{position:o}of n.lines){const s={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:o},removeDuplicateStartEnd:this._isClosed},r=new Sn(Di(t,s)),l=Sa(jo);Pi(l,o),$n(r.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),a.push(r)}return a}calculateMapBounds(t){if(_(this.object3dResources.resources))return!1;const i=this.view.renderCoordsHelper;for(const n of this.object3dResources.resources.geometries){const a=n.vertexAttributes.get(Hn.POSITION),o=Cn(a.data.length);In(a.data,i.spatialReference,0,o,this.view.spatialReference,0,a.data.length/3),Pi(t,o)}return!0}_createRenderGeometries(t,i){const n=this.geometry;if(_(n))return;const a=xn(n,this.view.elevationProvider,this.view.renderCoordsHelper,Ce.fromElevationInfo(this.elevationInfo??new va({mode:_a(n,null)}))),o=new Array;for(const{position:s,mapPositions:r}of a.lines){const l={mapPositions:r,attributeData:{position:s},removeDuplicateStartEnd:this._isClosed};i.push(Di(t,l)),o.push(s)}this._laserline.pathVerticalPlane=o}};const jo=ba(),ji=V(),Nt=V();let W=class extends dt.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};h([d({constructOnly:!0})],W.prototype,"graphic",void 0),h([d()],W.prototype,"tracking",void 0),h([d()],W.prototype,"displaying",void 0),h([d()],W.prototype,"isDraped",void 0),W=h([C("esri.views.3d.layers.graphics.GraphicState")],W);let Ut=class extends Nn{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:i}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new va({mode:t,offset:i})}normalizeCtorArgs(t){if(!t.elevationInfo){const i=t.hasZ??!0;return{...t,elevationInfo:Wa(i)}}return t}initializeGraphic(t){const i=this._createGraphicState=new W({graphic:t});return Z([this.view.maskOccludee(t),this.view.trackGraphicState(i),G(()=>({element:this._outlineVisualElement,isDraped:i.isDraped}),({element:n,isDraped:a})=>{ti(n,o=>o.isDraped=a)},St)])}makeDrawOperation(){const{geometryType:t}=this,i=t!=="circle"&&t!=="rectangle";return new Un({view:this.view,manipulators:this.manipulators,geometryType:Xn(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Zn(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new kn(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new re,segmentLabels:i?new $e:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Ei(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(t){const{view:i}=this;return c(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],this._updateVerticalLineVisualElement(t),null):(this._activeVertexVisualElement=new Ri({view:i,spatialReference:i.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:g.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=g.colorToVec4(g.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,this._verticalLineVisualElement=new mi({view:i,extensionType:g.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:st.OccludeAndTransparent}),g.visualElements.zVerticalLine.apply(this._verticalLineVisualElement),Vt(()=>{this._activeVertexVisualElement=P(this._activeVertexVisualElement),this._verticalLineVisualElement=P(this._verticalLineVisualElement)}))}_updateVerticalLineVisualElement(t){const i=this._verticalLineVisualElement;if(_(i))return;const{renderCoordsHelper:n,elevationProvider:a}=this.view;nt(Xt,t[0],t[1],t[2]),qi.setFromElevationInfo(this.elevationInfo),Xt[2]=di(Xt,a,qi,n),n.toRenderCoords(Xt,this.view.spatialReference,Xt)?(i.setStartEndFromWorldDownAtLocation(Xt),i.attached=!0):i.attached=!1}onOutlineChanged(t){if(c(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const i=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Ht({view:this.view,geometry:t,elevationInfo:i,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Ei(this.hasZ,i)==="on-the-ground",attached:!1}),g.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),g.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Vt(()=>{this._outlineVisualElement=P(this._outlineVisualElement)})}onRegularVerticesChanged(t){return c(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new Ri({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:g.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Vt(()=>{this._verticesVisualElement=P(this._verticesVisualElement)}))}};h([d({constructOnly:!0})],Ut.prototype,"elevationInfo",void 0),h([d({constructOnly:!0})],Ut.prototype,"geometryType",void 0),h([d()],Ut.prototype,"type",void 0),h([d({constructOnly:!0})],Ut.prototype,"view",void 0),Ut=h([C("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Ut);const qi=new Ce,Xt=V();var at;(function(e){e[e.NONE=0]="NONE",e[e.ANY=1]="ANY",e[e.Z=2]="Z",e[e.XY=4]="XY"})(at||(at={}));var T;(function(e){e[e.TRANSLATE_Z=0]="TRANSLATE_Z",e[e.TRANSLATE_XY=1]="TRANSLATE_XY",e[e.SCALE=2]="SCALE",e[e.ROTATE=3]="ROTATE",e[e.SCALE_ROTATE=4]="SCALE_ROTATE"})(T||(T={}));let Pa=class{constructor(){this.grabbingState=at.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=at.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((i,n)=>{if(n===T.TRANSLATE_Z&&(this.zManipulator=i),i instanceof K&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),_(this.firstGrabbedXY)&&i.grabbing&&n===T.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=at.ANY,n){case T.TRANSLATE_Z:this.grabbingState|=at.Z;break;case T.TRANSLATE_XY:this.grabbingState|=at.XY}})}};function qo(e){const{view:t,graphic:i}=e,n=new W({graphic:i}),a=Wo(e,n),o=[a,Jo(e,a.visualElement,n),t.maskOccludee(i),t.trackGraphicState(n)];return{visualElement:a.visualElement,remove:()=>Z(o).remove()}}function Wo(e,t){const{view:i,graphic:n}=e,a=new Ht({view:i,geometry:pi(n)?n.geometry:null,elevationInfo:z(n),attached:!1});g.visualElements.lineGraphics.shadowStyle.apply(a);const o=()=>{a.attached=t.displaying};g.visualElements.lineGraphics.outline.apply(a);const s=[G(()=>t.displaying,o),G(()=>t.isDraped,r=>{a.isDraped=r}),t.on("changed",()=>a.geometry=pi(n)?n.geometry:null),Gt(a)];return o(),{visualElement:a,remove:()=>Z(s).remove()}}function Jo(e,t,i){const{graphic:n,view:a}=e,o=[],s=z(n),r=s.mode==="on-the-ground"||!s.offset&&s.mode!=="absolute-height",l=new Pa,p=new mi({view:a,extensionType:g.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:st.OccludeAndTransparent});g.visualElements.pointGraphics.shadowStyle.apply(p);const u=He(g.visualElements.heightPlaneAngleCutoff),m=new Ae({view:a,attached:!1,angleCutoff:u});g.visualElements.heightPlane.apply(m);let v=1,M=1;const y=()=>{if(l.update(e),!i.displaying||r&&(i.isDraped||!pi(n)||!n.geometry.hasZ))return t.laserlineEnabled=!1,p.attached=!1,void(m.attached=!1);t.laserlineEnabled=!0;const x=l.grabbingState&at.XY?g.visualElements.laserlineAlphaMultiplier:1;x!==v&&(v=x,g.visualElements.lineGraphics.shadowStyle.apply(t,x),g.visualElements.pointGraphics.shadowStyle.apply(p,x));const I=l.grabbingState&at.Z?g.visualElements.laserlineAlphaMultiplier:1;I!==M&&(M=I,g.visualElements.heightPlane.apply(m,I)),Ko(p,l),Qo(e,t,m,l)};g.visualElements.zVerticalLine.apply(p),o.push(i.on("changed",y),G(()=>i.displaying,y),t.events.on("attachment-origin-changed",y),Gt(p),Gt(m));const f=[],b=()=>{Z(f).remove(),f.length=0,e.forEachManipulator(x=>f.push(x.events.on("grab-changed",y))),e.forEachManipulator(x=>f.push(x.events.on("select-changed",y))),y()};return b(),o.push(e.onManipulatorsChanged(b),ua(()=>Z(f))),Z(o)}function Ko(e,t){const i=t.numSelected===1?t.firstSelected:t.numSelected>1&&c(t.firstGrabbedXY)?t.firstGrabbedXY:null;c(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}function Qo(e,t,i,n){if(n.numSelected>0){nt(Pt,0,0,0);let a=0;e.forEachManipulator((o,s)=>{s===T.TRANSLATE_XY&&o.selected&&o instanceof K&&(Pe(Pt,Pt,o.renderLocation),a++)}),a>0?(i.heightManifoldTarget=Le(Pt,Pt,1/a),i.attached=!0):i.attached=!1}else{const a=t.attachmentOrigin;c(a)&&e.view.renderCoordsHelper.toRenderCoords(a,Pt)?(i.heightManifoldTarget=Pt,i.attached=!0):i.attached=!1}}function pi(e){return c(e.geometry)&&(e.geometry.type==="polygon"||e.geometry.type==="polyline")}const Pt=V();function ts(e){const{view:t,graphic:i}=e,n=new W({graphic:i}),a=[],o=is(e,n,a);return es(e,n,a,o),a.push(t.trackGraphicState(n)),{visualElement:o,remove(){Z(a).remove()}}}function es(e,t,i,n){const{view:a,graphic:o}=e,s=new mi({view:a,extensionType:g.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:st.OccludeAndTransparent});g.visualElements.zVerticalLine.apply(s);const r=new Ae({view:a,intersectsLineInfinite:!0,attached:!1});g.visualElements.pointGraphics.shadowStyle.apply(r);const l=He(g.visualElements.heightPlaneAngleCutoff),p=new Ae({view:a,attached:!1,angleCutoff:l});g.visualElements.heightPlane.apply(p);const u=z(e.graphic),m=Ce.fromElevationInfo(u),v=u.mode==="on-the-ground"||!u.offset&&u.mode!=="absolute-height",M=new Pa;let y=1,f=1;const b=()=>{M.update(e);const x=bi(o),I=v&&(t.isDraped||_(x)||!x.hasZ);let H=!0;if(!I&&c(x)){const A=di(x,a.elevationProvider,m,a.renderCoordsHelper);nt(et,x.x,x.y,A),Ii(et,x.spatialReference,et,a.renderCoordsHelper.spatialReference),s.setStartEndFromWorldDownAtLocation(et),r.intersectsWorldUpAtLocation=et}else H=!1;const $t=M.grabbingState&at.Z?g.visualElements.laserlineAlphaMultiplier:1;$t!==y&&(y=$t,g.visualElements.heightPlane.apply(p,$t));const Y=Sa(ss);!I&&t.displaying&&n.calculateMapBounds(Y)&&Ii(Ln(Y,et),a.spatialReference,et,a.renderCoordsHelper.spatialReference)?(p.heightManifoldTarget=et,p.attached=!0):p.attached=!1;const ut=M.grabbingState&at.XY?g.visualElements.laserlineAlphaMultiplier:1;ut!==f&&(f=ut,g.visualElements.pointGraphics.shadowStyle.apply(r,ut));const me=H&&t.displaying&&!I;r.attached=me,s.attached=me};i.push(G(()=>[t.displaying,t.isDraped],b),t.on("changed",b)),e.forEachManipulator(x=>{i.push(x.events.on("grab-changed",b))}),i.push(Gt(r)),i.push(Gt(s)),i.push(Gt(p)),b()}function is(e,t,i){const{view:n,graphic:a}=e,o=new zn({view:n,geometry:bi(a),elevationInfo:z(a),attached:!1});return as(e,o,t,i),i.push(Gt(o)),o}function bi(e){const t=e.geometry;return _(t)?null:t.type==="point"?t:t.type==="mesh"?t.anchor.clone():null}function as(e,t,i,n){const a=()=>t.attached=i.displaying;ns(e,t,i,n),g.visualElements.pointGraphics.outline.apply(t),n.push(G(()=>i.displaying,a,St))}function ns(e,t,i,n){const{view:a,graphic:o}=e;let s=null;const r=p=>{c(s)&&(s.remove(),s=null),i.isDraped&&c(p)&&(s=os(a,p,()=>{t.geometry=p}))},l=()=>{const p=bi(o);r(p),t.geometry=p};n.push(i.on("changed",l),ua(()=>s)),l()}function os(e,t,i){const n=e.elevationProvider.spatialReference;Pn(t,et,n);const a=et[0],o=et[1];return e.elevationProvider.on("elevation-change",s=>{Oa(s.extent,a,o)&&i()})}const et=V(),ss=ba();function ke(e){switch(D(e.graphic.geometry).type){case"point":case"mesh":return ts(e);case"polygon":case"polyline":return qo(e);default:return null}}const rs=[1,.5,0],La=128,ct=70,ls=80,Va=.02,ps=54,hs=100,za=Math.ceil(ct/3*2),Lt=160,We=.5,Je=24,Zt=9,cs=Lt+30,Wi=Lt+53,ds=60,us=23,ms=5*Math.PI/12,gs=1*Math.PI/3,Ji=10,Ki=.2,Qi=30,ta=53,ea=.2,ia=.3,_s=200,vs=3,fs=1e6;class ue{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(i=>i.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(i=>i.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(i=>i.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(i=>{t||(t=i.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(i=>i.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}hasManipulator(t){return this.someManipulator(i=>i===t)}someManipulator(t){let i=!1;return this.forEachManipulator(n=>{!i&&t(n)&&(i=!0)}),i}_forEachManipulator3D(t){this.forEachManipulator((i,n)=>{i instanceof K&&t(i,n)})}}function Ye(e,t,i,n){const a=e.graphic,o=(s,r)=>t({action:s,graphic:a,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY});return i((s,r,l)=>(r.next(p=>(p.action==="start"&&o("start",p),p)).next(lo(a,n)).next(p=>{switch(p.action){case"start":case"update":(p.translationX||p.translationY||p.translationZ)&&o("update",p);break;case"end":o("end",p)}return p}),{steps:r,cancel:l=l.next(po(a)).next(p=>(o("end",{screenDeltaX:0,screenDeltaY:0}),p))}))}function Ca(e){if(_(e)||e.type!=="polyline"&&e.type!=="polygon")return 0;const t=(e.type==="polyline"?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],n=t[1];return Math.atan2(n[1]-i[1],n[0]-i[0])}function Ie(e){if(_(e)||_(e.axis))return 1;const{mapStart:t,mapEnd:i,axis:n}=e,a=[i.x-t.x,i.y-t.y];return a[0]*n[0]+a[1]*n[1]>0?1:-1}let ys=class extends ue{constructor(t){super(),this._handles=new Wt,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=ct,this._updateAfterDrag=!1,this.events=new dt,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(t){this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t}destroy(){this._handles=P(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:i}of this._arrowManipulatorInfos)t(i,T.TRANSLATE_XY)}createGraphicDragPipeline(t,i,n){const a=i.graphic,o=z(a),s=D(a.geometry).spatialReference;return Ye(i,n,r=>this.createDragPipeline((l,p,u,m,v)=>({steps:p,cancel:u}=t(l,p,u,m,v),r(l,p,u)),o,s,a),this._view.state.viewingMode)}createDragPipeline(t,i,n,a){return Z(this._arrowManipulatorInfos.map(({manipulator:o},s)=>rt(o,(r,l,p,u,m)=>{const v=l.next(M=>({...M,manipulatorType:T.TRANSLATE_XY})).next(ne(this._view,r.elevationAlignedLocation)).next(vi(this._view,r.elevationAlignedLocation,i,n,a)).next(ho(r.location,this.angle+(s+1)*Math.PI*.5)).next(Jt());t(r,v,p,u,m)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:i},n){const a=this._radius/ct,o=ps*a,s=o*Math.sqrt(3)/2,r=Oe(this._opaqueMaterial,s,o/2,o/2,Va);fa(r,zi(q.get(),nt($.get(),0,-s/3,0))),t.renderObjects=[new w(r,E.Focused),new w(r.instantiate({material:this._transparentMaterial}),E.Unfocused)],t.radius=s/3*2*1.2;const l=qn(q.get(),n*Math.PI/2),p=zi(q.get(),nt($.get(),0,hs*a,0));Se(i,l,p)}_createManipulators(){for(let t=0;t<4;t++){const i=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,i=Ta(q.get(),t,k(0,0,1));if(_(i))return;const n=Te(q.get(),nt($.get(),this.displayScale,this.displayScale,this.displayScale)),a=Se(q.get(),n,i);for(const o of this._arrowManipulatorInfos){const s=Se(q.get(),a,o.transform);o.manipulator.modelTransform=s}}_createArrowManipulator(t){const i=new K({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:k(0,0,1)}}),n={manipulator:i,transform:Ne()};return this._updateArrowManipulator(n,t),this._handles.add(i.events.on("drag",a=>{this._updateAfterDrag&&a.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),n}_createMaterial(t=1){const i=Aa.toUnitRGBA(gi.main);return i[3]*=t,new ui({color:i,transparent:t!==1,cullFace:fi.Back,renderOccluded:st.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:t})=>t)}}},Ms=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&c(this._lastDragEvent)&&c(this._next)){const i=this._lastDragEvent.mapEnd,n=this._snap(this._lastDragEvent.screenEnd);if(c(n)){const a={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?n:i,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(a)}}this._enabled=t}_snap(t){const i=c(this._view)?this._view.toMap(t,{exclude:[]}):null;return c(i)&&c(this._view)&&(i.z=Ja(i,this._view,this._elevationInfo)),i}createDragEventPipelineStep(t,i){this._view=t,this._elevationInfo=i,this._lastDragEvent=null;const n=new Ra;return this._next=n,[a=>{if(this._lastDragEvent=a.action!=="end"?{...a}:null,this._enabled){const o=this._snap(a.screenEnd);return c(o)?{action:a.action,mapStart:a.mapStart,mapEnd:o,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}},n]}},bs=class extends ue{constructor(t){super(),this._snapToScene=new Ms,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=ct,this._view=t.view,this._tool=t.tool,t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,T.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,i,n){const a=i.graphic,o=z(a),s=D(a.geometry).spatialReference;return Ye(i,n,r=>this.createDragPipeline((l,p,u,m,v)=>({steps:p,cancel:u}=t(l,p,u,m,v),r(l,p,u)),o,s,a),this._view.state.viewingMode)}createDragPipeline(t,i,n,a){const o=this._view;return rt(this._manipulator,(s,r,l,p,u)=>{const m=r.next(ne(o,s.elevationAlignedLocation)).next(vi(o,s.elevationAlignedLocation,i,n,a)).next(...this._snapToScene.createDragEventPipelineStep(o,i)).next(v=>({...v,manipulatorType:T.TRANSLATE_XY})).next(Jt());t(s,m,l,p,u)})}_updateManipulatorTransform(){const t=Te(q.get(),nt($.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new K({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:k(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=wn(this._discMaterial,Va,1,La,k(0,0,1),k(0,0,0));t.transformation=Te(Ne(),k(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new w(t,E.Focused),new w(t.instantiate({material:this._discMaterialTransparent}),E.Unfocused)],this._manipulator.radius=ls*(this._radius/ct)}_createMaterial(t=1){const i=Aa.toUnitRGBA(gi.main);return i[3]*=t,new ui({color:i,transparent:t!==1,cullFace:fi.Back,renderOccluded:st.Transparent})}get test(){return{discManipulator:this._manipulator}}},Ss=class extends ue{constructor(t){super(),this._radius=ct,this.events=new dt,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,T.TRANSLATE_Z)}createGraphicDragPipeline(t,i,n){const a=D(i.graphic.geometry).spatialReference;return Ye(i,n,o=>this.createDragPipeline((s,r,l,p,u)=>({steps:r,cancel:l}=t(s,r,l,p,u),o(s,r,l)),a),this._view.state.viewingMode)}createDragPipeline(t,i){const n=this._view;return rt(this._manipulator,(a,o,s,r,l)=>{const p=o.next(u=>({...u,manipulatorType:T.TRANSLATE_Z})).next(Ga(n,a.renderLocation,i)).next(Jt());t(a,p,s,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._radius/ct,i=g.zManipulator.height*t,n=g.zManipulator.coneHeight*t,a=g.zManipulator.coneWidth*t,o=g.zManipulator.width*t,s=[k(0,0,0),k(0,0,i)],r=[k(0,0,0),k(0,0,i+n)],l=x=>{const I=Ne();if(Wn(I,I,[0,0,i]),Jn(I,I,Math.PI/2),x){const H=1+2*x/a;Da(I,I,[H,H,H])}return I},p=l(0),u=(x,I)=>{const H=mo(g.zManipulator.color,I);return[H.r/255,H.g/255,H.b/255,g.zManipulator.color.a*x]},m=bt(u(1,.25),st.Occlude),v=bt(u(1,0),st.Occlude),M=bt(u(.7,0),g.zManipulator.renderOccluded),y=bt(u(.85,0),g.zManipulator.renderOccluded),f=En(m,s,o/2,16,!1),b=On(m,n,a/2,16,!1);b.transformation=p,this._manipulator.renderObjects=[new w(b,E.Unfocused),new w(f,E.Unfocused),new w(b.instantiate({material:v}),E.Focused),new w(f.instantiate({material:v}),E.Focused),new w(b.instantiate({material:M}),E.Unfocused),new w(f.instantiate({material:M}),E.Unfocused),new w(b.instantiate({material:y}),E.Focused),new w(f.instantiate({material:y}),E.Focused)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[r]}}_createManipulator(){const t=new K({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=i=>{const n=this._view.state.camera,a=aa;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const o=Fa(n.eye,a),s=n.computeRenderPixelSizeAtDist(o),r=ot(kt,a,n.eye);ei(r,r);const l=xs;this._view.renderCoordsHelper.worldUpAtPosition(aa,l);const p=Math.abs(ii(r,l)),u=jt(kt,r,l),m=jt(kt,u,l),v=oi(p,.01,1),M=1-Math.sqrt(1-v*v)/v/n.fullWidth,y=this._radius/ct,f=g.zManipulator.width*y;Le(m,ei(m,m),(1/M-1)*o+s*f),i[12]-=kt[0],i[13]-=kt[1],i[14]-=kt[2]},this._manipulator=t,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}};const aa=V(),kt=V(),xs=V();class Ct extends ue{constructor(t){super(),this._handles=new Wt,this._interactive=!0;const{tool:i,view:n,snapToScene:a,radius:o}=t;this._view=n,this.xyManipulation=new bs({tool:i,view:n,snapToScene:a,radius:o}),this.xyAxisManipulation=new ys({tool:i,view:n,radius:o}),this.zManipulation=new Ss({tool:i,view:n,radius:o}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(s=>this._handles.add(s.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,i,n){return Z([this.xyManipulation.createGraphicDragPipeline((a,o,s,r,l)=>t(S.XY,a,o,s,r,l),i,n),this.xyAxisManipulation.createGraphicDragPipeline((a,o,s,r,l)=>t(S.XY_AXIS,a,o,s,r,l),i,n),this.zManipulation.createGraphicDragPipeline((a,o,s,r,l)=>t(S.Z,a,o,s,r,l),i,n)])}createDragPipeline(t,i,n,a){return Z([this.xyManipulation.createDragPipeline((o,s,r,l,p)=>t(S.XY,o,s,r,l,p),i,n,a),this.xyAxisManipulation.createDragPipeline((o,s,r,l,p)=>t(S.XY_AXIS,o,s,r,l,p),i,n,a),this.zManipulation.createDragPipeline((o,s,r,l,p)=>t(S.Z,o,s,r,l,p),n)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(i=>t(i,T.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>t(i,T.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>t(i,T.TRANSLATE_Z))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,i=this.xyManipulation;if(tn("esri-mobile"))return;const n=[];i.forEachManipulator(o=>n.push(o)),t.forEachManipulator(o=>n.push(o));const a=()=>{const o=[];this._xyAxisVisible||t.forEachManipulator(s=>o.push(s.disableDisplay())),this._handles.remove(na),this._handles.add(o,na)};for(const o of n)this._handles.add(o.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(Bt(()=>{var o;return(o=this._view.inputManager)==null?void 0:o.latestPointerType},a)),a()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(i=>{i.interactive=!t&&this._interactive||i.grabbing})}static radiusForSymbol(t){const i=c(t)&&t.type==="point-3d"&&t.symbolLayers;return i&&i.length>0&&i.some(n=>n.type==="icon")?za:ct}}const na="disable-xy-axis-display";var S;(function(e){e[e.XY=0]="XY",e[e.XY_AXIS=1]="XY_AXIS",e[e.Z=2]="Z"})(S||(S={}));class Si extends ue{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,T.TRANSLATE_XY)}createGraphicDragPipeline(t){return Ye(this._graphicState,t,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(t){const i=this._view,n=this._graphicState.graphic,a=c(n.geometry)?n.geometry.spatialReference:null;return rt(this._manipulator,(o,s,r,l,p)=>{const u=s.next(ao(p,i,n,a)).next(Yt()).next(Jt());t(o,u,r,l,p)})}_createManipulator(){const t=this._view,i=this._graphicState.graphic;this._manipulator=new go({graphic:i,view:t,selectable:!0,cursor:"move"})}}class ws{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class Es{constructor(t,i,n){this.dx=t,this.dy=i,this.allGraphics=n,this.type="graphic-move"}}class oa{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}let mt=class extends xa(dt.EventedMixin(Ue)){constructor(e){super(e),this.graphics=new Bn,this.enableZ=!0,this.tooltipOptions=new Rt,this.type="move-3d",this._tooltip=null}initialize(){const{graphics:e,view:t}=this;this.addHandles([e.on("change",()=>this._refreshManipulators()),G(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new he({view:t}):P(this._tooltip)},ci)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=P(this._tooltip),this._moveManipulation=P(this._moveManipulation),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){var t;this.handles.removeAll(),(t=this._moveManipulation)==null||t.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter(i=>An(i)===ya.SUPPORTED).map(i=>new Os(i));e.length&&(this._createManipulators(e),this._createVisualElements(e),this.handles.add(e.map(i=>this.view.trackGraphicState(i.state))),this._updateMoveManipulation(e))}_createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Si({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator(n=>this.handles.add([n.events.on("immediate-click",a=>{this.emit("immediate-click",{...a,graphic:i.graphic}),a.stopPropagation()}),n.events.on("grab-changed",({action:a})=>{const{tooltipOptions:o,_tooltip:s}=this;_(s)||(a==="start"?s.info=new pe({tooltipOptions:o}):s.clear())})])),this.handles.add(t.manipulationXY.createDragPipeline((n,a,o,s)=>this._buildDragEventPipeline(e,S.XY,n,a,o,s)))}this._createMoveManipulation(e)}_createMoveManipulation(e){const t=new Ct({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:e.length===1?Ct.radiusForSymbol(e[0].graphic.symbol):ct});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator(o=>{this.handles.add(o.events.on("immediate-click",s=>{t.zManipulation.hasManipulator(o)||this.graphics.length!==1||this.emit("immediate-click",{...s,graphic:this.graphics.getItemAt(0)}),s.stopPropagation()}))});const i=o=>s=>{this.handles.add(s.events.on("focus-changed",({action:r})=>{const l=this._tooltip;_(l)||(r==="focus"?this._updateMoveTooltip(e,o):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(S.Z));const n=()=>this._updateMoveManipulation(e);for(const o of e)this.handles.add([o.state.on("changed",n),G(()=>o.state.displaying,n)]);const a=e[e.length-1];this.handles.add(a.state.on("changed",()=>this._updateMoveManipulationAngle(a))),this.handles.add(t.createDragPipeline((o,s,r,l,p)=>this._buildDragEventPipeline(e,o,s,r,l,p),z(a.graphic),D(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(e){for(const t of e){const i=t.graphic,n=ke({view:this.view,graphic:i,forEachManipulator:a=>{var o;(o=t.manipulationXY)==null||o.forEachManipulator(a),this._moveManipulation.forEachManipulator(a)},onManipulatorsChanged:()=>Vt()});_(n)||(t.geometryRepresentation=n.visualElement,t.geometryRepresentation instanceof Ht&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.state.isDraped||this._updateMoveManipulation(e)}),G(()=>t.state.isDraped,()=>this._updateMoveManipulation(e))]),this.handles.add(n))}}_updateMoveManipulationAngle(e){this._moveManipulation.angle=Ca(e.graphic.geometry)}_updateMoveManipulation(e){const t=ce(0,0,0,this.view.spatialReference);let i=0,n=!1;const a=this._moveManipulation;for(const o of e){if(!o.state.displaying)continue;const s=o.state.graphic;this.enableZ&&zt(s)&&(n=!0);const r=o.geometryRepresentation instanceof Ht&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:ni(this.view,s);if(c(r)){const{x:l,y:p,z:u}=r;t.x+=l,t.y+=p,u&&(t.z??(t.z=0),t.z+=u),i++}}i>0?(t.x/=i,t.y/=i,t.z??(t.z=0),t.z/=i,a.location=t,a.xyManipulation.available=!0,a.xyAxisManipulation.available=!0,a.zManipulation.available=n):a.available=!1}_buildDragEventPipeline(e,t,i,n,a,o){const s=[],r=[];let l=null,p=null;const u=()=>{for(const m of s)m.dragging=!1;s.length=0,r.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(e.length===1&&t===S.XY){const m=e[0].graphic;({steps:n,cancel:a}=this._buildSnappingPipelineSteps(m,z(m),n,a,o))}return a=a.next(m=>p==null?void 0:p(m)).next(()=>(this.emit("graphic-move-stop",new oa(r)),this.destroyed||u(),null)),{steps:n=n.next(m=>{var v,M;if(m.action==="start"){s.length=0,r.length=0;for(const y of e)y.dragging||!((v=y.manipulationXY)!=null&&v.hasManipulator(i))&&((M=y.manipulationXY)!=null&&M.grabbing)||(s.push(y),r.push(y.graphic),y.dragging=!0);if(r.length!==0&&(this._moveManipulation.interactive=!1,l=co(r,this.view.state.viewingMode),p=uo(r),this.emit("graphic-move-start",new ws(r)),this.destroyed))return null}return r.length!==0?m:null}).next(m=>l==null?void 0:l(m)).next(m=>(this._updateMoveTooltip(e,t,m),m)).next(m=>{switch(m.action){case"start":case"update":if(m.translationX||m.translationY||m.translationZ){const v=this.view.toScreen(m.mapStart),M=this.view.toScreen(m.mapEnd),y=M.x-v.x,f=M.y-v.y;if(this.emit("graphic-move",new Es(y,f,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new oa(r)),this.destroyed)return null;u()}return null}),cancel:a}}_updateMoveTooltip(e,t,i){const{tooltipOptions:n,_tooltip:a}=this;if(_(a))return;a.clear();const o=e.length===0?"absolute-height":e[0].state.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:a.info=new pe({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,(s,r)=>xt(s,r,o));break;case S.XY_AXIS:a.info=new yi({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,(s,r)=>{const l=xt(s,r,o);return Ee(l,Ie(i))});break;case S.Z:a.info=new Ze({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,Re)}}_updateMoveTooltipDistance(e,t,i){if(c(t)&&t.action!=="end"){const{mapStart:n,mapEnd:a}=t,o=i(n,a);e.distance=c(o)?o:oe}}_buildSnappingPipelineSteps(e,t,i,n,a){const o=e.geometry;if(_(o)||o.type!=="point"&&o.type!=="mesh")return{steps:i,cancel:n};const s=(o.type==="point"?o:o.anchor).clone(),r=new De({elevationInfo:t,pointer:a,editGeometryOperations:Xe.fromGeometry(s,this.view.state.viewingMode),visualizer:new re,excludeFeature:e}),l=this.snappingManager,{snappingStep:p,cancelSnapping:u}=Ge({snappingContext:r,snappingManager:l,updatingHandles:this.updatingHandles});return n=n.next(u),{steps:i=i.next(m=>(s.z=Ka(this.view,s,z(e),{mode:"absolute-height",offset:0}),{...m,snapOrigin:r.coordinateHelper.pointToVector(s)})).next(...p),cancel:n}}get test(){return{tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],mt.prototype,"view",void 0),h([d()],mt.prototype,"graphics",void 0),h([d({constructOnly:!0,nonNullable:!0})],mt.prototype,"enableZ",void 0),h([d({constructOnly:!0,type:Rt})],mt.prototype,"tooltipOptions",void 0),h([d({constructOnly:!0})],mt.prototype,"snappingManager",void 0),h([d()],mt.prototype,"type",void 0),h([d()],mt.prototype,"updating",null),mt=h([C("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],mt);class Os{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new W({graphic:t})}get graphic(){return this.state.graphic}}function sa(e,t,i){const n=i.mode==="on-the-ground"?Xi.XY:Xi.XYZ;return new _o(e,n,t,0)}function ra(e,t,i){const n=V();if(!e.renderCoordsHelper.toRenderCoords(t,n))return null;const a=la(e,t,de(i.plane)),o=la(e,t,i.edgeDirection);if(_(a)||_(o))return null;const s=jt(V(),a,o);return $a(n,s,Mi())}function la(e,t,i){const n=ce(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),a=V(),o=V();return e.renderCoordsHelper.toRenderCoords(t,a)&&e.renderCoordsHelper.toRenderCoords(n,o)?ma(o,a,o):null}function As(e,t,i){const n=de(e),a=ma(V(),t,i),o=jt(V(),a,n),s=jt(V(),a,o);return Qn(a[0],a[1],a[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,0,0,0,1)}function Ts(e,t,i){const n=i.projectToRenderScreen(e,Oi()),a=i.projectToRenderScreen(t,Oi());return c(n)&&c(a)?Ba(ot(n,n,a)):0}let Dt=class extends ze{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=oe,this.area=null,this.totalLength=null}};h([d()],Dt.prototype,"type",void 0),h([d()],Dt.prototype,"distance",void 0),h([d()],Dt.prototype,"area",void 0),h([d()],Dt.prototype,"totalLength",void 0),Dt=h([C("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Dt);let L=class extends dt.EventedMixin(_i){constructor(e){super(e),this._vertexManipulatorMaterial=bt(g.colorToVec4(g.reshapeManipulators.vertex.color),g.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=te(g.colorToVec4(g.reshapeManipulators.vertex.outlineColor),g.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=te(g.colorToVec4(g.reshapeManipulators.vertex.hoverOutlineColor),g.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=bt(g.colorToVec4(g.reshapeManipulators.edge.color),g.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=te(g.colorToVec4(g.reshapeManipulators.edge.outlineColor),g.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=bt(g.colorToVec4(g.reshapeManipulators.edgeOffset.color),g.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=bt(g.colorToVec4(g.reshapeManipulators.edgeOffset.hoverColor),g.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=bt(g.colorToVec4(g.reshapeManipulators.selected.color),g.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=te(g.colorToVec4(g.reshapeManipulators.selected.outlineColor),g.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=te(g.colorToVec4(g.reshapeManipulators.selected.hoverOutlineColor),g.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._manipulatorHandles=new Wt,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=R.NONE,this._recreatingManipulators=!1,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:e,view:t}=this,i=this._graphicState=new W({graphic:e});this._tooltip=new he({view:t}),this.addHandles([G(()=>i.displaying,n=>{for(const a of this._manipulatorInfos)a.manipulator.available=n}),G(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:n,enabled:a,edgeOffsetEnabled:o})=>{c(n)&&(n.visible=a,n.edgeDistance=o?"far":"default")},St),Bt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),St),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=P(this._segmentLabels),this._tooltip=P(this._tooltip),this._removeManipulators()}get inputGeometry(){return c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const e=this._manipulatorInfos.filter(t=>t.manipulator.selected&&t.type==="vertex");this._removeVertices(e)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=P(this._moveManipulation),this._graphicMoveManipulation=P(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(e){if(_(this._editGeometryOperations))return;const t=z(this.graphic);for(const i of this._editGeometryOperations.data.components){const n=e==null?void 0:e.byComponentIndex.get(i.index);for(const a of i.vertices){const o=n==null?void 0:n.has(a.index);this._createVertexOrEdgeManipulator(a,t,o)}for(const a of i.edges)this._createVertexOrEdgeManipulator(a,t)}this._createGraphicMoveManipulation(),this._createMoveManipulation(t),this._createVisualElements()}get canRedo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(_(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return c(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(_(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return c(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(e){const t={byComponentIndex:new Map};if(c(e)&&c(this.inputGeometry)&&dn(e,this.inputGeometry)){for(const i of this._manipulatorInfos)if(i.type==="vertex"&&i.manipulator.selected){const{index:n,component:{index:a}}=i.handle,{byComponentIndex:o}=t,s=o.get(a)||new Set;s.add(n),o.set(a,s)}}this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=P(this._editGeometryOperations),this._segmentLabels=P(this._segmentLabels),_(e)||(this._editGeometryOperations=Xe.fromGeometry(e,this.view.state.viewingMode),this._createManipulators(t),this._segmentLabels=new $e({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:z(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled})),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(e,t){if(t.action==="end")return t;let i=0;const n=[],a=this._manipulatorInfos.some(s=>s.type==="vertex"&&s.manipulator.selected),o=e===Ft.SELECTED_OR_ALL&&a;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.grabbing||o&&!s.manipulator.selected||n.push(s),i++);if(n.length===0)return t;if(this._moveVertices(n,t),n.length===i){if(this._updateEventState(R.MOVING),this.destroyed)return t;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(R.RESHAPING),this.destroyed)return t;this.emit("reshape",{type:"reshape",mover:this.graphic})}return t}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((e,t)=>t.type==="vertex"&&t.manipulator.selected?e+1:e,0)>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(R.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:n}=e;if(!t&&!i&&!n)return;const a=[];for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.selected&&!o.manipulator.grabbing||o===e.info)&&a.push(o);this._moveVertices(a,e,Mt.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case R.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case R.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case R.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case R.MOVING:switch(this._reshapeEventState){case R.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case R.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case R.RESHAPING:switch(this._reshapeEventState){case R.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case R.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulation(){const{tool:e,view:t}=this,i=this._graphicState;if(this._graphicMoveManipulation=new Si({tool:e,view:t,graphicState:i}),this.enableMoveGraphic){let n=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((a,o,s)=>{o.next(r=>this._trackNumDragging(r)).next(r=>(r.action==="start"&&(n=D(this._editGeometryOperations).createUndoGroup()),r)).next(r=>this._perGraphicManipulatorDragAction(Ft.ALL,r)).next(r=>(this._updateTranslateGraphicTooltip(S.XY,r),r)).next(r=>{r.action==="end"&&(this._tooltip.clear(),n=Ot(n))}),s.next(()=>this._onDragCancel(!0,()=>n=Ot(n)))})),this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!1)))}else this._graphicMoveManipulation.forEachManipulator(n=>{n.grabbable=!1,n.cursor=null});this._graphicMoveManipulation.forEachManipulator(n=>this._manipulatorHandles.add(n.events.on("immediate-click",a=>{this._manipulatorInfos.some(o=>o.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...a,graphic:this.graphic}),a.stopPropagation()})))}_createMoveManipulation(e){const{graphic:t,handles:i,tool:n,view:a}=this,o=this._graphicState;this._moveManipulation=new Ct({tool:n,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&zt(t),snapToScene:!1,radius:Ct.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(l=>i.add([l.events.on("immediate-click",p=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(u=>u.manipulator.selected)||this.emit("immediate-click",{...p,graphic:t}),p.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const s=l=>p=>{i.add(p.events.on("focus-changed",({action:u})=>{u==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(l):this._tooltip.clear()}))};this._moveManipulation.xyManipulation.forEachManipulator(s(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(s(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(s(S.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=D(t.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,p,u,m,v)=>{const{snappingStep:M,cancelSnapping:y}=Ge({predicate:f=>!!f.info,snappingManager:n.snappingManager,snappingContext:new De({editGeometryOperations:D(this._editGeometryOperations),elevationInfo:e,pointer:v,excludeFeature:t,visualizer:new re}),updatingHandles:this.updatingHandles,useZ:!1});return m=m.next(f=>(this._onDragCancel(),f)).next(y),{steps:u=u.next(f=>this._trackNumDragging(f)).next(f=>{const b=this._manipulatorInfos.filter(x=>x.type==="vertex"&&x.manipulator.selected);return f.manipulatorType===T.TRANSLATE_XY&&b.length===1?{...f,info:b[0],snapOrigin:b[0].handle.pos}:f}).next(Ui(this.view,e,t)).next(...M).next(Yt()).next(f=>this._perGraphicManipulatorDragAction(Ft.SELECTED_OR_ALL,f)).next(f=>(this._updateTranslateTooltip(l,f),f)),cancel:m}},e,r,t),G(()=>o.displaying,()=>this._updateMoveManipulationPosition(),St),o.on("changed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),G(()=>o.isDraped,l=>{this._updateMoveManipulationPosition();const p="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),p):i.remove(p)},St)])}_createVisualElements(){const{graphic:e,view:t}=this,i=ke({view:t,graphic:e,forEachManipulator:n=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n);for(const a of this._manipulatorInfos)n(a.manipulator,T.TRANSLATE_XY)}},onManipulatorsChanged:n=>this.on("manipulators-changed",n)});c(i)&&(this._outlineVisualElement=i.visualElement instanceof Ht?i.visualElement:null),c(this._outlineVisualElement)&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=z(this.graphic)){var M,y;const i=g.reshapeManipulators.edgeOffset,n=i.size/2,a=n+i.collisionPadding,o=n/a,s=o*Math.sqrt(3)/2;_(this._edgeOffsetManipulatorGeometryInside)&&(this._edgeOffsetManipulatorGeometryInside=Oe(this._edgeOffsetManipulatorMaterial,s,o/2,o/2,i.height,i.offset)),_(this._edgeOffsetManipulatorGeometryOutside)&&(this._edgeOffsetManipulatorGeometryOutside=Oe(this._edgeOffsetManipulatorMaterial,-s,o/2,o/2,i.height,-i.offset));const r=[new w(this._edgeOffsetManipulatorGeometryInside.instantiate(),E.Unfocused),new w(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),E.Focused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate(),E.Unfocused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),E.Focused)],l=new K({view:this.view,renderObjects:r,elevationInfo:t.mode!=="on-the-ground"||Yi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:a,available:!(!this.graphic.visible||!((M=this.graphic.layer)!=null&&M.visible)),collisionType:{type:"disc",direction:k(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),p=new K({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!((y=this.graphic.layer)!=null&&y.visible)),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),u={manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:p,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(u,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(u);const m=[];for(const f of[u.handle.leftVertex,u.handle.rightVertex]){const b=this._getManipulatorInfoFromHandle(f);c(b)&&m.push(b.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(u)))}u.locationUpdateHandle=Z(m),this._manipulatorHandles.add(u.locationUpdateHandle,l),this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!0),this._watchAndUpdateGrabState(p,!0)],l),this._manipulatorHandles.add(rt(l,this._createEdgeOffsetPipeline(u,t)),l),this._manipulatorHandles.add(rt(p,(f,b,x,I)=>{if(I==="touch")this._createEdgeOffsetPipeline(u,t)(f,b,x);else if(this.enableMoveGraphic){const H=this.graphic,$t=c(H.geometry)?H.geometry.spatialReference:null;b.next(Y=>this._trackNumDragging(Y)).next(ne(this.view,f.elevationAlignedLocation)).next(vi(this.view,f.elevationAlignedLocation,t,$t,H)).next(Jt()).next(Yt()).next(Y=>this._perGraphicManipulatorDragAction(Ft.ALL,Y)).next(Y=>(this._updateTranslateGraphicTooltip(S.XY,Y),Y)).next(Y=>{Y.action==="end"&&this._tooltip.clear()}),x.next(()=>this._onDragCancel(!f.metadata.deleting))}}),l);const v=f=>{this._manipulatorInfos.some(b=>b.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...f,graphic:this.graphic}),f.stopPropagation()};return this._manipulatorHandles.add([l.events.on("immediate-click",v),p.events.on("immediate-click",v),l.events.on("focus-changed",({action:f})=>{const b=this._tooltipOptions;if(f==="focus"&&b.enabled){const x=this._tooltip.info=new Dt({tooltipOptions:b});this._updateTooltipAreaOrTotalLength(x)}else this._tooltip.clear()})],l),this._manipulatorInfos.push(u),this.manipulators.add(l),this.manipulators.add(p),this.emit("manipulators-changed"),u}_autoHideEdgeOffsetManipulator(e,t){const i=e.manipulator,n=e.edgeManipulator,a=()=>{e.visibilityHandle=Ot(e.visibilityHandle);const o=this._getManipulatorInfoFromHandle(e.handle.leftVertex),s=this._getManipulatorInfoFromHandle(e.handle.rightVertex),r=c(o)&&c(s)&&Ts(o.manipulator.renderLocation,s.manipulator.renderLocation,this.view.state.camera)<t;(!i.focused&&!n.focused||r)&&(i.grabbable=!r,n.grabbable=!r,e.visibilityHandle=Z([i.disableDisplay(),{remove:()=>{i.grabbable=!0,n.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",a),n.events.on("focus-changed",a),{remove:()=>{Ot(e.visibilityHandle),n.metadata.deleting=!0,this.manipulators.remove(n)}}],i),a()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const{coordinateHelper:t}=D(this._editGeometryOperations).data,i=ra(this.view,e.manipulator.elevationAlignedLocation,sa(t,e.handle,D(e.manipulator.elevationInfo))),n=this._getManipulatorInfoFromHandle(e.handle.leftVertex),a=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(_(n)||_(a))return;const o=n.manipulator.renderLocation,s=a.manipulator.renderLocation,r=c(i)?As(i,o,s):to;e.manipulator.modelTransform=r,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=r;const l=we(ot(ye,o,s))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,n,a)=>{this._clearSelection();const{step:o,cleanup:s}=this._initializeEdgeOffset(e,t);n.next(r=>this._trackNumDragging(r)).next(ne(this.view,i.elevationAlignedLocation)).next(o).next(no(this.view)).next(oo(this.view,D(this._editGeometryOperations).data.spatialReference)).next(Yt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(e)).next(this._showEdgeOffsetTooltip()).next(r=>{r.action==="end"&&s()}),a.next(()=>{i.metadata.deleting||(s(),this._onDragCancel())})}}_initializeEdgeOffset(e,t){const i=D(this._editGeometryOperations),n=sa(i.data.coordinateHelper,e.handle,t),a=i.createUndoGroup(),o=ra(this.view,e.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const m=this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge);c(m)&&this._splitEdgeManipulator(m,1)}if(n.requiresSplitEdgeRight){const m=this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge);c(m)&&this._splitEdgeManipulator(m,0)}const s=()=>new un({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:i.data.spatialReference}),r=new Ht({view:this.view,isDraped:this._graphicState.isDraped,geometry:s(),elevationInfo:e.elevationInfo,width:g.visualElements.lineGraphics.outline.width,color:g.colorToVec4(gi.main),attached:!0});let l;const p=()=>{this._cleanEdgeOffsetCollapsedEdges(e),l=Ot(l)},u=this.on("undo",p);return l=Z([Gt(r),G(()=>this._graphicState.isDraped,m=>r.isDraped=m),this._graphicState.on("changed",()=>r.geometry=s()),a,u]),{step:m=>_(n)||_(o)?(p(),null):{...m,operation:n,plane:o},cleanup:p}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||_(t.operation))return t;this._updateEventState(R.RESHAPING);const{mapDeltaX:i,mapDeltaY:n,mapDeltaZ:a}=t;return(i||n||a)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_applyComputeEdgeOffsetDistanceStep(){return e=>{const{operation:t,mapEnd:i}=e;return _(t)||_(i)?e:(e.action==="start"&&t.selectArrowFromStartPoint(i),{...e,signedDistance:t.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return e=>{const{mapEnd:t,signedDistance:i,operation:n}=e,a=this._tooltip,o=this._tooltipOptions;if(!o.enabled||_(i))return a.clear(),e;let s=a.info;(_(s)||s.type!=="reshape-edge-offset")&&(s=a.info=new Dt({tooltipOptions:o}));const{coordinateHelper:r}=D(this._editGeometryOperations).data;return s.distance=e.action==="end"?oe:Ds(this._graphicState.isDraped,i*n.selectedArrow,t,n.plane,r),this._updateTooltipAreaOrTotalLength(s),e}}_cleanEdgeOffsetCollapsedEdges(e){var r,l;const t=(r=e.handle.leftVertex.leftEdge)==null?void 0:r.leftVertex,i=e.handle.leftVertex,n=(l=e.handle.rightVertex.rightEdge)==null?void 0:l.rightVertex,a=e.handle.rightVertex,o=D(this._editGeometryOperations).data.coordinateHelper,s=[];if(t&&o.distance(t.pos,i.pos)<Ke){const p=this._getManipulatorInfoFromHandle(i);c(p)&&s.push(p)}if(o.distance(i.pos,a.pos)<Ke||n&&o.distance(n.pos,a.pos)<Ke){const p=this._getManipulatorInfoFromHandle(a);c(p)&&s.push(p)}s.length&&this._removeVertices(s)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=z(this.graphic),i=!1){var r;if(e.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(_(this._vertexManipulatorGeometry)||_(this._vertexManipulatorOutlineGeometry)){const{size:l,outlineSize:p}=this._computeVertexManipulatorSizeAndOutline(g.reshapeManipulators.vertex);this._vertexManipulatorGeometry=_e(this._vertexManipulatorMaterial,l,16,16),this._vertexManipulatorOutlineGeometry=_e(this._vertexManipulatorOutlineMaterial,p,16,16)}if(_(this._edgeManipulatorGeometry)||_(this._edgeManipulatorOutlineGeometry)){const{size:l,outlineSize:p}=this._computeVertexManipulatorSizeAndOutline(g.reshapeManipulators.edge);this._edgeManipulatorGeometry=_e(this._edgeManipulatorMaterial,l,16,16),this._edgeManipulatorOutlineGeometry=_e(this._edgeManipulatorOutlineMaterial,p,16,16)}const n=c(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[new w(this._vertexManipulatorGeometry.instantiate(),tt.Vertex|E.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate(),tt.Vertex|E.Unfocused|E.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),tt.Vertex|E.Focused|E.Unselected),new w(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),E.Selected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),E.Selected|E.Unfocused),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),E.Selected|E.Focused)];this.enableMidpoints&&n.push(new w(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),tt.Edge|E.Focused|E.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),tt.Edge|E.Focused|E.Unselected),new w(this._edgeManipulatorGeometry.instantiate(),tt.Edge|E.Unfocused|E.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate(),tt.Edge|E.Unfocused|E.Unselected));const a=new K({view:this.view,renderObjects:n,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!((r=this.graphic.layer)!=null&&r.visible)),metadata:{deleting:!1}});a.selected=i,this._setTypeSpecificManipulatorSettings(a,e,t);const o=e.type==="edge"?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(o),this.manipulators.add(a),this._updateManipulatorPosition(o),o.type==="edge"){const l=[];for(const p of[o.handle.leftVertex,o.handle.rightVertex]){const u=this._getManipulatorInfoFromHandle(p);c(u)&&l.push(u.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(o)))}o.locationUpdateHandle=Z(l),this._manipulatorHandles.add(o.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const s=rt(a,(l,p,u,m)=>{let v=null;const{snappingStep:M,cancelSnapping:y}=Ge({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new De({editGeometryOperations:D(this._editGeometryOperations),elevationInfo:t,pointer:m,excludeFeature:this.graphic,visualizer:new re}),updatingHandles:this.updatingHandles,useZ:!1});u=u.next(f=>(this._onDragCancel(!l.metadata.deleting,()=>v=Ot(v)),f)).next(y),p.next(f=>this._trackNumDragging(f)).next(f=>{if(f.action==="start"&&(v=D(this._editGeometryOperations).createUndoGroup()),o.type==="edge"){const b=this._splitEdgeManipulator(o);return{...f,info:b,snapOrigin:b.handle.pos}}return{...f,info:o,snapOrigin:o.handle.pos}}).next(ne(this.view,l.elevationAlignedLocation)).next(so(this.view,this.graphic,l.elevationAlignedLocation,l.location.spatialReference,this.graphic)).next(Ui(this.view,t,this.graphic)).next(...M).next(Yt()).next(f=>{this._perVertexManipulatorDragAction(f),f.action==="end"&&(v=Ot(v)),this._updateTranslateVertexTooltip(l,S.XY,f)})});return this._manipulatorHandles.add([s,a.events.on("immediate-click",l=>this._manipulatorClickCallback(l,o)),a.events.on("select-changed",()=>{o.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:l})=>{l==="focus"&&o.type!=="edge"?this._updateTranslateVertexTooltip(a,S.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),o}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_onDragCancel(e=!0,t){switch(this._numDragging--,e&&(this.undo(),this.outputGeometry=c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null),c(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case R.NONE:break;case R.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case R.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(R.NONE)}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=tt.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=g.reshapeManipulators.vertex.size/2+g.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=c(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":e.state=tt.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=g.reshapeManipulators.edge.size/2+g.reshapeManipulators.edge.collisionPadding,e.elevationInfo=i.mode!=="on-the-ground"||Yi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",i=>this._onGrabStateChanged(e,t,i.action,i.pointerType))}_onGrabStateChanged(e,t,i,n="mouse"){if(!this._recreatingManipulators){if(i==="start")t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(R.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(n!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(a=>{a.manipulator.interactive=a.manipulator.grabbing||!this._numGrabbing&&c(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in a&&(a.edgeManipulator.interactive=a.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(a=>{a.interactive=a.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){_(e)||(e.manipulator.metadata.deleting=!0,this.manipulators.remove(e.manipulator),this._manipulatorHandles.remove(e.manipulator),Xa(this._manipulatorInfos,e),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e){for(const t of this._manipulatorInfos)if(e===t.handle)return t}return null}_updateManipulatorPosition(e){if(_(e))return;const t=D(this._editGeometryOperations);if(e.type==="vertex")e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,ie),e.manipulator.grabbing&&c(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if(e.type==="edge"){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex),n=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(_(i)||_(n))return;const a=i.manipulator,o=n.manipulator;if(c(e.manipulator.elevationInfo)&&e.manipulator.elevationInfo.mode==="on-the-ground"){const s=a.location,r=o.location,l=.5,p=s.x+l*(r.x-s.x),u=s.y+l*(r.y-s.y),m=s.hasZ&&r.hasZ?0:void 0;e.manipulator.location=ce(p,u,m,t.data.spatialReference)}else ja(ye,a.renderLocation,o.renderLocation,.5),e.manipulator.renderLocation=ye}}_splitEdgeManipulator(e,t=.5){const i=D(this._editGeometryOperations),n=D(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle=Ot(e.locationUpdateHandle);const a=z(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(e),o=this._createVertexOrEdgeManipulator(n)):(o=e,o.handle=n,o.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,a)),n.leftEdge&&this._createVertexOrEdgeManipulator(n.leftEdge),n.rightEdge&&this._createVertexOrEdgeManipulator(n.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(o),this.enableEdgeOffset||this._updateTranslateVertexTooltip(o.manipulator,S.XY),this._updateSelection(e.manipulator);const s=this._updateEventState(R.RESHAPING),r=i.data.coordinateHelper.vectorToArray(o.handle.pos),l=i.data.components.indexOf(n.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:D(n.index)}],added:r}),s&&this._updateEventState(R.NONE),o}_updateMoveManipulationPosition(){const e=nt(ye,0,0,0);let t=0,i=!1,n=null,a=null;for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.selected?(t++,Pe(e,e,o.manipulator.renderLocation),_(n)||o.selectedIndex>n.selectedIndex?(a=n,n=o):(_(a)||o.selectedIndex>a.selectedIndex)&&(a=o)):i=!0);if(t===0){const o=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=o,this._moveManipulation.xyAxisManipulation.available=o,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=o,this._moveManipulation.zManipulation.available=o&&this.enableZShape&&zt(this.graphic),this._moveManipulation.angle=Ca(D(this.graphic.geometry)),this._moveManipulation.radius=Ct.radiusForSymbol(this.graphic.symbol)}else{const o=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=o,this._moveManipulation.xyAxisManipulation.available=o,this._moveManipulation.zManipulation.available=o&&this.enableZVertex&&zt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=o&&t!==1;let s=0;if(c(n)){const r=n.handle.pos,l=c(a)?a.handle.pos:n.handle.leftEdge&&n.handle.leftEdge.leftVertex?n.handle.leftEdge.leftVertex.pos:null,p=_(a)&&n.handle.rightEdge&&n.handle.rightEdge.rightVertex?n.handle.rightEdge.rightVertex.pos:null;l&&p?this._moveManipulation.xyAxisManipulation.available=!1:l?s=pa(l,r):p&&(s=pa(r,p))}this._moveManipulation.angle=s,this._moveManipulation.radius=za}t!==0&&i?(Le(e,e,1/t),ie.spatialReference=D(this._editGeometryOperations).data.spatialReference,ie.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,ie),this._moveManipulation.elevationAlignedLocation=ie):c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:wa(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){var n;const t=new Array,i=D(this._editGeometryOperations);for(const a of e)if(a.type==="vertex"&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const o=i.removeVertices([a.handle]),s=D((n=o.removedVertices)==null?void 0:n[0].createdEdge);s&&this._createVertexOrEdgeManipulator(s)}if(t.length>0){const a=t.map(s=>{const r=i.data.components.indexOf(s.component);return{coordinates:i.data.coordinateHelper.vectorToArray(s.pos),componentIndex:r,vertexIndex:D(s.index)}});this.outputGeometry=i.data.geometry;const o=this._updateEventState(R.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(s=>s.coordinates),vertices:a}),this.destroyed)||o&&(this._updateEventState(R.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=t.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS){const n=D(this._editGeometryOperations);n.moveVertices(e.map(a=>a.handle),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=n.data.geometry;for(const a of e)this._updateManipulatorPosition(a)}_offsetEdge(e,t){if(_(t.operation)||_(t.signedDistance))return;const i=D(this._editGeometryOperations),n=t.operation.clone();n.distance=t.signedDistance,i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],n),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),t.type==="vertex"&&(t.manipulator.selected=!t.manipulator.selected,e.button===Gi.Right&&this._removeVertices([t])),t.type==="edge"&&e.button===Gi.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}_updateTranslateTooltip(e,t){const i=this._manipulatorInfos.filter(n=>n.type==="vertex"&&n.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,e,t):this._updateTranslateGraphicTooltip(e,t)}_updateTranslateGraphicTooltip(e,t){const i=this._tooltipOptions;if(!i.enabled)return;const n=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case S.XY:this._tooltip.info=new pe({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,(a,o)=>xt(a,o,n));break;case S.XY_AXIS:this._tooltip.info=new yi({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,(a,o)=>{const s=xt(a,o,n);return Ee(s,Ie(t))});break;case S.Z:this._tooltip.info=new Ze({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,Re)}}_updateTranslateVertexTooltip(e,t,i){const n=this._tooltipOptions;if(!n.enabled)return;let a;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:a=new yo({tooltipOptions:n}),this._updateTranslateTooltipDistance(a,i,(r,l)=>xt(r,l,o)),this._updateTooltipAreaOrTotalLength(a);break;case S.XY_AXIS:a=new fo({tooltipOptions:n}),this._updateTranslateTooltipDistance(a,i,(r,l)=>{const p=xt(r,l,o);return Ee(p,Ie(i))}),this._updateTooltipAreaOrTotalLength(a);break;case S.Z:a=new vo({tooltipOptions:n}),this._updateTranslateTooltipDistance(a,i,Re)}const s=Mo(e.elevationAlignedLocation);c(s)&&(a.elevation={mode:"absolute-height",...s}),this._tooltip.info=a}_updateTranslateTooltipDistance(e,t,i){if(c(t)&&t.action!=="end"){const{mapStart:n,mapEnd:a}=t,o=i(n,a);e.distance=c(o)?o:oe}}_updateTooltipAreaOrTotalLength(e){const{geometry:t}=this.graphic;if(_(t))return;const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";e.area=t.type==="polygon"?Oo(t,i):null,e.totalLength=t.type==="polyline"?vn(t,i):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function pa(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Ds(e,t,i,n,a){if(e){const o=a.toXYZ(a.pointToVector(i)),s=Eo(n,o,$.get()),r=fn(s,o,a.spatialReference);if(c(r))return se(r.value*Math.sign(t),r.unit)}return se(t*ri(i.spatialReference),"meters")}h([d()],L.prototype,"_editGeometryOperations",void 0),h([d()],L.prototype,"_segmentLabels",void 0),h([d({constructOnly:!0})],L.prototype,"tool",void 0),h([d()],L.prototype,"_tooltip",void 0),h([d()],L.prototype,"inputGeometry",null),h([d()],L.prototype,"outputGeometry",void 0),h([d({readOnly:!0})],L.prototype,"updating",null),h([d()],L.prototype,"manipulators",null),h([d()],L.prototype,"view",null),h([d()],L.prototype,"graphic",null),h([d()],L.prototype,"enableZShape",null),h([d()],L.prototype,"enableZVertex",null),h([d()],L.prototype,"enableMoveGraphic",null),h([d()],L.prototype,"enableMidpoints",null),h([d()],L.prototype,"enableEdgeOffset",null),h([d()],L.prototype,"_labelOptions",null),h([d()],L.prototype,"_tooltipOptions",null),L=h([C("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],L);const ie=ce(0,0,void 0,So.WGS84),ye=V(),Ke=1e-6;var tt,R,Ft;(function(e){e.Vertex=yt.Custom1,e.Edge=yt.Custom2})(tt||(tt={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(R||(R={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Ft||(Ft={}));let U=class extends dt.EventedMixin(Ue){constructor(e){super(e),this._handles=new Wt,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Ma,this.tooltipOptions=new Rt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const e=this._reshapeOperation=new L({tool:this});this.addHandles([e.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),e.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),e.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),e.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),e.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>t.stopPropagation()),G(()=>this.graphic,()=>this._updateGraphic(),ci)]),this.finishToolCreation()}destroy(){this._handles=P(this._handles),this._reshapeOperation=P(this._reshapeOperation)}get updating(){var e;return((e=this._reshapeOperation)==null?void 0:e.updating)??!1}_updateGeometry(){const e=Tn(this.graphic);this._reshapeOperation.inputGeometry=c(e)?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),Dn(this.graphic)!==ya.SUPPORTED)return;const e=G(()=>{var t;return(t=this.graphic)==null?void 0:t.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},xe);this._handles.add(e,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0,this.graphic.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:e}=this._reshapeOperation;!_(this.graphic)&&e&&this._updateGeometryInternally(e.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping();const e=this._reshapeOperation.undo(),{outputGeometry:t}=this._reshapeOperation;e&&t&&this._updateGeometryInternally(t.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){c(this.snappingManager)&&this.snappingManager.doneSnapping();const e=this._reshapeOperation.redo(),{outputGeometry:t}=this._reshapeOperation;e&&t&&this._updateGeometryInternally(t.clone())}onInputEvent(e){e.type!=="key-down"||e.key!=="Delete"&&e.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};h([d()],U.prototype,"_reshapeOperation",void 0),h([d({constructOnly:!0,nonNullable:!0})],U.prototype,"view",void 0),h([d({constructOnly:!0})],U.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZShape",void 0),h([d({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZVertex",void 0),h([d({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMoveGraphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMidpoints",void 0),h([d({constructOnly:!0,nonNullable:!0})],U.prototype,"enableEdgeOffset",void 0),h([d()],U.prototype,"type",void 0),h([d({constructOnly:!0,type:Ma})],U.prototype,"labelOptions",void 0),h([d({constructOnly:!0,type:Rt})],U.prototype,"tooltipOptions",void 0),h([d({constructOnly:!0})],U.prototype,"snappingManager",void 0),h([d()],U.prototype,"updating",null),h([d()],U.prototype,"automaticManipulatorSelection",void 0),U=h([C("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],U);let gt=class extends ze{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};h([d()],gt.prototype,"type",void 0),h([d()],gt.prototype,"rotation",void 0),h([d()],gt.prototype,"rotationPrecision",void 0),h([d()],gt.prototype,"orientation",void 0),h([d()],gt.prototype,"orientationPrecision",void 0),h([d()],gt.prototype,"rotationType",void 0),gt=h([C("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],gt);let At=class extends ze{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};h([d()],At.prototype,"type",void 0),h([d()],At.prototype,"scale",void 0),h([d()],At.prototype,"size",void 0),h([d()],At.prototype,"sizeUnit",void 0),h([d()],At.prototype,"sizePrecision",void 0),At=h([C("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],At);let J=class extends ze{constructor(e){super(e),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};h([d()],J.prototype,"type",void 0),h([d()],J.prototype,"orientation",void 0),h([d()],J.prototype,"orientationEnabled",void 0),h([d()],J.prototype,"orientationPrecision",void 0),h([d()],J.prototype,"rotationType",void 0),h([d()],J.prototype,"size",void 0),h([d()],J.prototype,"sizeUnit",void 0),h([d()],J.prototype,"sizeEnabled",void 0),h([d()],J.prototype,"sizePrecision",void 0),J=h([C("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],J);var O,qt;(function(e){e.ScaleIn=yt.Custom2,e.ScaleOut=yt.Custom3,e.RotateLeft=yt.Custom4,e.RotateRight=yt.Custom5,e.Unlocked=yt.Custom7,e.DelayedFocused=yt.Custom8,e.TouchInput=yt.Custom12})(O||(O={}));class Gs{get angle(){return this._adapter.angle}get scale(){return this._adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}constructor({adapter:t,tooltipOptions:i,mode:n,tool:a}){this._mode=null,this._handles=new Wt,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=_s,this.events=new dt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this._adapter.scale:1,this.tool=a,this._mode=n,this._adapter=t,this._tooltipOptions=i,this._tooltip=new he({view:a.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(Bt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),St))}destroy(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=P(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=P(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const i=Na({update:({deltaTime:n})=>{t.update(n)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:i}}cancelActiveAnimation(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=P(this._activeAnimation))}forEachManipulator(t){t(this._ringManipulator,T.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const i=this.tool.graphicState.graphic,n=rt(t,(a,o,s)=>{this._scaleRotateDragData=null;const r=this._adapter.startInteraction(),l={mode:"none",origin:ga(a.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const p=$.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,p),o.next(si(this.tool.view,$a(a.renderLocation,p,Mi()))).next(u=>{const m=de(u.plane),v=Ea(u.renderStart,u.renderEnd,l.origin,m),M=Ao.shortestSignedDiff(l.angle,v);l.angleDir=oi(l.angleDir+M,-ia,ia),l.angle=v;const y=Rs(l,u),f=y-this._adapter.scale;if(l.scaleDir=oi(l.scaleDir+f,-ea,ea),this._onScaleChanged(),l.mode==="none"){const b=this._mode||$s(u,u.plane,l.origin,this.tool.view.state.camera);if(c(b)){switch(b){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=b}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+v;break;case"scale":r.state.scale=y,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),u.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:le(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:y,yScale:y})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:le(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:y,yScale:y})}}return u.action==="end"&&(this.startAnimation(ha(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),r.done()),u}).next(this._updateTooltipPipelineStep(l)),s.next(()=>{if(r.cancel(),c(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(ha(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([n,t.events.on("focus-changed",a=>{a.action==="focus"?this.startAnimation(Is(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),t.events.on("immediate-click",a=>{a.stopPropagation()}),G(()=>{var a;return(a=this.tool.graphicState)==null?void 0:a.displaying},a=>this._ringManipulator.available=a,St)])}_updateTooltipPipelineStep(t){return i=>{const n=this._tooltipOptions;if(!n.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const a=this._tooltip,o=this._tooltipOptions.visualVariables,s=c(o)?o.size:null,r=c(o)?o.rotation:null;switch(t.mode){case"scale":a.info=new At({tooltipOptions:n,scale:{value:this._adapter.scale},size:se(it(this._adapter.size,-1),"meters"),sizeUnit:c(s)?s.unit:null,sizePrecision:c(s)?be(s.valueType):null});break;case"rotate":{const l=c(r)?be(r.valueType):null,p=c(r)?r.rotationType:"geographic";a.info=new gt({tooltipOptions:n,rotation:je(it(-this._adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:je(-this._adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:p})}}return i}}_updateFocusTooltip(){if(this._tooltipOptions.enabled)if(this.getFocused()){const t=this._tooltipOptions.visualVariables,i=c(t)?t.rotation:null,n=c(t)?t.size:null;this._tooltip.info=new J({tooltipOptions:this._tooltipOptions,orientation:je(-this._adapter.angle,"radians","geographic"),orientationEnabled:this._mode==null||this._mode==="rotate",orientationPrecision:c(i)?be(i.valueType):null,rotationType:c(i)?i.rotationType:"geographic",size:se(it(this._adapter.size,-1),"meters"),sizeUnit:c(n)?n.unit:null,sizeEnabled:this._mode==null||this._mode==="scale",sizePrecision:c(n)?be(n.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(O.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(O.Unlocked,!(c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),c(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut,!1),this._ringManipulator.updateStateEnabled(O.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(O.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(O.RotateLeft|O.RotateRight,!1),this._ringManipulator.updateStateEnabled(O.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(O.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut|O.RotateLeft|O.RotateRight,!1)}_updateManipulatorTransform(){const t=Ta(q.get(),this._adapter.angle,k(0,0,1));if(_(t))return;const i=this.getScale(),n=Te(q.get(),nt($.get(),i,i,i));this._ringManipulator.modelTransform=Se(q.get(),n,t)}_createRingManipulator(){const t=(A,lt,pt)=>{const wt=[],Et=Math.ceil(La*(lt-A)/(2*Math.PI));for(let N=0;N<Et+1;N++){const Kt=A+N*(lt-A)/Et;wt.push(k(pt*Math.cos(Kt),pt*Math.sin(Kt),0))}return wt},i=A=>t(0,2*Math.PI,A),n=A=>[[-A/2,0],[A/2,0],[A/2,We/2],[-A/2,We/2]],a=this._createMaterial(1),o=(A,lt,pt=a)=>Gn(pt,n(lt),A,[],[],!1),s=i(Lt),r=o(s,Je),l={left:new Array,right:new Array},p=[];for(let A=0;A<2;A++){const lt=A*Math.PI-Math.PI/4,pt=Math.PI/2-ms,wt=lt+pt,Et=lt+Math.PI/2-pt,N=t(wt,Et,cs),Kt=o(N,Zt);p.push(N),p.push(t(wt,Et,Wi-Je/2)),l.left.push(Kt),l.right.push(Kt.instantiate());for(let Fe=0;Fe<2;Fe++){const xi=Fe===0,F=Ne();if(xi){Da(F,F,[1,-1,1]),Ci(F,F,-wt,[0,0,1]);const It=Math.round(Ki*(N.length-1));F[12]=N[It][0],F[13]=N[It][1],F[14]=N[It][2]}else{Ci(F,F,Et,[0,0,1]);const It=Math.round((1-Ki)*(N.length-1));F[12]=N[It][0],F[13]=N[It][1],F[14]=N[It][2]}const wi=Oe(a,ds,0,us,We);fa(wi,F),(xi?l.left:l.right).push(wi)}}const u=[];for(let A=0;A<2;A++){const lt=A*Math.PI-Math.PI/4,pt=Math.PI/2-gs,wt=lt+pt,Et=lt+Math.PI/2-pt,N=t(wt,Et,Wi);u.push(o(N,Zt))}const m=this._createMaterial(.66),v=this._createMaterial(.5),M=this._createMaterial(.33),y=i(Lt+Qi),f=i(Lt+ta),b=o(y,Zt,m),x=o(f,Zt,M),I=i(Lt-Qi),H=i(Lt-ta),$t=o(I,Zt,m),Y=o(H,Zt,M);let ut=[new w(r,O.DelayedFocused),new w(r.instantiate({material:v}),E.None)];this._mode&&this._mode!=="scale"||(ut=ut.concat([...u.map(A=>new w(A,O.DelayedFocused|O.Unlocked)),new w(b,O.DelayedFocused|O.ScaleIn),new w(x,O.DelayedFocused|O.ScaleIn),new w($t,O.DelayedFocused|O.ScaleOut),new w(Y,O.DelayedFocused|O.ScaleOut)])),this._mode&&this._mode!=="rotate"||(ut=ut.concat([...l.right.map(A=>new w(A.instantiate(),O.DelayedFocused|O.Unlocked)),...l.left.map(A=>new w(A,O.DelayedFocused|O.RotateLeft)),...l.right.map(A=>new w(A,O.DelayedFocused|O.RotateRight))]));const me=[s,...p];return new K({view:this.tool.view,renderObjects:ut,autoScaleRenderObjects:!1,worldOriented:!0,radius:Je,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:z(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:me,direction:k(0,0,1)}})}_createMaterial(t){const i=To([...rs,t]);return new ui({color:i,transparent:t!==1,cullFace:fi.Back,renderOccluded:st.Transparent})}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}}function Rs(e,t){const i=ot($.get(),t.renderStart,e.origin),n=ot($.get(),t.renderEnd,e.origin),a=we(i),o=we(n);return a===0?0:o/a}function $s(e,t,i,n){const{renderStart:a,renderEnd:o}=e,s=Me(a,n,$.get()),r=Me(o,n,$.get());if(qa(s,r)<Ji*Ji)return null;const l=ot($.get(),a,i),p=jt($.get(),l,de(t)),u=a,m=Pe($.get(),u,p),v=Me(i,n,$.get()),M=s,y=Me(m,n,$.get()),f=ot($.get(),y,M),b=ot($.get(),s,v),x=Hi(M,f),I=Hi(v,b);return Ni(x,r)<Ni(I,r)?"rotate":"scale"}function Me(e,t,i){return t.projectToScreen(e,Qe),nt(i,Qe[0],Qe[1],0)}function ha(e,t){let i=null,n=1;const a=()=>n;return{start:()=>{n=e.getScale(),i=e.getScale,e.getScale=a,t()},update:o=>(n+=((n+1)/2-n)*Math.min(o*vs,1),t(),Math.abs(n-1)<.01?qt.STOP:qt.CONTINUE),destroy:()=>{i&&(e.getScale=i),t()}}}function Is(e,t,i){let n=0,a=null;const o=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=o,n=0,t()},update:s=>(n+=s,!(a!=null&&a())||n>=i.delayMs?qt.STOP:qt.CONTINUE),destroy:()=>{a&&(e.getFocused=a),t()}}}function be(e){switch(e){case"integer":case"long":return 0;default:return null}}(function(e){e[e.CONTINUE=0]="CONTINUE",e[e.STOP=1]="STOP"})(qt||(qt={}));const Qe=Ve();function Ha(e){return c(e.geometry)&&e.geometry.type==="mesh"?Ps(e.geometry):Ls(e)}function Ps(e){return c(e.transform)?Vs(e,e.transform):zs(e)}function Ls(e){let t=e.geometry,i=Za;return{undo(n){i=n.geometry,n.geometry=t},redo(n){t=n.geometry,n.geometry=i}}}function Vs(e,t){let i=t.clone(),n=null;return{undo:a=>{n=c(e.transform)?e.transform.clone():null,e.transform=i,a.notifyGeometryChanged()},redo:a=>{i=c(e.transform)?e.transform.clone():null,e.transform=n,a.notifyGeometryChanged()}}}function zs(e){let t,i=e.vertexAttributes.clonePositional();return{undo:n=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,n.notifyGeometryChanged()},redo:n=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,n.notifyGeometryChanged()}}}let _t=class extends _i{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([Bt(()=>c(this._interactionState)&&this._interactionState.angle!==this._interactionState.previousAngle?{interactionState:this._interactionState,angle:this._interactionState.state.angle}:null,({interactionState:t})=>{this._updateMeshRotation(t)},xe),Bt(()=>c(this._interactionState)&&this._interactionState.scale!==this._interactionState.previousScale?{interactionState:this._interactionState,scale:this._interactionState.state.scale}:null,({interactionState:t})=>{this._updateMeshSize(t)},xe)])}get angle(){const t=this.geometry.transform;if(_(t))return 0;const i=Do(t.rotation)[2];return Math.abs(i)>.999999?He(Go(t.rotation))*Math.sign(i):0}get scale(){return c(this._interactionState)?this._interactionState.scale:1}startInteraction(){const t=new vt({angle:this.angle});this._interactionState=t;const i=()=>{this._interactionState=null};return{state:t,done:i,cancel:()=>{t.cancel(),i()}}}createUndoRecord(){return Ha(this.graphic)}_updateMeshRotation(t){const i=this.geometry.anchor,n=this.viewingMode===li.Global,{angle:a,previousAngle:o}=t;this.geometry.rotate(0,0,le(a-o),{origin:i,geographic:n}),t.previousAngle=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const i=this.geometry.anchor,n=this.viewingMode===li.Global,{scale:a,previousScale:o}=t;this.geometry.scale(a/o,{origin:i,geographic:n}),t.previousScale=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};h([d({constructOnly:!0})],_t.prototype,"graphic",void 0),h([d({constructOnly:!0})],_t.prototype,"geometry",void 0),h([d({constructOnly:!0})],_t.prototype,"viewingMode",void 0),h([d()],_t.prototype,"angle",null),h([d()],_t.prototype,"scale",null),h([d()],_t.prototype,"_interactionState",void 0),_t=h([C("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],_t);let vt=class extends hi{get state(){const{angle:t,scale:i}=this;return{angle:t,scale:i}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};h([d()],vt.prototype,"angle",void 0),h([d()],vt.prototype,"initialAngle",void 0),h([d()],vt.prototype,"previousAngle",void 0),h([d()],vt.prototype,"previousScale",void 0),h([d()],vt.prototype,"scale",void 0),h([d()],vt.prototype,"state",null),vt=h([C("InteractionState")],vt);let X=class extends _i{constructor(e){super(e),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Bt(()=>c(this._interactionState)?this._interactionState.state:null,e=>{this._updateSymbol(e)},xe))}get angle(){return c(this._interactionState)?this._interactionState.angle:c(this._orientationReferenceSymbolLayer)?Cs(this._orientationReferenceSymbolLayer.heading??0):0}get scale(){return c(this._interactionState)?this._interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return c(this._interactionState)?this._interactionState.initialAngle:0}get size(){const e=this._sizeReferenceSymbolLayer;if(_(e))return null;const t=this.findLayerView(),i=this._graphicSymbol;if(_(t)||_(i)||i.type!=="point-3d")return null;const n=t.getSymbolLayerSize(i,e);if("size"in n&&c(n.size))return n.size;const a=this.sizeAxis;return"width"in n&&c(n.width)&&(_(a)||a==="width"||a==="all"||a==="width-and-depth")?n.width:"depth"in n&&c(e.depth)&&(_(a)||a==="depth"||a==="all"||a==="width-and-depth")?n.depth:"height"in n&&c(e.height)&&(_(a)||a==="height"||a==="all")?n.height:null}get _sizeReferenceSymbolLayer(){const e=this._graphicSymbol;return _(e)||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const e=this._graphicSymbol;return _(e)||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object"&&c(t.heading))}get _graphicSymbol(){return c(this.graphic)&&c(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(e){this.graphic.symbol=e}startInteraction(){const e=this._graphicSymbol,t=this.findLayerView();if(c(this._interactionState)||_(e)||_(t))return Hs;const i=e.symbolLayers.map(r=>r.type==="object"?t.getSymbolLayerSize(e,r):null).toArray(),n=e.clone(),a=this.angle,o=new ft({originalSymbol:n,angle:a,initialSizes:i});this._interactionState=o;const s=()=>{this._interactionState=null};return{state:o,done:s,cancel:()=>{this._graphicSymbol=n,s()}}}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e},redo:i=>{e=i.symbol,i.symbol=t}}}_updateSymbol({scale:e,angle:t,originalSymbol:i,initialSizes:n}){const a=this._graphicSymbol;if(_(a)||a.type!=="point-3d")return;const o=a.clone(),s=-le(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,o,(l,p,u)=>{const m=it(l.heading,0)+s;p.heading!==m&&(p.heading=m,r=!0);const v=n[u];if(c(v)&&"width"in v){v.width=this.sizeFilter(v.width),v.height=this.sizeFilter(v.height),v.depth=this.sizeFilter(v.depth);const M=v.width*e;p.width!==M&&(p.width=M,r=!0);const y=v.depth*e;p.depth!==y&&(p.depth=y,r=!0);const f=v.height*e;p.height!==f&&(p.height=f,r=!0)}}),r&&(this._graphicSymbol=o)}_forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach((n,a)=>{const o=t.symbolLayers.getItemAt(a);n.type==="object"&&o.type==="object"&&i(n,o,a)})}};function Cs(e){return-He(e)}h([d()],X.prototype,"angle",null),h([d()],X.prototype,"scale",null),h([d()],X.prototype,"relativeAngle",null),h([d()],X.prototype,"initialAngle",null),h([d()],X.prototype,"size",null),h([d()],X.prototype,"sizeAxis",void 0),h([d({constructOnly:!0})],X.prototype,"graphic",void 0),h([d()],X.prototype,"_interactionState",void 0),h([d({constructOnly:!0})],X.prototype,"findLayerView",void 0),h([d({constructOnly:!0})],X.prototype,"sizeFilter",void 0),h([d()],X.prototype,"_sizeReferenceSymbolLayer",null),h([d()],X.prototype,"_orientationReferenceSymbolLayer",null),h([d()],X.prototype,"_graphicSymbol",null),X=h([C("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],X);const Hs={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let ft=class extends hi{get state(){const{originalSymbol:e,angle:t,initialAngle:i,scale:n,initialSizes:a}=this;return{originalSymbol:e,angle:t,initialAngle:i,scale:n,initialSizes:a}}constructor(e){super(e),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=e.angle}};h([d()],ft.prototype,"originalSymbol",void 0),h([d()],ft.prototype,"angle",void 0),h([d()],ft.prototype,"initialAngle",void 0),h([d()],ft.prototype,"initialSizes",void 0),h([d()],ft.prototype,"scale",void 0),h([d()],ft.prototype,"state",null),ft=h([C("InteractionState")],ft);let B=class extends xa(dt.EventedMixin(Ue)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Rt,this.type="transform-3d",this._scaleRotate=null,this._tooltip=null}initialize(){const{graphic:e,view:t}=this;this.graphicState=new W({graphic:e}),this.addHandles(G(()=>this.tooltipOptions.enabled,a=>{this._tooltip=a?new he({view:t}):P(this._tooltip)},ci)),this._moveManipulation=new Ct({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&zt(e),radius:Ct.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(a=>this.handles.add(a.events.on("immediate-click",o=>{this.emit("immediate-click",{...o,graphic:e}),o.stopPropagation()})));const i=a=>o=>{this.handles.add(o.events.on("focus-changed",({action:s})=>{const r=this._tooltip;_(r)||(s==="focus"?this._updateMoveTooltip(a):r.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(S.Z)),this._moveManipulation.elevationInfo=z(e);const n=e.geometry;if(this._moveManipulation.createGraphicDragPipeline((a,o,s,r,l)=>{if(c(n)&&a===S.XY){const{snappingStep:p,cancelSnapping:u}=Ge({snappingContext:new De({elevationInfo:z(e),pointer:l,editGeometryOperations:Xe.fromGeometry(new xo({spatialReference:n.spatialReference}),t.state.viewingMode),visualizer:new re,excludeFeature:e}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,useZ:!1});r=r.next(u),s=s.next(...p)}return{steps:s=s.next(p=>(this._updateMoveTooltip(a,p),p)),cancel:r}},this.graphicState,a=>{const{action:o,graphic:s,dxScreen:r,dyScreen:l}=a,p={graphic:s,dxScreen:r,dyScreen:l};switch(o){case"start":this.emit("graphic-translate-start",p),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",p);break;case"end":this.emit("graphic-translate-stop",p)}}),this._moveManipulation.angle=c(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(G(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const a=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Gs({tool:this,mode:a,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([ke({view:this.view,graphic:this.graphic,forEachManipulator:a=>this._forEachManipulator(a),onManipulatorsChanged:()=>Vt()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),G(()=>t.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(a=>{a instanceof K&&this.handles.add(a.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=P(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=P(this._scaleRotate),this._scaleRotateAdapter=P(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){_(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return c(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new _t({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new X({graphic:this.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find(e=>e.layer===this.graphic.layer),sizeAxis:c(this.tooltipOptions.visualVariables)&&c(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(e){this._moveManipulation.forEachManipulator(e),c(this._scaleRotate)&&this._scaleRotate.forEachManipulator(e)}_hideManipulatorsForGraphicState(){return G(()=>this.graphicState.displaying,e=>{this._forEachManipulator(t=>t.available=e),this._moveManipulation.zManipulation.available=e&&this.enableZ&&zt(this.graphic)})}_createGeometryUndoRecord(){return Ha(this.graphic)}set snapToScene(e){this._moveManipulation&&(this._moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this._moveManipulation.location=e,c(this._scaleRotate)&&(this._scaleRotate.location=e)}set elevationAlignedLocation(e){this._moveManipulation.elevationAlignedLocation=e,c(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=e)}reset(){}onHide(){c(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(_(this._scaleRotate))return;const e=this._scaleRotate.getScale();this._moveManipulation.displayScale=e}_updateMoveAngle(){this.view.state.viewingMode===li.Local||this.view.scale<fs?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){wa(this.view,this,this.graphic)}_enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(e,t){const{tooltipOptions:i,_tooltip:n}=this;if(_(n))return;n.clear();const a=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case S.XY:n.info=new pe({tooltipOptions:i}),this._updateMoveTooltipDistance(n.info,t,(o,s)=>xt(o,s,a));break;case S.XY_AXIS:n.info=new yi({tooltipOptions:i}),this._updateMoveTooltipDistance(n.info,t,(o,s)=>{const r=xt(o,s,a);return Ee(r,Ie(t))});break;case S.Z:n.info=new Ze({tooltipOptions:i}),this._updateMoveTooltipDistance(n.info,t,Re)}}_updateMoveTooltipDistance(e,t,i){if(c(t)&&t.action!=="end"){const{mapStart:n,mapEnd:a}=t,o=i(n,a);e.distance=c(o)?o:oe}}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:c(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:e=>c(this._scaleRotate)?this._scaleRotate.test.setRingIndicatorDelayMs(e):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"enableZ",void 0),h([d()],B.prototype,"enableRotation",void 0),h([d()],B.prototype,"enableScaling",void 0),h([d({constructOnly:!0,type:Rt})],B.prototype,"tooltipOptions",void 0),h([d()],B.prototype,"graphicState",void 0),h([d({value:!1})],B.prototype,"snapToScene",null),h([d({constructOnly:!0})],B.prototype,"snappingManager",void 0),h([d({readOnly:!0})],B.prototype,"type",void 0),h([d({readOnly:!0})],B.prototype,"updating",null),B=h([C("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],B);class Ns{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&c(this._lastDragEvent)&&c(this._next)){const i={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(i),this._next.execute(i)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new Ra;return this._next=t,[i=>(this._lastDragEvent=i.action!=="end"?{...i}:null,this._enabled&&this._adjustScaleFactors(i),i),t]}_adjustScaleFactors(t){const i=Ia(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-i:i,t.factor2=t.factor2<0?-i:i}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let j=class extends dt.EventedMixin(Ue){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Rt,this._preserveAspectRatio=new Ns,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this._handles=new Wt,this._attachmentOrigin=null,this._outlineVisualElement=null,this._mapBounds=ve(),this._mapBoundsStart=ve(),this._zmax=0,this._sizeStart=null,this._displayBounds=ve(),this._displayBoundsStart=ve(),this._displayBoundsMarginStart=0,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=ae(),this._endScale=ae()}initialize(){const{view:e,graphic:t,manipulators:i,_handles:n}=this,a=this._graphicState=new W({graphic:t}),o=t.geometry;this._editGeometryOperations=Xe.fromGeometry(o,e.state.viewingMode),this._graphicMoveManipulation=new Si({tool:this,view:e,graphicState:a}),this._moveZManipulator=Ro(e,$o.CENTER_ON_CALLOUT),this._moveZManipulator.state|=Io,n.add([this._createMoveXYGraphicDragPipeline(),G(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._moveZManipulator,T.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this._moveZManipulator),this._resizeManipulators=this._resizeHandles.map(u=>{const m=Po(e,u);return n.add([G(()=>this.enableScaling,()=>this._updateManipulatorAvailability(m,T.SCALE)),m.events.on("grab-changed",v=>this._onResizeGrab(v)),this._createResizeDragPipeline(m,u)]),m}),i.addMany(this._resizeManipulators),this._rotateManipulatorTexture=ro(e.toolViewManager.textures),this._rotateManipulator=jn(e,{texture:this._rotateManipulatorTexture.texture}),n.add([G(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._rotateManipulator,T.ROTATE)),this._rotateManipulator.events.on("grab-changed",u=>{this._onRotateGrab(u)}),this._createRotateDragPipeline(this._rotateManipulator)]),i.add(this._rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const s=ke({view:e,graphic:t,forEachManipulator:u=>this._forEachManipulator(u),onManipulatorsChanged:()=>Vt()});c(s)&&(this._outlineVisualElement=s.visualElement instanceof Ht?s.visualElement:null),c(this._outlineVisualElement)&&n.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),n.add(s),n.add([a.on("changed",()=>this._onGeometryChanged()),G(()=>a.displaying,()=>this._updateAllManipulatorAvailability()),G(()=>a.isDraped,()=>this._graphicDrapedChanged(),St),e.trackGraphicState(a)]);const r=e.pointsOfInterest;n.add(G(()=>r==null?void 0:r.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=u=>{n.add(u.events.on("grab-changed",()=>{this.grabbing=u.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const p=(u,m)=>{n.add(u.events.on("immediate-click",v=>{m===T.TRANSLATE_XY&&this.emit("immediate-click",{...v,graphic:t}),v.stopPropagation()}))};this._forEachManipulator(p),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._mapBounds=null,this._displayBounds=null,this._rotateManipulatorTexture.release(),this._handles.destroy(),this._graphicMoveManipulation.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{_handles:e,view:t}=this,i=this._tooltip=new he({view:t}),n=()=>{i.info=this._getUpdatedTooltipInfo()};e.add([this.on("graphic-translate-start",n),this.on("graphic-translate",n),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",a=>{this._startAngle=a.angle,n()}),this.on("graphic-rotate",a=>{this._endAngle=a.angle,n()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,n()}),this.on("graphic-scale-start",a=>{Tt(this._startScale,a.xScale,a.yScale),Tt(this._endScale,a.xScale,a.yScale),n()}),this.on("graphic-scale",a=>{Tt(this._endScale,a.xScale,a.yScale),n()}),this.on("graphic-scale-stop",()=>{Tt(this._startScale,0,0),Tt(this._endScale,0,0),n()})]),this._forEachManipulator(a=>{e.add([a.events.on("focus-changed",n),a.events.on("grab-changed",n),a.events.on("drag",o=>{o.action==="cancel"?this._tooltip.clear():n()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._graphicMoveManipulation.grabbing||this._graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this._moveZManipulator.focused?this._computeMoveZTooltipInfo():this._rotateManipulator.focused?this._computeRotateTooltipInfo():this._resizeManipulators.some(e=>e.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=it(this._moveXYTooltipInfo,()=>new pe({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const e=this._moveZTooltipInfo=it(this._moveZTooltipInfo,()=>new Ze({tooltipOptions:this.tooltipOptions})),t=this._moveUnit;if(this._moveZManipulator.dragging){const i=this._mapBoundsStart.origin,n=this._mapBounds.origin,a=bo(i,n,this.view.spatialReference);if(_(a))return null;e.distance=a}else e.distance=se(0,t);return e}_computeRotateTooltipInfo(){const e=this._rotateTooltipInfo=it(this._rotateTooltipInfo,()=>new Xo({tooltipOptions:this.tooltipOptions}));return e.angle=this._startAngle-this._endAngle,e}_computeScaleTooltipInfo(){const e=this.graphic.geometry;if(_(e))return null;const t=this._scaleTooltipInfo=it(this._scaleTooltipInfo,()=>new Zo({tooltipOptions:this.tooltipOptions})),i=Li(this._mapBounds,this._zmax,e.spatialReference,this._graphicState.isDraped);return _(i)?null:(t.xSize=i[0],t.ySize=i[1],c(this._sizeStart)&&this._resizeManipulators.some(n=>n.dragging)?(t.xScale=i[0].value/this._sizeStart[0].value,t.yScale=i[1].value/this._sizeStart[1].value):(t.xScale=1,t.yScale=1),t)}_graphicDrapedChanged(){this._handles.remove(ca),this._updateDisplayBounds(),this._graphicState.isDraped&&this._handles.add(this.view.elevationProvider.on("elevation-change",e=>{c(this._attachmentOrigin)&&Oa(e.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._updateDisplayBounds()}),ca)}_updateAllManipulatorAvailability(){this._forEachManipulator((e,t)=>this._updateManipulatorAvailability(e,t))}_updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof K){const n=this._graphicState.displaying,a=this.enableZ&&zt(this.graphic);switch(t){case T.ROTATE:e.available=n&&this.enableRotation;break;case T.SCALE:e.available=n&&(this.enableScaling||this.enableRotation||a),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?Lo:Vo;break;case T.TRANSLATE_Z:e.available=n&&a;break;default:e.available=n}}}_forEachManipulator(e){this._graphicMoveManipulation.forEachManipulator(e),this._resizeManipulators.forEach(t=>e(t,T.SCALE)),e(this._rotateManipulator,T.ROTATE),e(this._moveZManipulator,T.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}get _moveUnit(){return it(wo(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const e=this.graphic.geometry,t=this._editGeometryOperations.data,i=t.components[0].edges[0],n=hn(eo.get(),i.leftVertex.pos,i.rightVertex.pos);ai(n,n);const a=it(ni(this.view,this.graphic),()=>{var l;return(l=e.extent)==null?void 0:l.center});let o=a?Xs*this.view.pixelSizeAt(a):0;const s=this.view.spatialReference,r=e.spatialReference;s.equals(r)||(o*=ri(s)/ri(r)),Yn(n,t,o,this._mapBounds),this._updateZMax()}_updateZMax(){const e=this._editGeometryOperations.data;if(!e.geometry.hasZ)return void(this._zmax=0);const t=e.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const n of e.components)for(const a of n.vertices){const o=t.getZ(a.pos)??0;i=Math.max(o,i)}this._zmax=i}_updateDisplayBounds(){const{geometry:e}=this.graphic;if(_(e))return;const{extent:t}=e;if(!t)return;const i=c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._outlineVisualElement.attachmentOrigin:ni(this.view,this.graphic);this._attachmentOrigin=it(i,t.center);const n=c(i)?i.z:di(this._mapBounds.origin,this.view.elevationProvider,Ce.fromElevationInfo(z(this.graphic)),this.view.renderCoordsHelper),a=Qt(this._mapBounds);a.origin[2]=n??0,Fn(a,this.view.renderCoordsHelper,e.spatialReference,this._displayBoundsMargin,this._displayBounds),this._updateManipulators()}get _displayBoundsMargin(){var i;const e=this.view.pointsOfInterest,t=e?e.centerOnSurfaceFrequent.location:(i=this._editGeometryOperations.data.geometry.extent)==null?void 0:i.center;return t?Us*this.view.pixelSizeAt(t):0}_createMoveXYGraphicDragPipeline(){return this._graphicMoveManipulation.createDragPipeline((e,t,i)=>this._applyGraphicMoveSteps(t,i,S.XY))}_createMoveZDragPipeline(){const e=this.view,t=this._editGeometryOperations.data.spatialReference;return rt(this._moveZManipulator,(i,n,a)=>{const o=ga(i.renderLocation),s=n.next(Ga(e,o,t)).next(Jt());this._applyGraphicMoveSteps(s,a,S.Z)})}_applyGraphicMoveSteps(e,t,i){const n=e.next(a=>(a.action==="start"&&(this.inputState={type:"move"},this._updateOperationStartProperties(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY})),a)).next(Yt()).next(this._moveDragUpdateGeometry()).next(a=>{const o={graphic:this.graphic,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY};switch(a.action){case"start":case"update":(a.mapEnd.x-a.mapStart.x||a.mapEnd.y-a.mapStart.y||(a.mapEnd.z??0)-(a.mapStart.z??0))&&this.emit("graphic-translate",o);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",o)}return a}).next(a=>this._updateMoveTooltip(a,i));return t.next(()=>{c(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),n}_updateOperationStartProperties(){Qt(this._displayBounds,this._displayBoundsStart),Qt(this._mapBounds,this._mapBoundsStart),_(this.graphic.geometry)?this._sizeStart=null:this._sizeStart=Li(this._mapBoundsStart,this._zmax,this.graphic.geometry.spatialReference,this._graphicState.isDraped)}_moveDragUpdateGeometry(){return e=>{if(_(this.inputState)||this.inputState.type!=="move")return e;const t=[];for(const a of this._editGeometryOperations.data.components)t.push(...a.vertices);const i=e.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS,n=this._editGeometryOperations.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i);return fe(n,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_updateMoveTooltip(e,t){if(t===S.XY||t===S.XY_AXIS){const i=xt(e.mapStart,e.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");c(i)&&c(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return e}_onResizeGrab({action:e,screenPoint:t}){if(e!=="start"||!t)return;const i=this._calculatePickRay(t);ki(this._displayBounds.plane,i,$.get())&&(this._updateOperationStartProperties(),this._displayBoundsMarginStart=this._displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return rt(e,(i,n,a)=>{_(this.inputState)||(n.next(o=>(o.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),o)).next(si(this.view,this._displayBoundsStart.plane)).next(o=>({...o,handle:t})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatio.createDragEventPipelineStep()).next(this._resizeDragUpdateGeometry()).next(o=>{const s={graphic:this.graphic,xScale:o.factor1,yScale:o.factor2};switch(o.action){case"start":case"update":this.emit("graphic-scale",s);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",s)}return o}),a.next(()=>{c(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return e=>{const t=this._displayBoundsStart,i=e.handle.direction,n=this._displayBoundsMargin,a=this._displayBoundsMarginStart,o=Be($.get(),t.origin);ge(o,o,t.basis1,-i[0]),ge(o,o,t.basis2,-i[1]);const s=ot($.get(),e.renderEnd,o),r=ot($.get(),e.renderStart,o),l=Ia(e.handle),p=Fi(t),u=Fi(this._displayBounds)/p,m=(v,M)=>{if(v===0)return 1;let y=we(M),f=.5*v*ii(M,s)/y;const b=f<0?-1:1;l&&(f+=(y-.5*v*ii(M,r)/y)*b*u);const x=y<1.5*a?1:da;return y=Math.max(y-a,da),b>0&&(f-=n),b*Math.max(b*(f/y),x)};return{...e,factor1:m(i[0],t.basis1),factor2:m(i[1],t.basis2)}}}_resizeDragUpdateGeometry(){return e=>{const t=Be(V(),this._mapBoundsStart.origin);ge(t,t,this._mapBoundsStart.basis1,-e.handle.direction[0]),ge(t,t,this._mapBoundsStart.basis2,-e.handle.direction[1]);const i=Tt(ae(),this._mapBoundsStart.basis1[0],this._mapBoundsStart.basis1[1]);ai(i,i);const n=[];for(const s of this._editGeometryOperations.data.components)n.push(...s.vertices);const a=e.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS,o=this._editGeometryOperations.scaleVertices(n,t,i,e.factor1,e.factor2,a,Zi.REPLACE);return Qt(this._mapBoundsStart,this._mapBounds),fe(o,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_onRotateGrab({action:e,screenPoint:t}){if(e!=="start"||!t)return;const i=zo(this._displayBounds,this.view.renderCoordsHelper,Co.HEADING,Mi()),n=this._calculatePickRay(t);ki(i,n,$.get())&&(this._updateOperationStartProperties(),this.inputState={type:"rotate",rotatePlane:i})}_createRotateDragPipeline(e){return rt(e,(t,i,n)=>{const a=this.inputState;_(a)||(i.next(o=>(o.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),o)).next(si(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdateGeometry()).next(o=>{const s={graphic:this.graphic,angle:le(o.rotateAngle)};switch(o.action){case"start":case"update":this.emit("graphic-rotate",s);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",s)}return o}),n.next(()=>{c(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(e){return t=>{const i=de(e.rotatePlane),n=Ea(t.renderStart,t.renderEnd,this._displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:n}}}_rotateDragUpdateGeometry(){return e=>{const t=Be(V(),this._mapBoundsStart.origin),i=[];for(const o of this._editGeometryOperations.data.components)i.push(...o.vertices);const n=e.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS,a=this._editGeometryOperations.rotateVertices(i,t,e.rotateAngle,n,Zi.REPLACE);return Qt(this._mapBoundsStart,this._mapBounds),fe(a,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_calculatePickRay(e){const t=io(),i=Qa(e);return Rn(this.view.state.camera,i,t),ei(t.direction,t.direction),t}_updateManipulators(){if(!this.visible)return;const e=Ho(this._displayBounds,q.get());No(this._rotateManipulator,e,this._displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this._moveZManipulator,e),this._resizeManipulators.forEach((t,i)=>{Uo(t,this._resizeHandles[i],e,this._displayBounds)})}_updateZMoveHandle(e,t){const i=this._displayBounds,n={basis:i.basis1,direction:-1,position:ot($.get(),i.origin,i.basis1),edge:2},a=q.get();Kn(a,t,n.edge*Math.PI/2),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=n.position}_cancel(){const e=this._editGeometryOperations.lastOperation;_(e)||(this._editGeometryOperations.undo(),this.graphic.geometry=this._editGeometryOperations.data.geometry,Vi(e,this._mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(c(this.inputState))this.view.activeTool=null;else if(this.canUndo){const e=this._editGeometryOperations.undo();this.graphic.geometry=this._editGeometryOperations.data.geometry,Vi(D(e),this._mapBounds),this._updateDisplayBounds()}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this._editGeometryOperations.redo();this.graphic.geometry=this._editGeometryOperations.data.geometry,fe(D(e),this._mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this._resizeManipulators,rotateManipulator:this._rotateManipulator,moveZManipulator:this._moveZManipulator,tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"enableZ",void 0),h([d()],j.prototype,"enableRotation",void 0),h([d()],j.prototype,"enableScaling",void 0),h([d({constructOnly:!0,type:Rt})],j.prototype,"tooltipOptions",void 0),h([d()],j.prototype,"preserveAspectRatio",null),h([d()],j.prototype,"grabbing",void 0),h([d()],j.prototype,"inputState",void 0),h([d({readOnly:!0})],j.prototype,"type",void 0),h([d()],j.prototype,"_moveUnit",null),j=h([C("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],j);const ca="draped-elevation-changes",Us=10,Xs=80,da=1e-6;export{Ut as DrawGraphicTool3D,j as ExtentTransformTool,mt as GraphicMoveTool,U as GraphicReshapeTool,B as GraphicTransformTool};

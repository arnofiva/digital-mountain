import"./geometry-f89ca072.js";import{a as Mt}from"./Error-62cc7aff.js";import{t as G,r as S}from"./typedArrayUtil-70e1d79e.js";import{e as F,$,w as N,f as Rt}from"./Extent-2ad2c9a9.js";import{e as Q,t as Pt,r as z,A as bt,E as T,s as k,h as et,n as St,O as Et,w as it}from"./projection-d42b91be.js";import{v as Nt}from"./Polyline-cf51ad23.js";var H;function mt(t,o,e){return!bt(t,o,e)}function W(t,o,e){const r=mt(t,o,e);if(r&&!Q())throw new Mt("rasterprojectionhelper-project","projection engine is not loaded");return r}(function(t){t[t.None=0]="None",t[t.North=1]="North",t[t.South=2]="South",t[t.Both=3]="Both"})(H||(H={}));const st=(t,o,e,r=0)=>{if(e[0]===1)return[0,0];let s=1,n=-1,i=1,u=-1;for(let c=0;c<t.length;c+=2)isNaN(t[c])||(s=s>t[c]?t[c]:s,n=n>t[c]?n:t[c],i=i>t[c+1]?t[c+1]:i,u=u>t[c+1]?u:t[c+1]);const{cols:f,rows:l}=o,a=(n-s)/f/e[0],d=(u-i)/l/e[1],x=2*r;let m=0,h=!1,g=[0,0];for(let c=0;c<f-3;c++){for(let M=0;M<l-3;M++){const y=c*l*2+2*M,p=(t[y]+t[y+4]+t[y+4*l]+t[y+4*l+4])/4,w=(t[y+1]+t[y+5]+t[y+4*l+1]+t[y+4*l+5])/4,R=Math.abs((p-t[y+2*l+2])/a),P=Math.abs((w-t[y+2*l+3])/d);if(R+P>m&&(m=R+P,g=[R,P]),x&&m>x){h=!0;break}}if(h)break}return g},Gt={3395:20037508342789244e-9,3410:17334193943686873e-9,3857:20037508342788905e-9,3975:17367530445161372e-9,4087:20037508342789244e-9,4088:20015108787169147e-9,6933:17367530445161372e-9,32662:20037508342789244e-9,53001:2001508679602057e-8,53002:1000754339801029e-8,53003:2001508679602057e-8,53004:2001508679602057e-8,53016:14152803599503474e-9,53017:17333573624304302e-9,53034:2001508679602057e-8,53079:20015114352186374e-9,53080:20015114352186374e-9,54001:20037508342789244e-9,54002:10018754171394624e-9,54003:20037508342789244e-9,54004:20037508342789244e-9,54016:14168658027268292e-9,54017:1736753044516137e-8,54034:20037508342789244e-9,54079:20037508342789244e-9,54080:20037508342789244e-9,54100:20037508342789244e-9,54101:20037508342789244e-9},B=32,I=4,X=I,K=new Map,U=new Map,j=500;async function Yt(){Q()||await Pt()}function Ft(t,o,e){return W(t.spatialReference,o)?e?it(o,t.spatialReference,t):it(t.spatialReference,o,t):null}function qt(t,o,e,r=null){const s=t.spatialReference;if(s.equals(o))return t;W(s,o,r);const n=e.center,i=new F({xmin:n.x-t.x/2,xmax:n.x+t.x/2,ymin:n.y-t.y/2,ymax:n.y+t.y/2,spatialReference:s}),u=z(i,o,r),f=v(o);let l;if(G(u)||S(f)&&u.width>=f){const a=$(s)/$(o);l={x:t.x*a,y:t.y*a}}else l={x:u.width,y:u.height};return l}function E(t,o=.01){return $(t)?o/$(t):0}function rt(t,o,e=null,r=!0){const s=t.spatialReference;if(s.equals(o))return t;W(s,o,e);const n=z(t,o,e);return r&&n&&ht([t],[n],s,o),n}function ht(t,o,e,r){const s=Y(e,!0),n=Y(r,!0),i=E(e,j),u=E(r,j);if(i&&S(s)&&S(n))for(let f=0;f<t.length;f++){const l=o[f];if(!l)continue;const{x:a}=t[f],{x:d}=l;d>=n[1]-u&&Math.abs(a-s[0])<i?l.x-=n[1]-n[0]:d<=n[0]+u&&Math.abs(a-s[1])<i&&(l.x+=n[1]-n[0])}}function kt(t){const{inSR:o,outSR:e,datumTransformation:r,preferPE:s}=t;if(o.equals(e)){const{points:n}=V(t,null);return n}if(o.isWebMercator&&e.isWGS84||o.isWGS84&&e.isWebMercator)return vt(t);if(W(o,e,r)&&s){if(o.isGeographic)return at(t);const n=O(o);if(S(n))return at(t)}return Tt(t)}function Tt(t){const{points:o}=V(t,null),{inSR:e,outSR:r,datumTransformation:s}=t,n=o.map(u=>new N(u[0],u[1],e)),i=z(n,r,s);return s&&ht(n,i,e,r),i.map(u=>u?[u.x,u.y]:[NaN,NaN])}function at(t){const{inSR:o,outSR:e,datumTransformation:r}=t,s=O(o),{points:n,mask:i}=V(t,s);if(!o.isGeographic){const f=o.wkid?T.coordsys(o.wkid):T.fromString(o.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,o.wkt);et.projToGeog(f,n.length,n)}if(S(r)&&r.steps.length){let f;if(e.isGeographic&&(f=n.map(([a])=>a>179.9955?1:a<-179.9955?-1:0)),r.steps.forEach(a=>{const d=a.wkid?T.geogtran(a.wkid):T.fromString(k.PE_TYPE_GEOGTRAN,a.wkt);St.geogToGeog(d,n.length,n,null,a.isInverse?k.PE_TRANSFORM_2_TO_1:k.PE_TRANSFORM_1_TO_2)}),f)for(let a=0;a<n.length;a++){const d=f[a],x=n[a][0],m=x>179.9955?1:x<-179.9955?-1:0;d&&m&&d!==m&&(n[a][0]=d>0?x+360:x-360)}}if(!e.isGeographic){const f=O(e,!0),l=S(f)&&f.isEnvelope?[f.bbox[1],f.bbox[3]]:[-90,90];Ct(n,l);const a=e.wkid?T.coordsys(e.wkid):T.fromString(e.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,e.wkt);et.geogToProj(a,n.length,n)}let u=n;if(i&&n.length!==i.length){u=[];for(let f=0,l=0;f<i.length;f++)i[f]?u.push(n[l++]):u.push([NaN,NaN])}return u}function vt(t){const{cols:o,rows:e,xres:r,yres:s,usePixelCenter:n,inSR:i,outSR:u}=t;let{xmin:f,ymax:l}=t;n&&(f+=r/2,l-=s/2);const a=[],d=[],x=Math.max(o,e);for(let h=0;h<x;h++){const g=f+r*Math.min(o,h),c=l-s*Math.min(e,h),M=z(new N({x:g,y:c,spatialReference:i}),u);h<=o&&a.push(M.x),h<=e&&d.push(M.y)}const m=[];for(let h=0;h<o;h++)for(let g=0;g<e;g++)m.push([a[h],d[g]]);return m}function O(t,o=!1){let e=t.wkid||t.wkt;if(!e||t.isGeographic)return null;if(e=String(e),K.has(e)){const i=K.get(e);return o?i==null?void 0:i.gcs:i==null?void 0:i.pcs}const r=t.wkid?T.coordsys(t.wkid):T.fromString(t.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,t.wkt),s=lt(r,E(t,1e-4)),n=lt(r,0,!0);return K.set(e,{pcs:s,gcs:n}),o?n:s}function lt(t,o=0,e=!1){const r=Et.generate(t),s=e?t.horizonGcsGenerate():t.horizonPcsGenerate();if(!r||!(s!=null&&s.length))return null;let n=!1,i=s.find(c=>c.getInclusive()===1&&c.getKind()===1);if(!i){if(i=s.find(c=>c.getInclusive()===1&&c.getKind()===0),!i)return null;n=!0}const u=e?0:(r.getNorthPoleLocation()===2?1:0)|(r.getSouthPoleLocation()===2?2:0),f=r.isPannableRectangle(),l=i.getCoord();if(n)return{isEnvelope:n,isPannable:f,vertices:l,coef:null,bbox:[l[0][0]-o,l[0][1]-o,l[1][0]+o,l[1][1]+o],poleLocation:u};let a=0;const d=[];let[x,m]=l[0],[h,g]=l[0];for(let c=0,M=l.length;c<M;c++){a++,a===M&&(a=0);const[y,p]=l[c],[w,R]=l[a];if(R===p)d.push([y,w,p,R,2]);else{const P=(w-y)/(R-p||1e-4),C=y-P*p;p<R?d.push([P,C,p,R,0]):d.push([P,C,R,p,1])}x=x<y?x:y,m=m<p?m:p,h=h>y?h:y,g=g>p?g:p}return{isEnvelope:!1,isPannable:f,vertices:l,coef:d,bbox:[x,m,h,g],poleLocation:u}}function V(t,o){const e=[],{cols:r,rows:s,xres:n,yres:i,usePixelCenter:u}=t;let{xmin:f,ymax:l}=t;if(u&&(f+=n/2,l-=i/2),G(o)){for(let m=0;m<r;m++)for(let h=0;h<s;h++)e.push([f+n*m,l-i*h]);return{points:e}}const a=new Uint8Array(r*s);if(o.isEnvelope){const{bbox:[m,h,g,c]}=o;for(let M=0,y=0;M<r;M++){const p=f+n*M,w=o.isPannable||p>=m&&p<=g;for(let R=0;R<s;R++,y++){const P=l-i*R;w&&P>=h&&P<=c&&(e.push([p,P]),a[y]=1)}}return{points:e,mask:a}}const d=o.coef,x=[];for(let m=0;m<s;m++){const h=l-i*m,g=[],c=[];for(let y=0;y<d.length;y++){const[p,w,R,P,C]=d[y];if(h===R&&R===P)g.push(p),g.push(w),c.push(2),c.push(2);else if(h>=R&&h<=P){const A=p*h+w;g.push(A),c.push(C)}}let M=g;if(g.length>2){let y=c[0]===2?0:c[0],p=g[0];M=[];for(let w=1;w<c.length;w++)c[w]===2&&w!==c.length-1||(c[w]!==y&&(M.push(y===0?Math.min(p,g[w-1]):Math.max(p,g[w-1])),y=c[w],p=g[w]),w===c.length-1&&M.push(c[w]===0?Math.min(p,g[w]):Math.max(p,g[w])));M.sort((w,R)=>w-R)}else g[0]>g[1]&&(M=[g[1],g[0]]);x.push(M)}for(let m=0,h=0;m<r;m++){const g=f+n*m;for(let c=0;c<s;c++,h++){const M=l-i*c,y=x[c];if(y.length===2)g>=y[0]&&g<=y[1]&&(e.push([g,M]),a[h]=1);else if(y.length>2){let p=!1;for(let w=0;w<y.length;w+=2)if(g>=y[w]&&g<=y[w+1]){p=!0;break}p&&(e.push([g,M]),a[h]=1)}}}return{points:e,mask:a}}function Ct(t,o){const[e,r]=o;for(let s=0;s<t.length;s++){const n=t[s][1];(n<e||n>r)&&(t[s]=[NaN,NaN])}}function xt(t){const o=v(t[0].spatialReference);if(t.length<2||G(o))return t[0];let{xmin:e,xmax:r,ymin:s,ymax:n}=t[0];for(let i=1;i<t.length;i++){const u=t[i];r=u.xmax+o*i,s=Math.min(s,u.ymin),n=Math.max(n,u.ymax)}return new F({xmin:e,xmax:r,ymin:s,ymax:n,spatialReference:t[0].spatialReference})}function _t(t,o,e=null,r=!0){const s=t.spatialReference;if(s.equals(o))return t;const n=zt(t),i=v(s,!0),u=v(o);if(n===0||G(i)||G(u)){const l=ft(t,o,e,r);if(G(i)&&S(u)&&Math.abs(l.width-u)<E(o)&&Q()){const a=O(s);if(S(a)&&a.poleLocation===H.None&&t.width<(a.bbox[2]-a.bbox[0])/2)return Ot(t,o)||l}return l}const f=t.clone().normalize();if(f.length===1&&t.xmax<i&&t.xmax-i/2>E(s)){const{xmin:l,xmax:a}=t;for(let d=0;d<=n;d++){const x=d===0?l:-i/2,m=d===n?a-i*d:i/2;f[d]=new F({xmin:x,xmax:m,ymin:t.ymin,ymax:t.ymax,spatialReference:s})}}return xt(f.map(l=>ft(l,o,e,r)).filter(S))}function Ot(t,o){const e=v(o);if(G(e))return null;let{xmin:r,ymin:s,xmax:n,ymax:i}=t;const u=t.spatialReference,f=new Nt({spatialReference:u,rings:[[[r,s],[n,s],[n,i],[r,i],[r,s]]]}),l=z(f,o);if(l.rings.length!==2||!l.rings[0].length||!l.rings[1].length)return null;const{rings:a}=l,d=E(u),x=new F({spatialReference:o});for(let m=0;m<2;m++){r=n=a[m][0][0],s=i=a[m][0][1];for(let h=0;h<a[m].length;h++)r=r>a[m][h][0]?a[m][h][0]:r,n=n<a[m][h][0]?a[m][h][0]:n,s=s>a[m][h][1]?a[m][h][1]:s,i=i<a[m][h][1]?a[m][h][1]:i;if(m===0)x.ymin=s,x.ymax=i,x.xmin=r,x.xmax=n;else if(x.ymin=Math.min(x.ymin,s),x.ymax=Math.max(x.ymax,i),Math.abs(n-e/2)<d)x.xmin=r,x.xmax=x.xmax+e;else{if(!(Math.abs(r+e/2)<d))return null;x.xmax=n+e}}return x}function ft(t,o,e=null,r=!0,s=!0){const n=t.spatialReference;if(n.equals(o)||!o)return t;W(n,o,e);const i=z(t,o,e);if(s&&o.isWebMercator&&i&&(i.ymax=Math.min(20037508342787e-6,i.ymax),i.ymin=Math.max(-20037508342787e-6,i.ymin),i.ymin>=i.ymax))return null;if(!r||!i)return i;const u=Y(n,!0),f=Y(o,!0);if(G(u)||G(f))return i;const l=E(n,.001),a=E(n,j),d=E(o,.001);if(Math.abs(i.xmin-f[0])<d&&Math.abs(i.xmax-f[1])<d){const x=Math.abs(t.xmin-u[0]),m=Math.abs(u[1]-t.xmax);if(x<l&&m>a){i.xmin=f[0];const h=[];h.push(new N(t.xmax,t.ymin,n)),h.push(new N(t.xmax,(t.ymin+t.ymax)/2,n)),h.push(new N(t.xmax,t.ymax,n));const g=h.map(c=>rt(c,o,e)).filter(c=>!isNaN(c==null?void 0:c.x)).map(c=>c.x);i.xmax=Math.max.apply(null,g)}if(m<l&&x>a){i.xmax=f[1];const h=[];h.push(new N(t.xmin,t.ymin,n)),h.push(new N(t.xmin,(t.ymin+t.ymax)/2,n)),h.push(new N(t.xmin,t.ymax,n));const g=h.map(c=>rt(c,o,e)).filter(c=>!isNaN(c==null?void 0:c.x)).map(c=>c.x);i.xmin=Math.min.apply(null,g)}}else{const x=E(o,.001);Math.abs(i.xmin-f[0])<x&&(i.xmin=f[0]),Math.abs(i.xmax-f[1])<x&&(i.xmax=f[1])}return i}function v(t,o=!1){if(!t)return null;const e=o?20037508342787e-6:20037508342788905e-9;return t.isWebMercator?2*e:t.wkid&&t.isGeographic?360:2*Gt[t.wkid]||null}function Y(t,o=!1){if(t.isGeographic)return[-180,180];const e=v(t,o);return S(e)?[-e/2,e/2]:null}function ct(t,o,e,r){let s=(t-o)/e;return s-Math.floor(s)!=0?s=Math.floor(s):r&&(s-=1),s}function zt(t,o=!1){const e=v(t.spatialReference);if(G(e))return 0;const r=o?0:-(e/2),s=E(t.spatialReference),n=!o&&Math.abs(t.xmax-e/2)<s?e/2:t.xmax,i=!o&&Math.abs(t.xmin+e/2)<s?-e/2:t.xmin;return ct(n,r,e,!0)-ct(i,r,e,!1)}function Jt(t){const o=t.storageInfo.origin.x,e=v(t.spatialReference,!0);if(G(e))return{originX:o,halfWorldWidth:null,pyramidsInfo:null};const r=e/2,{nativePixelSize:s,storageInfo:n,extent:i}=t,{maximumPyramidLevel:u,blockWidth:f,pyramidScalingFactor:l}=n;let a=s.x;const d=[],x=S(t.transform)&&t.transform.type==="gcs-shift",m=o+(x?0:r),h=x?e-o:r-o;for(let g=0;g<=u;g++){const c=(i.xmax-o)/a/f,M=c-Math.floor(c)==0?c:Math.ceil(c),y=h/a/f,p=y-Math.floor(y)==0?y:Math.ceil(y),w=Math.floor(m/a/f),R=Math.round(m/a)%f,P=(f-Math.round(h/a)%f)%f;d.push({resolutionX:a,blockWidth:f,datsetColumnCount:M,worldColumnCountFromOrigin:p,leftMargin:R,rightPadding:P,originColumnOffset:w}),a*=l}return{originX:o,halfWorldWidth:r,pyramidsInfo:d,hasGCSSShiftTransform:x}}function Wt(t){if(!t||t.isGeographic)return t;const o=String(t.wkid||t.wkt);let e;return U.has(o)?e=U.get(o):(e=(t.wkid?T.coordsys(t.wkid):T.fromString(k.PE_TYPE_PROJCS,t.wkt)).getGeogcs().getCode(),U.set(o,e)),new Rt({wkid:e})}function Xt(t){const o=t.isAdaptive&&t.spacing==null;let e=t.spacing||[B,B],r=D(t),s={cols:r.size[0]+1,rows:r.size[1]+1};const n=r.outofBoundPointCount>0&&r.outofBoundPointCount<r.offsets.length/2;let i=r.outofBoundPointCount===r.offsets.length/2||o&&n?[0,0]:st(r.offsets,s,e,X);const u=(i[0]+i[1])/2,f=t.projectedExtent.spatialReference,l=t.srcBufferExtent.spatialReference;if(o&&(n||u>X)&&(mt(f,l,t.datumTransformation)&&(f.isGeographic||S(O(f))),e=[I,I],r=D({...t,spacing:e}),s={cols:r.size[0]+1,rows:r.size[1]+1},i=st(r.offsets,s,e,X)),r.error=i,e[0]>1&&(r.coefficients=ut(r.offsets,s,n)),t.includeGCSGrid&&!f.isGeographic&&!f.isWebMercator)if(l.isGeographic)r.gcsGrid={offsets:r.offsets,coefficients:r.coefficients,spacing:e};else{const a=O(f);if(S(a)&&!a.isEnvelope){const d=Wt(f),x=_t(t.projectedExtent,d),{offsets:m}=D({...t,srcBufferExtent:x,spacing:e}),h=ut(m,s,n);r.gcsGrid={offsets:m,coefficients:h,spacing:e}}}return r}function D(t){const{projectedExtent:o,srcBufferExtent:e,pixelSize:r,datumTransformation:s,rasterTransform:n}=t,i=o.spatialReference,u=e.spatialReference,f=W(i,u),{xmin:l,ymin:a,xmax:d,ymax:x}=o,m=v(u),h=S(m)&&(t.hasWrapAround||(n==null?void 0:n.type)==="gcs-shift"),g=t.spacing||[B,B],c=g[0]*r.x,M=g[1]*r.y,y=g[0]===1,p=Math.ceil((d-l)/c-.1/g[0])+(y?0:1),w=Math.ceil((x-a)/M-.1/g[1])+(y?0:1),R=kt({cols:p,rows:w,xmin:l,ymax:x,xres:c,yres:M,inSR:i,outSR:u,datumTransformation:s,preferPE:g[0]<=I,usePixelCenter:y}),P=[];let C,A=0;const Z=y?-1:NaN,{xmin:tt,xmax:q,ymax:pt,width:gt,height:yt}=e,dt=E(u,j),wt=S(m)&&tt>0&&q>m/2;let nt=!1;if(f){const _=O(i);nt=S(_)&&_.poleLocation>0}for(let _=0;_<p;_++){const J=[];for(let L=0;L<w;L++){let b=R[_*w+L];if(h&&b[0]>q&&b[0]>m/2-dt?b[0]-=m:h&&_===0&&b[0]<0&&wt&&!n&&(b[0]+=m),!b||isNaN(b[0])||isNaN(b[1]))P.push(Z),P.push(Z),J.push(null),A++;else{if(n){const ot=n.inverseTransform(new N({x:b[0],y:b[1],spatialReference:u}));b=[ot.x,ot.y]}J.push(b),_>0&&h&&C[L]&&b[0]<C[L][0]&&(b[0]+=m,nt&&b[0]>q&&b[0]>m&&(b[0]-=m)),P.push((b[0]-tt)/gt),P.push((pt-b[1])/yt)}}C=J}return{offsets:P,error:null,coefficients:null,outofBoundPointCount:A,spacing:g,size:y?[p,w]:[p-1,w-1]}}function ut(t,o,e){const{cols:r,rows:s}=o,n=new Float32Array((r-1)*(s-1)*2*6),i=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),u=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let f=0;f<r-1;f++){for(let l=0;l<s-1;l++){let a=f*s*2+2*l;const d=t[a],x=t[a+1],m=t[a+2],h=t[a+3];a+=2*s;const g=t[a],c=t[a+1],M=t[a+2],y=t[a+3];let p=0,w=12*(l*(r-1)+f);for(let R=0;R<3;R++)n[w++]=i[p++]*d+i[p++]*m+i[p++]*M;p=0;for(let R=0;R<3;R++)n[w++]=i[p++]*x+i[p++]*h+i[p++]*y;p=0;for(let R=0;R<3;R++)n[w++]=u[p++]*d+u[p++]*g+u[p++]*M;p=0;for(let R=0;R<3;R++)n[w++]=u[p++]*x+u[p++]*c+u[p++]*y}if(e)for(let l=0;l<n.length;l++)isNaN(n[l])&&(n[l]=-1)}return n}function Kt(t){const o=t.clone().normalize();return o.length===1?o[0]:xt(o)}function Ut(t,o,e){const{storageInfo:r,pixelSize:s}=o;let n=0,i=!1;const{pyramidResolutions:u}=r;if(S(u)&&u.length){const x=(t.x+t.y)/2,m=u[u.length-1],h=(m.x+m.y)/2,g=(s.x+s.y)/2;if(x<=g)n=0;else if(x>=h)n=u.length,i=x/h>8;else{let M,y=g;for(let p=1;p<=u.length;p++){if(M=(u[p-1].x+u[p-1].y)/2,x<=M){x===M?n=p:e==="down"?(n=p-1,i=x/y>8):n=e==="up"||x-y>M-x||x/y>2?p:p-1;break}y=M}}const c=n===0?s:u[n-1];return i&&Math.min(c.x,c.y)*$(o.spatialReference)>19567&&(i=!1),{pyramidLevel:n,pyramidResolution:new N({x:c.x,y:c.y,spatialReference:o.spatialReference}),excessiveReading:i}}const f=Math.log(t.x/s.x)/Math.LN2,l=Math.log(t.y/s.y)/Math.LN2,a=o.storageInfo.maximumPyramidLevel||0;n=e==="down"?Math.floor(Math.min(f,l)):e==="up"?Math.ceil(Math.max(f,l)):Math.round((f+l)/2),n<0?n=0:n>a&&(i=n>a+3,n=a);const d=2**n;return{pyramidLevel:n,pyramidResolution:new N({x:d*o.nativePixelSize.x,y:d*o.nativePixelSize.y,spatialReference:o.spatialReference}),excessiveReading:i}}export{Xt as $,qt as C,_t as J,mt as M,zt as Q,Yt as T,v as U,Jt as V,rt as j,Kt as n,Ut as o,Ft as v};

import{U as pe}from"./request-f01affa1.js";import{G as me,I as de,M as ye,r as M,t as C,V as be,o as P}from"./typedArrayUtil-70e1d79e.js";import{a as g}from"./Error-62cc7aff.js";import{h as ge}from"./string-7a2f1d87.js";import{E as Se}from"./promiseUtils-59dab60c.js";import{p as we}from"./mat3-4fd89d48.js";import{e as Me}from"./mat3f64-50f3b9f6.js";import{h as Te}from"./mat4-4714ff8c.js";import{e as L}from"./mat4f64-abdda1bb.js";import{B as ee,y as Ee,S as te}from"./quat-99c4e099.js";import{e as ve}from"./quatf32-51a323b8.js";import{n as W,o as E,a as D,J as Ie,E as re,g as j,u as xe,O as v}from"./vec3-015ca254.js";import{O as ne,f as ae,j as Z}from"./Extent-2ad2c9a9.js";import{Z as oe,A as Re,x as I,j as B}from"./projection-d42b91be.js";import{c as x}from"./spatialReferenceEllipsoidUtils-26c8dea5.js";import{u as K,D as J,m as $,E as Ce}from"./aaBoundingRect-42f9721f.js";import{x as qe}from"./Query-6df7497c.js";import{I as Ne}from"./I3SBinaryReader-c63d93b8.js";import{m as ze,N as Oe,Q as se,t as ie,p as Ue}from"./orientedBoundingBox-7f391048.js";import{n as We,r as H}from"./symbolColorUtils-7c94928f.js";import{s as De}from"./Attribute-f72d3f37.js";function ke(e,t,r,n){const a=Ae(e,t,r),o=L();return oe(r,a,o,n),o}const ce=1,Q=5-ce;function Ae(e,t,r){const n=W(),a=e[3],o=2**(Math.ceil(Math.log(a)*Math.LOG2E/Q)*Q+ce);if(r.isGeographic){const c=o/ne(r).radius*180/Math.PI,u=Math.round(e[1]/c),p=Math.max(-90,Math.min(90,u*c)),h=c/Math.cos((Math.abs(p)-c/2)/180*Math.PI),d=Math.round(e[0]/h)*h;n[0]=d,n[1]=p}else{const c=Math.round(e[0]/o),u=Math.round(e[1]/o);n[0]=c*o,n[1]=u*o}const s=e[2]+t,i=Math.round(s/o);return n[2]=i*o,n}function le(e){return e?parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10):void 0}function Nt(e){var t;if(ge("disable-feature:i3s-draco")||!e)return!1;for(const r of e)for(const n of r.geometryBuffers)if(((t=n.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0;return!1}function zt(e,t,r,n){r.traverse(t,a=>{const o=a.mbs;return(o!=null&&$e(e,o))!==T.OUTSIDE&&(n(a),!0)})}function Ot(e,t,r){let n=0,a=0;for(let o=0;o<t.length&&n<e.length;o++)e[n]===t[o]&&(r(o)&&(e[a]=e[n],a++),n++);e.length=a}function Ut(e,t,r){let n=0,a=0;for(;n<r.length;)ye(e,r[n])>=0===t&&(r[a]=r[n],a++),n++;r.length=a}const R=K();function Wt(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return R[0]=(e[0]-t.position[0])/t.rotationScale[0],R[1]=(e[1]-t.position[1])/t.rotationScale[4],R[2]=(e[2]-t.position[0])/t.rotationScale[0],R[3]=(e[3]-t.position[1])/t.rotationScale[4],R}var T;function $e(e,t){const r=t[0],n=t[1],a=t[3],o=e[0]-r,s=r-e[2],i=e[1]-n,c=n-e[3],u=Math.max(o,s,0),p=Math.max(i,c,0),h=u*u+p*p;return h>a*a?T.OUTSIDE:h>0?T.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,s,i,c)>a?T.INSIDE:T.INTERSECTS_CENTER_INSIDE}function Fe(e,t,r){const n=[],a=r&&r.missingFields,o=r&&r.originalFields;for(const s of e){const i=s.toLowerCase();let c=!1;for(const u of t)if(i===u.name.toLowerCase()){n.push(u.name),c=!0,o&&o.push(s);break}!c&&a&&a.push(s)}return n}async function Dt(e,t,r,n,a){if(t.length===0)return[];const o=e.attributeStorageInfo;if(M(e.associatedLayer))try{return await Ge(e.associatedLayer,t,r,n)}catch(s){if(e.associatedLayer.loaded)throw s}if(o){const s=_e(t,r,a);if(C(s))throw new g("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const i=e.parsedUrl.path;return(await Promise.all(s.map(c=>Le(i,o,c.node,c.indices,n).then(u=>{for(let p=0;p<c.graphics.length;p++){const h=c.graphics[p],d=u[p];if(h.attributes)for(const f in h.attributes)f in d||(d[f]=h.attributes[f]);h.attributes=d}return c.graphics})))).flat()}throw new g("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function _e(e,t,r){const n=new Map,a=[],o=r();for(const s of e){const i=s.attributes[t];for(let c=0;c<o.length;c++){const u=o[c],p=u.featureIds.indexOf(i);if(p>=0){let h=n.get(u.node);h||(h={node:u.node,indices:[],graphics:[]},a.push(h),n.set(u.node,h)),h.indices.push(p),h.graphics.push(s);for(let d=c;d>0;d--)o[d]=o[d-1];o[0]=u;break}}}return a}async function Ge(e,t,r,n){t.sort((c,u)=>c.attributes[r]-u.attributes[r]);const a=t.map(c=>c.attributes[r]),o=[],s=Fe(n,e.fields,{originalFields:o}),i=await ue(e,a,s);for(let c=0;c<t.length;c++){const u=t[c],p=i[c],h={};if(u.attributes)for(const d in u.attributes)h[d]=u.attributes[d];for(let d=0;d<o.length;d++)h[o[d]]=p[s[d]];u.attributes=h}return t}function ue(e,t,r){const n=e.capabilities.query.maxRecordCount;if(n!=null&&t.length>n){const o=be(t,n);return Promise.all(o.map(s=>ue(e,s,r))).then(s=>s.flat())}const a=new qe({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(a).then(o=>{if(o&&o.features&&o.features.length===t.length)return o.features.map(s=>s.attributes);throw new g("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function Le(e,t,r,n,a){return Ke(e,t,r.resources.attributes,n,a)}function Ke(e,t,r,n,a){const o=[];for(const s of t)if(s&&a.includes(s.name)){const i=`${e}/nodes/${r}/attributes/${s.key}/0`;o.push({url:i,storageInfo:s})}return Se(o.map(s=>pe(s.url,{responseType:"array-buffer"}).then(i=>Ne(s.storageInfo,i.data)))).then(s=>{const i=[];for(const c of n){const u={};for(let p=0;p<s.length;p++){const h=s[p].value;h!=null&&(u[o[p].storageInfo.name]=Ze(h,c))}i.push(u)}return i})}(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"})(T||(T={}));const Pe=-32768,je=-(2**31);function Ze(e,t){if(!e)return null;const r=e[t];return me(e)?r===Pe?null:r:de(e)?r===je?null:r:r!=r?null:r}function Be(e){const t=e.store,r=t.indexCRS||t.geographicCRS,n=r===void 0?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new g("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new g("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=r?new ae(le(r)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function Je(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,n=r===void 0?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new g("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new g("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=r?new ae(le(r)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function kt(e,t){return C(t)?"@null":t===x(t)?"@ECEF":e.equals(t)?"":t.wkid!=null?"@"+t.wkid:null}function _(e,t,r){if(!Re(e,t))throw new g("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if(r==="local"&&!He(e,t))throw new g("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function At(e,t,r){var n,a;if(((n=e.serviceUpdateTimeStamp)==null?void 0:n.lastUpdate)!==((a=t.serviceUpdateTimeStamp)==null?void 0:a.lastUpdate)||!r.isEmpty||P(e.associatedLayer,o=>o.url)!==P(t.associatedLayer,o=>o.url))throw new g("layerview:recycle-failed")}function He(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function Qe(e,t,r){const n=Be(e),a=Je(e);_(n,t,r),_(a,t,r)}function Ve(e){return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function $t(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Ve(e.store.defaultGeometrySchema))throw new g("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function Ft(e,t){Qe(e,t.spatialReference,t.viewingMode)}function Xe(e){return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function _t(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Xe(e.store.defaultGeometrySchema))throw new g("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function Gt(e,t){_(e.spatialReference,t.spatialReference,t.viewingMode)}function Ye(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function et(e){return e.type==="mesh-3d"}function Lt(e){if(e==null||!Ye(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.getSymbols();if(t.length===0)return!0;for(const r of t){if(!et(r)||r.symbolLayers.length===0)return!0;for(const n of r.symbolLayers.items)if(n.type!=="fill"||C(n.material)||C(n.material.color)||n.material.colorMixMode!=="replace")return!0}return!1}const Kt=ze({color:[0,0,0,0],opacity:0});class tt{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function Pt(e){const t=new tt;let r=!1,n=!1;for(const a of e.symbolLayers.items)if(a.type==="fill"&&a.enabled){const o=a.material,s=a.edges;if(M(o)&&!r){const i=o.color,c=We(o.colorMixMode);M(i)?t.material={color:[i.r/255,i.g/255,i.b/255],alpha:i.a,colorMixMode:c}:t.material={color:[1,1,1],alpha:1,colorMixMode:H.Multiply},t.castShadows=a.castShadows,r=!0}M(s)&&!n&&(t.edgeMaterial=Ue(s,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:H.Multiply}),t}function jt(e,t){return(0|e)+(0|t)|0}function rt(e,t,r,n,a=0){n===x(n)?t.isGeographic?ct(e,r,t,a):it(e,r,t,a):t.isWGS84&&(n.isWebMercator||Z(n))?nt(t,e,n,r,a):t.isWebMercator&&Z(n)?st(t,e,n,r,a):e===r?(r.center[2]+=a,I(r.center,t,0,r.center,n,0,1)):(E(r.center,e.center[0],e.center[1],e.center[2]+a),I(r.center,t,0,r.center,n,0,1),ee(r.quaternion,e.quaternion),D(r.halfSize,e.halfSize))}function nt(e,t,r,n,a){D(w,t.center),w[2]+=a;const o=x(r);I(w,e,0,w,o,0,1),fe(o,t,w,r,n)}const U=new Array(24),at=new De(U,3,!0),V=W(),w=W(),ot=Me();function st(e,t,r,n,a){D(w,t.center),w[2]+=a,fe(e,t,w,r,n)}function fe(e,t,r,n,a){const o=we(ot,t.quaternion);for(let s=0;s<8;++s){for(let i=0;i<3;++i)V[i]=t.halfSize[i]*(s&1<<i?-1:1);for(let i=0;i<3;++i){let c=r[i];for(let u=0;u<3;++u)c+=V[u]*o[3*u+i];U[3*s+i]=c}}I(U,e,0,U,n,0,8),se(at,a)}function it(e,t,r,n){ie(e,G),E(t.center,e.center[0],e.center[1],e.center[2]+n),oe(r,t.center,b,x(r)),E(t.center,b[12],b[13],b[14]);const a=2*Math.sqrt(1+b[0]+b[5]+b[10]);S[0]=(b[6]-b[9])/a,S[1]=(b[8]-b[2])/a,S[2]=(b[1]-b[4])/a,S[3]=.25*a,Ee(t.quaternion,S,e.quaternion),te(S,t.quaternion);let o=0,s=0,i=0;for(const c of G)c[2]+=n,I(c,r,0,c,x(r),0,1),Ie(l,c,t.center),re(l,l,S),o=Math.max(o,Math.abs(l[0])),s=Math.max(s,Math.abs(l[1])),i=Math.max(i,Math.abs(l[2]));E(t.halfSize,o,s,i)}function ct(e,t,r,n){const a=ne(r),o=1+Math.max(0,n)/(a.radius+e.center[2]);E(t.center,e.center[0],e.center[1],e.center[2]+n),I(t.center,r,0,t.center,x(r),0,1),ee(t.quaternion,e.quaternion),te(S,e.quaternion),E(l,0,0,1),re(l,l,S),E(l,e.halfSize[0]*Math.abs(l[0]),e.halfSize[1]*Math.abs(l[1]),e.halfSize[2]*Math.abs(l[2])),j(l,l,a.inverseFlattening),xe(t.halfSize,e.halfSize,l),j(t.halfSize,t.halfSize,o)}function Zt(e,t,r,n,a,o){if(!o||o.length===0||C(t)||!e.mbs)return null;const s=ke(e.mbs,a,r,t);Te(O,s);let i=null;const c=()=>{if(!i)if(i=G,J(z),M(e.serviceObb)){rt(e.serviceObb,r,X,t,a),ie(X,i);for(const f of i)v(f,f,O),$(z,f)}else{const f=e.mbs;if(!f)return;const m=f[3];B(f,r,l,t),v(l,l,O),l[2]+=a;for(let y=0;y<8;++y){const q=1&y?m:-m,k=2&y?m:-m,A=4&y?m:-m,N=i[y];D(N,[l[0]+q,l[1]+k,l[2]+A]),$(z,N)}}};let u=1/0,p=-1/0;const h=f=>{if(f.type!=="replace")return;const m=f.geometry;if(!(m!=null&&m.hasZ))return;J(F);const y=m.spatialReference||n,q=m.rings.reduce((k,A)=>A.reduce((N,he)=>(B(he,y,l,t),v(l,l,O),$(F,l),Math.min(l[2],N)),k),1/0);c(),Ce(z,F)&&(u=Math.min(u,q),p=Math.max(p,q))};if(o.forEach(f=>h(f)),u===1/0)return null;const d=(f,m,y)=>{v(l,y,s),f[m+0]=l[0],f[m+1]=l[1],f[m+2]=l[2],m+=24,y[2]=u,v(l,y,s),f[m+0]=l[0],f[m+1]=l[1],f[m+2]=l[2],m+=24,y[2]=p,v(l,y,s),f[m+0]=l[0],f[m+1]=l[1],f[m+2]=l[2]};for(let f=0;f<8;++f)d(Y.data,3*f,i[f]);return se(Y)}function Bt(e){return M(e)&&e.halfSize[0]>=0}function Jt(e){return e[3]>=0}function Ht(e){M(e)&&(e.halfSize[0]=-1)}function Qt(e){M(e)&&(e[3]=-1)}const b=L(),S=ve(),G=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],F=K(),z=K(),X=Oe(),l=W(),Y={data:new Array(72),size:3,exclusive:!0,stride:3},O=L();export{Bt as $,Pt as C,$t as E,Qt as H,_t as I,Nt as J,jt as N,Zt as P,Jt as Q,Gt as R,Kt as U,zt as V,Ot as X,Ut as Y,Ht as Z,Dt as a,_ as b,Ae as c,$e as d,Je as e,At as g,Be as h,Ze as m,ke as n,Fe as o,Lt as q,T as r,Wt as t,Ke as u,Ft as v,Qe as w,kt as y,rt as z};

import{e as a,y as l,a as F,n as ot}from"./JSONSupport-32b5ad86.js";import{g as rt}from"./Graphic-46941d56.js";import{n as me}from"./Evented-36093e88.js";import{a as nt,d as st}from"./HandleOwner-f4554d8c.js";import{r as p,$ as oe,j as at,t as m,a as G,e as We,o as Le,l as M,O as lt}from"./typedArrayUtil-70e1d79e.js";import{b as I,U as N,a as _e,p as we}from"./quantityFormatUtils-8ab4301f.js";import{l as te,w as ue}from"./reactiveUtils-e6d6c898.js";import{w as J,I as Ue,$ as pt,L as ct}from"./Extent-2ad2c9a9.js";import"./ensureType-249b88cd.js";import{h as ht}from"./GraphicsLayer-78551f17.js";import{g as ye,s as dt,d as ut}from"./elevationInfoUtils-cb162a43.js";import"./geometry-f89ca072.js";import{p as Ae}from"./string-7a2f1d87.js";import{n as b,g as q,P as Ne,e as O,z as qe,_ as ge,E as Te,A as E,r as gt,u as B,T as be,f as Oe,s as Me,q as se}from"./vec3-015ca254.js";import{cc as Se,cd as mt,ce as yt,cf as re,cg as ne,b3 as vt,aW as je,bC as Ye,bL as ft}from"./index-a7842505.js";import{simplify as xt,distance as _t}from"./geometryEngine-5399ce6b.js";import{a as wt,m as Tt,y as Be,v as bt,h as Ot,i as Mt}from"./Polyline-cf51ad23.js";import{r as St}from"./callExpressionWithFeature-b2780134.js";import{Q as Vt,O as It}from"./quat-99c4e099.js";import{e as Ve}from"./quatf64-f8f1c132.js";import{n as ae,t as Y,c as w}from"./sphere-092242fd.js";import{p as $t,y as le,G as Ct}from"./InteractiveToolBase-7dd00fb3.js";import{t as Q,m as Rt,a as pe,b as Pt,g as X}from"./automaticLengthMeasurementUtils-a85122d9.js";import{i as Ie}from"./automaticAreaMeasurementUtils-d318dad5.js";import{g as $e}from"./promiseUtils-59dab60c.js";import{c as Gt,i as Ce}from"./screenUtils-410d12c0.js";import{i as Re}from"./dehydratedFeatureComparison-e58a8d13.js";import{l as zt}from"./ViewingMode-5d7d590b.js";import{w as Et,V as Dt,g as Ht,p as Zt,t as Ft,a as kt,s as Wt,c as Lt}from"./EditGeometryOperations-c352eb41.js";import{e as Pe}from"./SnappingContext-2f59ac45.js";import{h as Ut,m as At}from"./SnappingOperation-7c7a8baa.js";import{M as Je}from"./dehydratedFeatures-be6dfdbf.js";import{w as Ge,r as L,j as ze,f as Nt,M as qt,o as jt,s as ce,l as Ee}from"./vec2-8acac370.js";function ie(t,e,i=null){return p(i)?[t,e,i]:[t,e]}function v(t,e,i=null){return p(i)?{x:t,y:e,z:i}:{x:t,y:e}}class Qe{constructor(e){this.spatialReference=e}mapToLocalMultiple(e){return oe(e.map(i=>this.mapToLocal(i)))}get doUnnormalization(){return!1}}let Yt=class extends Qe{constructor(e,i,o=null){super(i),this._defaultZ=o,this.transform=Se(),this.transformInv=Se(),this.transform=mt(e),St(this.transformInv,this.transform)}makeMapPoint(e,i){return ie(e,i,this._defaultZ)}mapToLocal(e){return v(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])}localToMap(e){return ie(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this._defaultZ)}},Bt=class extends Qe{constructor(e,i){super(e.spatialReference),this.view=e,this.defaultZ=null,this.pWS=b(),this.tangentFrameUpWS=b(),this.tangentFrameRightWS=b(),this.tangentFrameForwardWS=b(),this.localFrameRightWS=b(),this.localFrameUpWS=b(),this.worldToLocalTransform=Ve(),this.localToWorldTransform=Ve(),this.scale=1,this.scale=e.resolution,this.referenceMapPoint=i,this.defaultZ=i.hasZ?i.z:null;const o=e.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,ae.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,ae.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,ae.Z,this.tangentFrameForwardWS);const n=b();q(n,this.tangentFrameForwardWS,Ne(o,this.tangentFrameForwardWS)),O(this.localFrameRightWS,o,n),qe(this.localFrameRightWS,this.localFrameRightWS),ge(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),Vt(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),It(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return this.view.viewingMode==="global"}makeMapPoint(e,i){return ie(e,i,this.defaultZ)}mapToLocal(e){const i=b();this.view.renderCoordsHelper.toRenderCoords(new J({x:e[0],y:e[1],spatialReference:this.spatialReference}),i),Te(i,i,this.worldToLocalTransform);const o=this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference);return p(o)?v(o.x/this.scale,o.y/this.scale):null}localToMap(e){const i=b();this.view.renderCoordsHelper.toRenderCoords(new J({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),i),Te(i,i,this.localToWorldTransform);const o=this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference);return p(o)?ie(o.x,o.y,this.defaultZ):null}};function De(t,e){if(t.type==="2d")return new Yt(t.state.transform,t.spatialReference,e.length>2?e[2]:null);if(t.type==="3d"){const i=e.length>2?new J({x:e[0],y:e[1],z:e[2],spatialReference:t.spatialReference}):new J({x:e[0],y:e[1],spatialReference:t.spatialReference});return new Bt(t,i)}return null}function Z(t,e){const i=new J({x:t[0],y:t[1],spatialReference:e});return t.length>2&&(i.z=t[2]),i}function Jt(t,e){return new wt({points:t,spatialReference:e})}function He(t,e,i){const o=new Tt({paths:t,spatialReference:e});return i&&Be(o),o}function j(t,e,i,o=!0){const n=Ae(t);n.forEach(r=>{const h=r[0],c=r[r.length-1];at(h,c)&&r.length!==1||r.push(r[0])});let s=new bt({rings:n,spatialReference:e});return s.rings.forEach(r=>{Ot(r,!1,!1)||r.reverse()}),i&&Be(s),o&&s.isSelfIntersecting&&Ue(e)&&(s=xt(s)),s}function Ze(t,e,i){const o=e.mapToLocalMultiple(t),n=[],s={x:o[0].x,y:o[0].y},r={x:o[1].x,y:o[1].y},h=Math.round(r.x-s.x),c=Math.round(r.y-s.y),g=Math.max(Math.abs(h),Math.abs(c));if(i){const d={x:s.x+g,y:s.y+g},y={x:s.x-g,y:s.y-g};n.push(v(d.x,y.y),v(y.x,y.y),v(y.x,d.y),v(d.x,d.y))}else{const d={x:h>0?s.x+g:s.x-g,y:c>0?s.y+g:s.y-g};n.push(v(s.x,s.y),v(d.x,s.y),v(d.x,d.y),v(s.x,d.y))}return Xe(j([oe(n.map(d=>e.localToMap(d)))],e.spatialReference,e.doUnnormalization,!0),n,e)}function Qt(t,e,i){let o=e.mapToLocalMultiple(t);if(o.length===1){const c=o[0];o=[v(c.x-48,c.y+48),v(c.x+48,c.y-48),v(c.x+48,c.y-48),v(c.x-48,c.y+48)]}const n=[],s={x:o[0].x,y:o[0].y},r={x:o[1].x,y:o[1].y};if(i){const h=Math.round(r.x-s.x),c=Math.round(r.y-s.y);n.push(v(s.x-h,s.y-c),v(r.x,s.y-c),v(r.x,r.y),v(s.x-h,r.y))}else n.push(v(s.x,s.y),v(r.x,s.y),v(r.x,r.y),v(s.x,r.y));return Xe(j([oe(n.map(h=>e.localToMap(h)))],e.spatialReference,e.doUnnormalization,!0),n,e)}function Xe(t,e,i){const o=K(e[3],e[2],i),n=K(e[1],e[2],i),s=K(e[0],e[1],i),r=K(e[0],e[3],i);return{geometry:t,midpoints:p(o)&&p(n)&&p(s)&&p(r)?{top:o,right:n,bottom:s,left:r}:null}}function K(t,e,i){U[0]=t.x,U[1]=t.y,U[2]=0,A[0]=e.x,A[1]=e.y,A[2]=0,E(U,U,A,.5),ee.x=U[0],ee.y=A[1],ee.z=A[2];const o=i.localToMap(ee);return p(o)?Z(o,i.spatialReference):null}const ee=v(0,0,0),U=b(),A=b();function Fe(t,e,i,o){const n=e.mapToLocalMultiple(t);let s=null,r=null;if(i)s=n[0],r=n[1];else{const x=n[0],T=n[1],k=Math.round(T.x-x.x),W=Math.round(T.y-x.y),S=Math.max(Math.abs(k),Math.abs(W));s=v(k>0?x.x+S/2:x.x-S/2,W>0?x.y+S/2:x.y-S/2),r=v(Math.abs(k)>Math.abs(W)?s.x-S/2:s.x,Math.abs(k)>Math.abs(W)?s.y:s.y-S/2)}const h=e.localToMap(s),c=e.localToMap(r);if(m(h)||m(c))return null;e.doUnnormalization&&Mt([[h,c]],e.spatialReference);const g=Z(h,e.spatialReference),d=Z(c,e.spatialReference),y=pt(e.spatialReference);let _=0;if(Ue(e.spatialReference))_=y*_t(g,d,null);else{const x=s.x-r.x,T=s.y-r.y;_=y*Math.sqrt(x*x+T*T)*(o||1)}const z=new yt({center:g,radius:_,radiusUnit:"meters",spatialReference:e.spatialReference});return{geometry:j(z.rings,z.spatialReference,!1),center:g,edge:d}}function Xt(t,e,i){const o=e.mapToLocalMultiple(t),n=o[0],s=o[1],r=Math.round(s.x-n.x),h=Math.round(s.y-n.y),c=v(i?n.x:n.x+r/2,i?n.y:n.y+h/2),g=i?r:r/2,d=i?h:h/2,y=60,_=[],z=2*Math.PI/y;function x($){const tt=Math.cos($),it=Math.sin($);return v(g*tt+c.x,d*it+c.y)}for(let $=0;$<y;$++)_.push(x($*z));_.push(_[0]);const{spatialReference:T,doUnnormalization:k}=e,W=j([oe(_.map($=>e.localToMap($)))],T,k,!1),S=e.localToMap(x(Math.PI/2)),ve=e.localToMap(x(0)),fe=e.localToMap(x(-Math.PI/2)),xe=e.localToMap(x(Math.PI));return{geometry:W,midpoints:p(S)&&p(ve)&&p(fe)&&p(xe)?{top:Z(S,T),right:Z(ve,T),bottom:Z(fe,T),left:Z(xe,T)}:null}}function he(t,e){switch(t){case"point":case"multipoint":return"point";case"polyline":return(p(e)&&e.type==="polyline"&&e.paths.length?e.paths[0].length:0)<2?"polylineZeroVertices":"polylineOneVertex";case"polygon":{const i=p(e)&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0;return i<3?"polylineZeroVertices":i<4?"polygonOneVertex":"polygonTwoVertices"}default:return}}let D=class extends Q{constructor(t){super(t),this.type="draw-point",this.helpMessage=void 0}};a([l()],D.prototype,"type",void 0),a([l()],D.prototype,"elevation",void 0),a([l()],D.prototype,"viewType",void 0),a([l()],D.prototype,"helpMessage",void 0),D=a([F("esri.views.interactive.tooltip.DrawPointTooltipInfo")],D);let C=class extends Q{constructor(e){super(e),this.type="draw-polyline",this.totalLength=I,this.helpMessage=void 0}};a([l()],C.prototype,"type",void 0),a([l()],C.prototype,"elevation",void 0),a([l()],C.prototype,"totalLength",void 0),a([l()],C.prototype,"viewType",void 0),a([l()],C.prototype,"helpMessage",void 0),C=a([F("esri.views.interactive.tooltip.DrawPolylineTooltipInfo")],C);let R=class extends Q{constructor(t){super(t),this.type="draw-polygon",this.area=N,this.helpMessage=void 0}};a([l()],R.prototype,"type",void 0),a([l()],R.prototype,"elevation",void 0),a([l()],R.prototype,"area",void 0),a([l()],R.prototype,"viewType",void 0),a([l()],R.prototype,"helpMessage",void 0),R=a([F("esri.views.interactive.tooltip.DrawPolygonTooltipInfo")],R);let H=class extends Q{constructor(t){super(t),this.type="draw-rectangle",this.xSize=I,this.ySize=I,this.area=N}};a([l()],H.prototype,"type",void 0),a([l()],H.prototype,"xSize",void 0),a([l()],H.prototype,"ySize",void 0),a([l()],H.prototype,"area",void 0),H=a([F("esri.views.interactive.tooltip.DrawRectangleTooltipInfo")],H);let P=class extends Q{constructor(t){super(t),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=N}};a([l()],P.prototype,"type",void 0),a([l()],P.prototype,"radius",void 0),a([l()],P.prototype,"xSize",void 0),a([l()],P.prototype,"ySize",void 0),a([l()],P.prototype,"area",void 0),P=a([F("esri.views.interactive.tooltip.DrawCircleTooltipInfo")],P);let u=class extends nt(me.EventedMixin($t)){constructor(e){super(e),this._graphic=null,this._createOperationGeometry=null,this.defaultZ=0,this.geometryType=null,this.hasZ=!0,this.labelOptions=new re,this.mode=null,this.snappingManager=null,this.snapToScene=!1,this.tooltip=null,this.tooltipOptions=new ne}initialize(){this.internalGraphicsLayer=new ht({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",e=>this.onVertexAdd(e)),this.drawOperation.on("vertex-remove",e=>this.onVertexRemove(e)),this.drawOperation.on("vertex-update",e=>this.onVertexUpdate(e)),this.drawOperation.on("cursor-update",e=>this.onCursorUpdate(e)),this.drawOperation.on("complete",e=>this.onComplete(e)),te(()=>this.tooltipOptions.enabled,e=>{this.tooltip=e?new Pt({view:this.view,info:this._tooltipInfo}):G(this.tooltip)},ue),te(()=>this._tooltipInfo,e=>{p(this.tooltip)&&(this.tooltip.info=e)},ue)]),this.finishToolCreation()}destroy(){this.drawOperation=G(this.drawOperation),this.tooltip=G(this.tooltip),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=G(this.internalGraphicsLayer),this._set("view",null)}get _defaultElevation(){return _e(this.defaultZ,"meters")}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(e){this._set("centered",e),this._updateGraphic()}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(e){this._set("graphicSymbol",e),p(this._graphic)&&(this._graphic.symbol=e)}get updating(){var e;return((e=this.drawOperation)==null?void 0:e.updating)??!1}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(e){this.drawOperation.onInputEvent(e)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}_createGraphic(e){this._graphic=new rt({...this.graphicProperties,geometry:e,symbol:this.graphicSymbol}),this.internalGraphicsLayer.add(this._graphic),this.handles.add(this.initializeGraphic(this._graphic)),this.notifyChange("graphic"),this.handles.add(ot(()=>{p(this._graphic)&&(this.internalGraphicsLayer.remove(this._graphic),this._graphic=G(this._graphic))}),de)}_destroyAllVisualisations(){this.handles.remove(V.outline),this.handles.remove(V.regularVertices),this.handles.remove(V.activeVertex),this.handles.remove(de)}_getCreateOperationGeometry(e={operationComplete:!1}){if(this.drawOperation==null||this.drawOperation.numVertices===0)return null;const i=this.drawOperation.stagedVertex,o=this.drawOperation.committedVertices,n=o.slice();p(i)&&n.push(this.drawOperation.coordinateHelper.pointToArray(i));const s=p(i)?this.drawOperation.coordinateHelper.pointToArray(i):o.splice(-1)[0],r={regularVertices:null,activeVertex:null,full:null,outline:null,circle:null,rectangle:null},h=n.length,c=this.view.spatialReference,g=this.view.type==="3d"&&this.view.viewingMode==="global";switch(this.geometryType){case"point":r.regularVertices=o,r.activeVertex=s,r.full=this.drawOperation.coordinateHelper.arrayToPoint(n[0]);break;case"multipoint":r.regularVertices=o,r.activeVertex=s,h>0&&(r.full=Jt(n,c));break;case"polyline":r.regularVertices=o,r.activeVertex=s,h>0&&(r.full=He([n],c,g));break;case"polygon":r.regularVertices=o,r.activeVertex=s,h>0&&(r.full=j([n],c,g,!0));break;case"circle":if(h>0){const d=De(this.view,n[0]);if(h===1&&e.operationComplete){const y=n[0],_=d.makeMapPoint(y[0]+ke*this.view.resolution,y[1]);r.circle=Fe([y,_],d,!0),r.full=p(r.circle)?r.circle.geometry:null}else h===2&&(this.forceUniformSize?(r.circle=Fe(n,d,this.centered),r.full=p(r.circle)?r.circle.geometry:null):(r.rectangle=Xt(n,d,this.centered),r.full=r.rectangle.geometry))}break;case"rectangle":if(h>0){const d=De(this.view,n[0]);if(h===1&&e.operationComplete){const y=n[0],_=d.makeMapPoint(y[0]+ke*this.view.resolution,y[1]);r.rectangle=Ze([y,_],d,!0),r.full=r.rectangle.geometry}else h===2&&(r.rectangle=this.forceUniformSize?Ze(n,d,this.centered):Qt(n,d,this.centered),r.full=r.rectangle.geometry)}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":case"polygon":h>1&&(r.outline=He([n],c,g));break;case"circle":case"rectangle":p(r.full)&&r.full.type==="polygon"&&(r.outline=j(r.full.rings,c,g))}return r}initializeGraphic(e){return null}onComplete(e){this._updateGraphic();let i=null;if(this.drawOperation.isCompleted){const o=this._getCreateOperationGeometry({operationComplete:!0});p(o)&&(m(this._graphic)?this._createGraphic(o.full):this._graphic.geometry=o.full,i=We(this._graphic).clone())}this._createOperationGeometry=null,this.emit("complete",{graphic:i,...e})}onCursorUpdate(e){this._updateGraphic(),this.emit("cursor-update",e)}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}onVertexAdd(e){this._updateGraphic(),this.emit("vertex-add",e)}onVertexRemove(e){this._updateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateGraphic(),this.emit("vertex-update",e)}_updateGraphic(){const e=this._getCreateOperationGeometry();this._createOperationGeometry=e,m(e)?this._destroyAllVisualisations():(p(e.outline)?this.handles.add(this.onOutlineChanged(e.outline),V.outline):this.handles.remove(V.outline),p(e.regularVertices)?this.handles.add(this.onRegularVerticesChanged(e.regularVertices),V.regularVertices):this.handles.remove(V.regularVertices),p(e.activeVertex)?this.handles.add(this.onActiveVertexChanged(e.activeVertex),V.activeVertex):this.handles.remove(V.activeVertex),p(e.full)?m(this._graphic)?this._createGraphic(e.full):this._graphic.geometry=e.full:this.handles.remove(de))}get _tooltipInfo(){const{drawOperation:e}=this;if(!e)return null;switch(this.geometryType){case"point":return this._drawPointTooltipInfo;case"polyline":return this._drawPolylineTooltipInfo;case"polygon":return this._drawPolygonTooltipInfo;case"rectangle":return this._drawRectangleTooltipInfo;case"circle":return this._drawCircleTooltipInfo;default:return null}}get _drawPointTooltipInfo(){const e=Le(this.graphic,i=>i.geometry);return m(e)||e.type!=="point"||this.view.type==="2d"&&this.defaultZ===0?null:new D({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:this.view.type,helpMessage:he("point",e)})}get _drawPolylineTooltipInfo(){const e=this._createOperationGeometry,i=p(e)?e.full:null;if(m(i)||i.type!=="polyline")return null;const o=Rt(i,this._elevationMode);return new C({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,totalLength:M(o,I),viewType:this.view.type,helpMessage:he("polyline",i)})}get _drawPolygonTooltipInfo(){const e=this._createOperationGeometry,i=p(e)?e.full:null;if(m(i)||i.type!=="polygon")return null;const o=Ie(i,this._elevationMode);return new R({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,area:M(o,N),viewType:this.view.type,helpMessage:he("polygon",i)})}get _drawRectangleTooltipInfo(){return m(this.drawOperation)?null:new H({tooltipOptions:this.tooltipOptions,xSize:M(this._xSize,I),ySize:M(this._ySize,I),area:M(this._fullGeometryArea,N)})}get _drawCircleTooltipInfo(){if(m(this.drawOperation))return null;const e=this.forceUniformSize;return new P({tooltipOptions:this.tooltipOptions,radius:e?M(this._circleRadius,I):null,xSize:e?null:M(this._xSize,I),ySize:e?null:M(this._ySize,I),area:M(this._fullGeometryArea,N)})}get _circleRadius(){const e=this._createOperationGeometry;return p(e)&&p(e.circle)&&p(e.circle.center)&&p(e.circle.edge)?pe(e.circle.center,e.circle.edge,this._elevationMode):null}get _xSize(){const e=this._createOperationGeometry;if(m(e)||m(e.rectangle))return null;const{midpoints:i}=e.rectangle;return p(i)?pe(i.left,i.right,this._elevationMode):null}get _ySize(){const e=this._createOperationGeometry;if(m(e)||m(e.rectangle))return null;const{midpoints:i}=e.rectangle;return p(i)?pe(i.top,i.bottom,this._elevationMode):null}get _fullGeometryArea(){const e=this._createOperationGeometry,i=p(e)?e.full:null;return m(i)||i.type!=="polygon"?null:Ie(i,this._elevationMode)}get _elevationTooltipDetail(){return{mode:this.drawOperation.elevationInfo.mode,...this._vertexTooltipElevation}}get _vertexTooltipElevation(){const{tooltipOptions:e,view:i,drawOperation:o}=this;if(m(o))return this._defaultElevation;const n=o.stagedVertex??o.lastVertex;if(m(n)||i.type==="2d")return this._defaultElevation;const s={mode:e.elevation.mode,offset:0},r=(ye(i,n,o.elevationInfo,s)??0)*ct(n.spatialReference);return _e(r,"meters")}get _elevationMode(){return this.drawOperation.isDraped?"on-the-ground":"absolute-height"}};a([l()],u.prototype,"_createOperationGeometry",void 0),a([l()],u.prototype,"_defaultElevation",null),a([l({value:!0})],u.prototype,"centered",null),a([l({nonNullable:!0})],u.prototype,"defaultZ",void 0),a([l()],u.prototype,"drawOperation",void 0),a([l({value:!0})],u.prototype,"enabled",null),a([l({value:!0})],u.prototype,"forceUniformSize",null),a([l({constructOnly:!0})],u.prototype,"geometryType",void 0),a([l()],u.prototype,"graphic",null),a([l({constructOnly:!0})],u.prototype,"graphicProperties",void 0),a([l()],u.prototype,"graphicSymbol",null),a([l({constructOnly:!0})],u.prototype,"hasZ",void 0),a([l({constructOnly:!0,type:re})],u.prototype,"labelOptions",void 0),a([l({constructOnly:!0})],u.prototype,"mode",void 0),a([l()],u.prototype,"snappingManager",void 0),a([l()],u.prototype,"snapToScene",void 0),a([l()],u.prototype,"tooltip",void 0),a([l({constructOnly:!0,type:ne})],u.prototype,"tooltipOptions",void 0),a([l({readOnly:!0})],u.prototype,"type",void 0),a([l({readOnly:!0})],u.prototype,"updating",null),a([l({constructOnly:!0,nonNullable:!0})],u.prototype,"view",void 0),a([l()],u.prototype,"_tooltipInfo",null),a([l()],u.prototype,"_drawPointTooltipInfo",null),a([l()],u.prototype,"_drawPolylineTooltipInfo",null),a([l()],u.prototype,"_drawPolygonTooltipInfo",null),a([l()],u.prototype,"_drawRectangleTooltipInfo",null),a([l()],u.prototype,"_drawCircleTooltipInfo",null),a([l()],u.prototype,"_circleRadius",null),a([l()],u.prototype,"_xSize",null),a([l()],u.prototype,"_ySize",null),a([l()],u.prototype,"_fullGeometryArea",null),a([l()],u.prototype,"_elevationTooltipDetail",null),a([l()],u.prototype,"_vertexTooltipElevation",null),a([l()],u.prototype,"_elevationMode",null),u=a([F("esri.views.draw.DrawGraphicTool")],u);const de="create-operation-graphic",V={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function Wi(t){switch(t){case"point":case"polyline":case"polygon":case"multipoint":return t;case"circle":case"rectangle":return"segment"}}const ke=48,Ke="click";class Kt{constructor({grabbableForEvent:e}){this.events=new me,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=e}intersectionDistance(e,i){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}}let f=class extends me.EventedMixin(st){constructor(t){super(t),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this.isDraped=!0,this.labelOptions=new re,this.tooltipOptions=new ne,this.snapToSceneEnabled=null,this.lastVertex=null,m(t.elevationInfo)&&(this.elevationInfo=dt(!!t.hasZ))}initialize(){const{geometryType:t,view:e}=this,i=e.spatialReference,o="viewingMode"in e.state?e.state.viewingMode:zt.Local,n=t==="segment"||t==="multipoint"?"polyline":t;this.coordinateHelper=Et(this.hasZ,this.hasM,i),this._editGeometryOperations=new Dt(new Ht(n,this.coordinateHelper)),this._snappingOperation=new Ut({view:e,constrainResult:r=>{var h;return m(r)?r:(h=this._getEffectiveDrawSurface())==null?void 0:h.constrainZ(r)}}),this.handles.add(te(()=>this.stagedVertex,r=>{m(r)||this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(r)}],operation:"apply",type:"vertex-update"})},{sync:!0,equals:(r,h)=>lt(r,h,Re)})),this._activeComponent=new Zt(i,o),this._editGeometryOperations.data.components.push(this._activeComponent);const s=this.segmentLabels;p(s)&&(s.context={view:e,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.handles.add([te(()=>this.labelOptions.enabled,r=>{s.visible=r},ue),this.on("cursor-update",()=>{const r=this.stagedVertex;s.stagedVertex=p(r)?this.coordinateHelper.pointToVector(r):null})])),this.handles.add(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],r=>{const h=r.vertices.map(y=>({componentIndex:0,vertexIndex:y.index,coordinates:this.coordinateHelper.vectorToArray(y.pos)})),c=h.map(y=>y.coordinates);switch(r.type){case"vertex-add":this.emit(r.type,{...r,added:c,vertices:h});break;case"vertex-update":this.emit(r.type,{...r,updated:c,vertices:h});break;case"vertex-remove":this.emit(r.type,{...r,removed:c,vertices:h})}const g=this._activeComponent.getLastVertex(),d=p(g)?this.coordinateHelper.vectorToDehydratedPoint(g.pos):null;(m(d)||m(this.lastVertex)||!Re(this.lastVertex,d))&&(this.lastVertex=d)})),this._manipulator=new Kt({grabbableForEvent:r=>this.drawingMode!=="click"||r.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1}),this.manipulators.add(this._manipulator),this._manipulator.grabbable=t!=="point",this.handles.add([this._createManipulatorDragPipeline(this._manipulator),this._manipulator.events.on("immediate-click",r=>this._onImmediateClick(r)),this._manipulator.events.on("immediate-double-click",r=>this._onImmediateDoubleClick(r))]),vt(this,()=>{const r=M(this.view.inputManager.latestPointerType,"mouse"),h=this._getSnappingContext(r);p(this.snappingManager)&&this.updatingHandles.addPromise($e(this._snappingOperation.resnap(this.snappingManager,h)))})}destroy(){G(this.segmentLabels),G(this._snappingOperation),this._editGeometryOperations=G(this._editGeometryOperations)}get _snappingEnabled(){return p(this.snappingManager)&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const t=this._getEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==t}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map(t=>this.coordinateHelper.vectorToArray(t.pos))}set drawingMode(t){this._set("drawingMode",t??Ke)}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return p(this.stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get snappingOptions(){return p(this.snappingManager)?this.snappingManager.options:null}get stagedVertex(){return this._snappingOperation.stagedPoint}set stagedVertex(t){this._snappingOperation.stagedPoint=Ae(t)}get updating(){return this.updatingHandles.updating}get vertices(){const t=this.committedVertices;return p(this.stagedVertex)&&t.push(this.coordinateHelper.pointToArray(this.stagedVertex)),t}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingOperation.abort(),p(this.stagedVertex)){const{stagedVertex:t}=this;this.stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t))}}complete(t){const e=t&&t.aborted||!1;this._snappingOperation.abort(),p(this.snappingManager)&&this.snappingManager.doneSnapping(),this.geometryType==="segment"||this.geometryType==="point"?this.commitStagedVertex():this.stagedVertex=null;const i=this.geometryType==="multipoint"&&this.numVertices===0||this.geometryType==="polyline"&&this.numVertices<2||this.geometryType==="polygon"&&this.numVertices<3;this._createOperationCompleted=!i,(this.isCompleted||e)&&this.emit("complete",{vertices:this.vertices.map((o,n)=>({componentIndex:0,vertexIndex:n,coordinates:o})),aborted:e,type:"complete"})}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){p(this.snappingManager)&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(t){const e=this._activeComponent;if(this.geometryType==="polygon"&&e.vertices.length>2){if(this._vertexWithinPointerDistance(e.vertices[0].pos,t))return 0;if(this._vertexWithinPointerDistance(e.vertices[e.vertices.length-1].pos,t))return e.vertices.length-1}return null}_createManipulatorDragPipeline(t){switch(We(this.drawingMode)){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return le(t,(e,i,o,n)=>{const s=n==="touch"&&this._snappingEnabled;if(this.isCompleted||!s)return;const{snappingStep:r,cancelSnapping:h}=At({predicate:()=>s,snappingManager:this.snappingManager,snappingContext:new Pe({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:n,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles,useZ:!this._requiresScenePoint});o=o.next(c=>(s&&p(this.snappingManager)&&this.snappingManager.doneSnapping(),c)).next(h),i.next(this._screenToMapDragEventStep()).next(c=>(c.action==="start"&&(this.stagedVertex=c.mapStart,(this.geometryType==="segment"||s&&this.numVertices===0)&&this.commitStagedVertex()),c)).next(Ct(this.view,this.elevationInfo)).next(...r).next(c=>(s&&(this.stagedVertex=c.mapEnd,c.action==="end"&&this.commitStagedVertex()),c)).next(c=>(c.action==="end"&&(this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),c))})}_createManipulatorDragPipelineFreehand(t){return le(t,(e,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(o=>(o.action==="start"&&(m(this.stagedVertex)&&(this.stagedVertex=o.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),o)).next(o=>{switch(o.action){case"start":case"update":this.stagedVertex=o.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return o})})}_createManipulatorDragPipelineHybrid(t){return le(t,(e,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(o=>(o.action==="start"&&(m(this.stagedVertex)&&(this.stagedVertex=o.mapStart),this.commitStagedVertex()),o)).next(o=>{switch(o.action){case"start":case"update":this.stagedVertex=o.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return o})})}get _drawAtFixedElevation(){return(this.geometryType==="segment"||this.geometryType==="polygon")&&this.numCommittedVertices>0}_getEffectiveDrawSurface(){if(m(this.elevationDrawSurface))return this.drawSurface;if(!this.coordinateHelper.hasZ())return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let t=this.defaultZ,e=!1;return p(this.elevationInfo)&&this.elevationInfo.mode==="absolute-height"&&(e=!0),p(this.snapToSceneEnabled)&&(e=this.snapToSceneEnabled),p(this.elevationInfo)&&this.elevationInfo.mode==="on-the-ground"&&(e=!1),this._drawAtFixedElevation&&(t=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),e=!1),e?this.drawSurface:(this.elevationDrawSurface.defaultZ=t,this.elevationDrawSurface)}_mapToScreen(t){var e;return(e=this._getEffectiveDrawSurface())==null?void 0:e.mapToScreen(t)}_onHold(t){this._snappingOperation.abort(),this.drawingMode==="click"&&t.pointerType==="touch"&&this._snappingEnabled&&(this.stagedVertex=t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if(t.pointerType==="mouse"&&t.button===2||this._manipulator.dragging)return;const e=this._activeComponent,i=this._closeOnClickVertexIndex(t.screenPoint);if(p(i))return t.stopPropagation(),void this.complete();const o=this._screenToMap(t.screenPoint);if(p(o))switch(this.drawingMode){case"freehand":this.geometryType==="point"&&(p(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(o)),this.complete());break;case"click":case"hybrid":this._snappingOperation.abort(),p(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(o)),(this.geometryType==="point"||this.geometryType==="segment"&&e.vertices.length===2||this.geometryType==="segment"&&this.drawingMode==="hybrid"&&e.vertices.length===1)&&this.complete()}t.stopPropagation()}_onImmediateDoubleClick(t){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),t.stopPropagation())}_onPointerMove(t){var c;const e=Gt(t.x,t.y),i=this._snappingOperation;if(this._manipulator.dragging||this._pointerDownStates.has(t.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return void i.abort();t.stopPropagation();const o=this._closeOnClickVertexIndex(e);if(p(o))return this._closeOnVertex(o),void i.abort();const n=this._screenToMap(e),s=this._requiresScenePoint?(c=this.drawSurface)==null?void 0:c.screenToMap(e):null;if(this._manipulator.cursor=p(n)?"crosshair":null,m(n))return void i.abort();const r=this.snappingManager;if(m(r))return this.stagedVertex=n,void i.abort();const h=this._getSnappingContext(t.pointerType);this.updatingHandles.addPromise($e(i.snap({point:n,scenePoint:s},r,h)))}_closeOnVertex(t){this.stagedVertex=null;const e={componentIndex:0,vertexIndex:t,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[t].pos)};this.emit("cursor-update",{updated:null,vertices:[e],operation:"apply",type:"vertex-update"})}_screenToMap(t){var e;return(e=this._getEffectiveDrawSurface())==null?void 0:e.screenToMap(t)}_screenToMapDragEventStep(){let t=null;return e=>{if(e.action==="start"&&(t=this._screenToMap(e.screenStart)),m(t))return null;const i=this._screenToMap(e.screenEnd);return p(i)?{...e,mapStart:t,mapEnd:i}:null}}_vertexWithinPointerDistance(t,e){const o=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return!!p(o)&&ei(o,e,25)}_getSnappingContext(t){const e=this._drawAtFixedElevation?Le(this.elevationDrawSurface,({defaultZ:i})=>i):null;return new Pe({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t,visualizer:this.snappingVisualizer,selfSnappingZ:p(e)?{value:e,elevationInfo:this.elevationInfo}:null})}};function ei(t,e,i){const o=t.x-e.x,n=t.y-e.y;return o*o+n*n<=i}a([l()],f.prototype,"_snappingEnabled",null),a([l()],f.prototype,"defaultZ",void 0),a([l()],f.prototype,"isDraped",void 0),a([l({value:Ke})],f.prototype,"drawingMode",null),a([l({constructOnly:!0})],f.prototype,"elevationDrawSurface",void 0),a([l({constructOnly:!0})],f.prototype,"elevationInfo",void 0),a([l({constructOnly:!0,type:re})],f.prototype,"labelOptions",void 0),a([l({constructOnly:!0,type:ne})],f.prototype,"tooltipOptions",void 0),a([l({constructOnly:!0})],f.prototype,"geometryType",void 0),a([l({constructOnly:!0})],f.prototype,"hasM",void 0),a([l({constructOnly:!0})],f.prototype,"hasZ",void 0),a([l({constructOnly:!0})],f.prototype,"manipulators",void 0),a([l({constructOnly:!0})],f.prototype,"drawSurface",void 0),a([l({constructOnly:!0})],f.prototype,"segmentLabels",void 0),a([l({constructOnly:!0})],f.prototype,"snappingManager",void 0),a([l({constructOnly:!0})],f.prototype,"snappingVisualizer",void 0),a([l()],f.prototype,"snapToSceneEnabled",void 0),a([l()],f.prototype,"_snappingOperation",void 0),a([l()],f.prototype,"stagedVertex",null),a([l()],f.prototype,"lastVertex",void 0),a([l()],f.prototype,"updating",null),a([l({constructOnly:!0})],f.prototype,"view",void 0),f=a([F("esri.views.draw.DrawOperation")],f);class Li{constructor(e,i,o,n=null){this._elevationInfo=e,this.defaultZ=i,this._view=o,this._excludeGraphics=n}screenToMap(e){if(p(this.defaultZ))return this._view.sceneIntersectionHelper.intersectElevationFromScreen(Ce(e.x,e.y),this._elevationInfo,this.defaultZ,this._excludeGraphics);const i=this._view.sceneIntersectionHelper.intersectElevationFromScreen(Ce(e.x,e.y),this._elevationInfo,0,this._excludeGraphics);return p(i)&&(i.z=void 0),i}mapToScreen(e){const i=Je(e.x,e.y,ye(this._view,e,this._elevationInfo),e.spatialReference);return this._view.toScreen(i)}constrainZ(e){const{defaultZ:i}=this;return p(i)&&e.z!==i&&((e=je(e)).z=i),e}}class Ui{constructor(e,i,o=[]){this.view=e,this.elevationInfo=i,this.exclude=o}screenToMap(e){const i=this.view.toMap(e,{exclude:this.exclude});return p(i)&&(i.z=ut(i,this.view,this.elevationInfo)),i}mapToScreen(e){let i=e;return p(this.elevationInfo)&&(i=Je(e.x,e.y,ye(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(i)}constrainZ(e){return e}}class Ai{constructor(e,i=!1,o=0){this.view=e,this.hasZ=i,this.defaultZ=o,this.mapToScreen=n=>e.toScreen(n),this.screenToMap=i?n=>{const s=e.toMap(n);return s.z=o,s}:n=>e.toMap(n)}constrainZ(e){const{defaultZ:i}=this;return this.hasZ&&e.z!==i&&((e=je(e)).z=i),e}}function Ni(t,e){return et(t,e,!1)}function qi(t,e){return et(t,e,!0)}function et(t,e,i){if(t instanceof Ft){if(t.operation instanceof kt)return ti(t.operation,e,i),!0;if(t.operation instanceof Wt)return ii(t.operation,e,i),!0;if(t.operation instanceof Lt)return oi(t.operation,e,i),!0}return!1}function ti(t,e,i=!1){const o=i?-1:1,n=gt(o*t.dx,o*t.dy,o*t.dz);B(e.origin,e.origin,n)}function ii(t,e,i=!1){const o=i?-t.angle:t.angle;be(e.basis1,e.basis1,Oe,o),be(e.basis2,e.basis2,Oe,o)}function oi(t,e,i=!1){const o=i?1/t.factor1:t.factor1,n=i?1/t.factor2:t.factor2;q(e.basis1,e.basis1,o),q(e.basis2,e.basis2,n),Ge(e.origin,e.origin,t.origin,t.axis1,o),Ge(e.origin,e.origin,t.origin,t.axis2,n)}function ji(t,e,i,o){o||(o=Ye());const n=L(Y.get(),t[1],-t[0]),s=L(Y.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=L(Y.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),h=Y.get();e.components.forEach(d=>d.vertices.forEach(y=>{const _=y.pos;L(h,ze(t,_),ze(n,_)),Nt(s,s,h),qt(r,r,h)}));const c=1e-6,g=L(Y.get(),r[0]-s[0]<c?i/2:0,r[1]-s[1]<c?i/2:0);return jt(s,s,g),ce(r,r,g),Ee(o.basis1,t,(r[0]-s[0])/2),Ee(o.basis2,n,(r[1]-s[1])/2),L(o.origin,s[0]*t[0]+s[1]*n[0],s[0]*t[1]+s[1]*n[1]),ce(o.origin,o.origin,o.basis1),ce(o.origin,o.origin,o.basis2),o}function Yi(t,e,i,o=0,n){n||(n=Ye()),e.toRenderCoords(t.origin,i,n.origin);const s=w.get();B(s,t.origin,t.basis1),B(s,s,t.basis2),e.toRenderCoords(s,i,s);const r=w.get();B(r,t.origin,t.basis1),O(r,r,t.basis2),e.toRenderCoords(r,i,r);const h=w.get();O(h,t.origin,t.basis1),O(h,h,t.basis2),e.toRenderCoords(h,i,h);const c=w.get();O(c,t.origin,t.basis1),B(c,c,t.basis2),e.toRenderCoords(c,i,c);const g=E(w.get(),s,r,.5);O(g,g,n.origin);const d=E(w.get(),h,c,.5);O(d,n.origin,d),E(n.basis1,g,d,.5);const y=E(w.get(),c,s,.5);O(y,y,n.origin);const _=E(w.get(),r,h,.5);O(_,n.origin,_),E(n.basis2,y,_,.5);const z=ge(w.get(),n.basis1,n.basis2),x=ge(z,z,n.basis1);return qe(x,x),q(n.basis2,x,Ne(n.basis2,x)),q(n.basis1,n.basis1,1+o/Me(n.basis1)),q(n.basis2,n.basis2,1+o/Me(n.basis2)),ft(n),n}function Bi(t,e,i,o){const n=w.get();O(n,O(n,t.origin,t.basis1),t.basis2);const s=w.get();se(s,n,t.basis1,2);const r=w.get();se(r,s,t.basis2,2);const h=w.get();se(h,n,t.basis2,2),n[2]=s[2]=r[2]=h[2]=e;const c=o?"on-the-ground":"absolute-height",g=we(X(n,s,i,c),X(h,r,i,c)),d=we(X(s,r,i,c),X(n,h,i,c));return m(d)||m(g)?null:[g,d]}export{ji as A,Wi as B,Yi as G,u as H,Bi as M,Ni as S,qi as Y,Ai as a,Ui as c,f as k,Li as o};

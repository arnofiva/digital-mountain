import{u as J,e as i,y as n,a as C}from"./cast-8b575ab3.js";import"./geometry-bad16232.js";import{j as F}from"./Collection-47946fa8.js";import{l as U}from"./CollectionFlattener-9bc75576.js";import{r as w}from"./typedArrayUtil-ce39e5f4.js";import{O as W}from"./MultiOriginJSONSupport-a1d33be9.js";import{w as A}from"./promiseUtils-e37fe75d.js";import{a as L,U as k,l as R,j as _}from"./reactiveUtils-042dd05a.js";import{r as M,E as D,U as q,u as H}from"./request-fc61835a.js";import{b as V}from"./ArrayPool-5813d861.js";import{f as G,a as I,o as P,r as B}from"./Extent-680ef92a.js";import{b as Q}from"./Layer-b29c44e3.js";import{a as X}from"./BlendLayer-291a2b49.js";import{c as Y,f as Z}from"./OperationalLayer-c3a14c54.js";import{_ as ee}from"./PortalLayer-7f6f61d4.js";import{p as te}from"./RefreshableLayer-51d28698.js";import{t as re}from"./ScaleRangeLayer-7ff6c0d3.js";import{n as oe}from"./Evented-d959ede6.js";import{m as ie}from"./Loadable-695031ac.js";import{p as v,u as se}from"./string-7a324480.js";import{r as le}from"./Error-685fdf30.js";import"./PopupTemplate-8ac0cb61.js";import{a as j,D as x,f as g,k as ne}from"./aaBoundingBox-04c58f5a.js";import{x as S}from"./Polyline-889037e7.js";import"./jsonUtils-b2e5d321.js";import"./FeatureSet-cb704b51.js";import"./nextTick-3ee5a785.js";import"./typeUtils-700e0da4.js";import"./SimpleObservable-6f002ab0.js";import"./preload-helper-41c905a7.js";import"./Ellipsoid-89682c5e.js";import"./Identifiable-96150ecf.js";import"./colorUtils-639f4d25.js";import"./screenUtils-410d12c0.js";import"./mat4f32-60a2394b.js";import"./mat4-4714ff8c.js";import"./vec3-015ca254.js";import"./common-d0b63c2d.js";import"./TimeExtent-d116f9c4.js";import"./persistableUrlUtils-1c5d7615.js";import"./ElevationInfo-ad190ee6.js";import"./fieldUtils-1ecec444.js";import"./arcadeOnDemand-a1bf65ec.js";import"./lengthUtils-1d09729e.js";import"./opacityUtils-6b5cbdc2.js";import"./asyncUtils-623987a8.js";import"./layerUtils-0c01cb0c.js";import"./Portal-7ecdc9f0.js";import"./locale-30120714.js";import"./PortalGroup-ea788274.js";import"./PortalUser-a1aa49cd.js";import"./PortalItem-6549afda.js";import"./assets-5052bbaa.js";import"./Promise-e757e514.js";import"./portalItemUtils-ba37e370.js";import"./projection-582e07d8.js";import"./mathUtils-5b623c84.js";import"./vec4-c7a19f0d.js";import"./aaBoundingRect-41e05474.js";import"./zscale-def794ea.js";import"./Clonable-2b8b60cc.js";import"./enumeration-4ec8d3f9.js";import"./number-134e9f14.js";import"./UniqueValueRenderer-3904f4cc.js";import"./symbols-0f3de684.js";import"./CIMSymbol-cdddfd9c.js";import"./Color-ad49dc79.js";import"./symbolLayerUtils3D-51cc6d75.js";import"./Symbol3DAnchorPosition2D-142c1e90.js";import"./collectionUtils-25147e5f.js";import"./LegendOptions-de492976.js";import"./diffUtils-0c65d604.js";import"./colorRamps-ddfecb23.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-a1979e31.js";import"./Graphic-96c42a4d.js";import"./jsonUtils-03437bcd.js";import"./compilerUtils-175b9e40.js";import"./jsonUtils-e877a23b.js";import"./styleUtils-305d8f69.js";import"./DictionaryLoader-1438695d.js";import"./LRUCache-16cff7d8.js";import"./MemCache-1d0e264b.js";import"./deprecate-9828d7d2.js";import"./heatmapUtils-bc76f08e.js";import"./vec4f64-6d0e93be.js";import"./Field-1bc3a16a.js";import"./fieldType-232282e5.js";const ae={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function T(e){const t=e.folders||[],o=t.slice(),r=new Map,s=new Map,h=new Map,d=new Map,c=new Map,m={esriGeometryPoint:s,esriGeometryPolyline:h,esriGeometryPolygon:d};(e.featureCollection&&e.featureCollection.layers||[]).forEach(l=>{const p=v(l);p.featureSet.features=[];const y=l.featureSet.geometryType;r.set(y,p);const E=l.layerDefinition.objectIdField;y==="esriGeometryPoint"?$(s,E,l.featureSet.features):y==="esriGeometryPolyline"?$(h,E,l.featureSet.features):y==="esriGeometryPolygon"&&$(d,E,l.featureSet.features)}),e.groundOverlays&&e.groundOverlays.forEach(l=>{c.set(l.id,l)}),t.forEach(l=>{l.networkLinkIds.forEach(p=>{const y=ue(p,l.id,e.networkLinks);y&&o.push(y)})}),o.forEach(l=>{if(l.featureInfos){l.points=v(r.get("esriGeometryPoint")),l.polylines=v(r.get("esriGeometryPolyline")),l.polygons=v(r.get("esriGeometryPolygon")),l.mapImages=[];for(const p of l.featureInfos)switch(p.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const y=m[p.type].get(p.id);y&&l[ae[p.type]].featureSet.features.push(y);break}case"GroundOverlay":{const y=c.get(p.id);y&&l.mapImages.push(y);break}}l.fullExtent=O([l])}});const f=O(o);return{folders:t,sublayers:o,extent:f}}function N(e,t,o,r){const s=M&&M.findCredential(e);e=D(e,{token:s&&s.token});const h=le.kmlServiceUrl;return q(h,{query:{url:e,model:"simple",folders:"",refresh:o!==0||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:r})}function K(e,t,o=null,r=[]){const s=[],h={},d=t.sublayers,c=t.folders.map(m=>m.id);return d.forEach(m=>{var l;const f=new e;if(o?f.read(m,o):f.read(m),r.length&&c.includes(f.id)&&(f.visible=r.includes(f.id)),h[m.id]=f,m.parentFolderId!=null&&m.parentFolderId!==-1){const p=h[m.parentFolderId];p.sublayers||(p.sublayers=[]),(l=p.sublayers)==null||l.unshift(f)}else s.unshift(f)}),s}function $(e,t,o){o.forEach(r=>{e.set(r.attributes[t],r)})}function pe(e,t){let o;return t.some(r=>r.id===e&&(o=r,!0)),o}function ue(e,t,o){const r=pe(e,o);return r&&(r.parentFolderId=t,r.networkLink=r),r}function O(e){const t=j(x),o=j(x);for(const r of e){if(r.polygons&&r.polygons.featureSet&&r.polygons.featureSet.features)for(const s of r.polygons.featureSet.features)S(t,s.geometry),g(o,t);if(r.polylines&&r.polylines.featureSet&&r.polylines.featureSet.features)for(const s of r.polylines.featureSet.features)S(t,s.geometry),g(o,t);if(r.points&&r.points.featureSet&&r.points.featureSet.features)for(const s of r.points.featureSet.features)S(t,s.geometry),g(o,t);if(r.mapImages)for(const s of r.mapImages)S(t,s.extent),g(o,t)}return ne(o,x)?void 0:{xmin:o[0],ymin:o[1],zmin:o[2],xmax:o[3],ymax:o[4],zmax:o[5],spatialReference:G.WGS84}}var b;let u=b=class extends oe.EventedMixin(J(ie)){constructor(...e){super(...e),this.description=null,this.id=null,this.networkLink=null,this.sublayers=null,this.title=null,this.sourceJSON=null,this.fullExtent=null,this.addHandles([L(()=>this.sublayers,"after-add",({item:t})=>{t.parent=this,t.layer=this.layer},k),L(()=>this.sublayers,"after-remove",({item:t})=>{t.layer=t.parent=null},k),R(()=>this.sublayers,(t,o)=>{if(o)for(const r of o)r.layer=r.parent=null;if(t)for(const r of t)r.parent=this,r.layer=this.layer},k)])}initialize(){_(()=>this.networkLink).then(()=>_(()=>this.visible===!0)).then(()=>this.load())}load(e){var r;if(!this.networkLink||this.networkLink.viewFormat)return;const t=w(e)?e.signal:null,o=this._fetchService(((r=this._get("networkLink"))==null?void 0:r.href)??"",t).then(s=>{var c;const h=O(s.sublayers);this.fullExtent=I.fromJSON(h),this.sourceJSON=s;const d=V(F.ofType(b),K(b,s));this.sublayers?this.sublayers.addMany(d):this.sublayers=d,(c=this.layer)==null||c.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")});return this.addResolvingPromise(o),Promise.resolve(this)}get visible(){return this._get("visible")}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}readVisible(e,t){return!!t.visibility}set layer(e){this._set("layer",e),this.sublayers&&this.sublayers.forEach(t=>t.layer=e)}_fetchService(e,t){return N(e,this.layer.outSpatialReference,this.layer.refreshInterval,t).then(o=>T(o.data))}};i([n()],u.prototype,"description",void 0),i([n()],u.prototype,"id",void 0),i([n({readOnly:!0,value:null})],u.prototype,"networkLink",void 0),i([n({json:{write:{allowNull:!0}}})],u.prototype,"parent",void 0),i([n({type:F.ofType(b),json:{write:{allowNull:!0}}})],u.prototype,"sublayers",void 0),i([n({value:null,json:{read:{source:"name",reader:e=>se(e)}}})],u.prototype,"title",void 0),i([n({value:!0})],u.prototype,"visible",null),i([P("visible",["visibility"])],u.prototype,"readVisible",null),i([n()],u.prototype,"sourceJSON",void 0),i([n({value:null})],u.prototype,"layer",null),i([n({type:I})],u.prototype,"fullExtent",void 0),u=b=i([C("esri.layers.support.KMLSublayer")],u);const z=u,ye=["kml","xml"];let a=class extends X(te(re(Y(ee(W(Q)))))){constructor(...e){super(...e),this._visibleFolders=[],this.allSublayers=new U({getCollections:()=>[this.sublayers],getChildrenFunction:t=>t.sublayers}),this.outSpatialReference=G.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType="KML",this.sublayers=null,this.type="kml",this.url=null}initialize(){this.addHandles([R(()=>this.sublayers,(e,t)=>{t&&t.forEach(o=>{o.parent=null,o.layer=null}),e&&e.forEach(o=>{o.parent=this,o.layer=this})},k),this.on("sublayer-update",()=>this.notifyChange("fullExtent"))])}normalizeCtorArgs(e,t){return typeof e=="string"?{url:e,...t}:e}readSublayersFromItemOrWebMap(e,t){this._visibleFolders=t.visibleFolders}readSublayers(e,t,o){return K(z,t,o,this._visibleFolders)}writeSublayers(e,t){const o=[],r=e.toArray();for(;r.length;){const s=r[0];s.networkLink||(s.visible&&o.push(s.id),s.sublayers&&r.push(...s.sublayers.toArray())),r.shift()}t.visibleFolders=o}get title(){const e=this._get("title");return e&&this.originOf("title")!=="defaults"?e:this.url?H(this.url,ye)||"KML":e||""}set title(e){this._set("title",e)}get visibleSublayers(){const e=this.sublayers,t=[],o=r=>{r.visible&&(t.push(r),r.sublayers&&r.sublayers.forEach(o))};return e&&e.forEach(o),t}get fullExtent(){return this._recomputeFullExtent()}load(e){const t=w(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["KML"],supportsData:!1},e).catch(A).then(()=>this._fetchService(t))),Promise.resolve(this)}destroy(){super.destroy(),this.allSublayers.destroy()}async _fetchService(e){const t=await Promise.resolve().then(()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:N(this.url??"",this.outSpatialReference,this.refreshInterval,e)),o=T(t.data);o&&this.read(o,{origin:"service"})}_recomputeFullExtent(){let e=null;w(this.extent)&&(e=this.extent.clone());const t=o=>{if(o.sublayers)for(const r of o.sublayers.items)t(r),r.visible&&r.fullExtent&&(w(e)?e.union(r.fullExtent):e=r.fullExtent.clone())};return t(this),e}};i([n({readOnly:!0})],a.prototype,"allSublayers",void 0),i([n({type:G})],a.prototype,"outSpatialReference",void 0),i([n({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],a.prototype,"path",void 0),i([n({readOnly:!0,json:{read:!1,write:!1}})],a.prototype,"legendEnabled",void 0),i([n({type:["show","hide","hide-children"]})],a.prototype,"listMode",void 0),i([n({type:["KML"]})],a.prototype,"operationalLayerType",void 0),i([n({})],a.prototype,"resourceInfo",void 0),i([n({type:F.ofType(z),json:{write:{ignoreOrigin:!0}}})],a.prototype,"sublayers",void 0),i([P(["web-map","portal-item"],"sublayers",["visibleFolders"])],a.prototype,"readSublayersFromItemOrWebMap",null),i([P("service","sublayers",["sublayers"])],a.prototype,"readSublayers",null),i([B("sublayers")],a.prototype,"writeSublayers",null),i([n({readOnly:!0,json:{read:!1}})],a.prototype,"type",void 0),i([n({json:{origins:{"web-map":{read:{source:"title"}}},write:{ignoreOrigin:!0}}})],a.prototype,"title",null),i([n(Z)],a.prototype,"url",void 0),i([n({readOnly:!0})],a.prototype,"visibleSublayers",null),i([n({type:I})],a.prototype,"extent",void 0),i([n()],a.prototype,"fullExtent",null),a=i([C("esri.layers.KMLLayer")],a);const qt=a;export{qt as default};

import{n as K}from"./compilerUtils-175b9e40.js";import{s as j,a as Y}from"./Error-685fdf30.js";import{n as Z}from"./Evented-d959ede6.js";import{c as F,i as v}from"./mathUtils-5b623c84.js";import{t as p,c as J,R as B,H as D,r as f,p as Q}from"./typedArrayUtil-ce39e5f4.js";import{f as L,v as ee,a as te}from"./promiseUtils-e37fe75d.js";import{U as re,Z as H,c as ae,m as se}from"./request-fc61835a.js";import{i as ie}from"./TextureOnly.glsl-548e665f.js";import{D as O,c as M}from"./basicInterfaces-7449a8bf.js";import{_ as oe}from"./preload-helper-41c905a7.js";import{a as ne}from"./assets-5052bbaa.js";import{u as _,P as T,L as A,D as S,M as V,G as U,Y as he,V as le,E as me}from"./enums-fc527c7c.js";import{E as c}from"./Texture-bf6b5582.js";import{_ as de,j as pe,e as _e,x as ce,f as ue,n as Te}from"./VisualVariablePassParameters-8cb0a75a.js";import{s as ge}from"./Util-c12e93ba.js";import{r as Ae}from"./context-util-7ede29e5.js";async function Ee(a,e){const{data:r}=await re(a,{responseType:"image",...e});return r}function fe(){if(p($)){const a=e=>ne(`esri/libs/basisu/${e}`);$=oe(()=>import("./basis_transcoder-e0466ff6.js"),["./basis_transcoder-e0466ff6.js","./_commonjsHelpers-2f3e7994.js"],import.meta.url).then(e=>e.b).then(({default:e})=>e({locateFile:a}).then(r=>(r.initializeBasis(),delete r.then,r)))}return $}let $;var g;(function(a){a[a.ETC1_RGB=0]="ETC1_RGB",a[a.ETC2_RGBA=1]="ETC2_RGBA",a[a.BC1_RGB=2]="BC1_RGB",a[a.BC3_RGBA=3]="BC3_RGBA",a[a.BC4_R=4]="BC4_R",a[a.BC5_RG=5]="BC5_RG",a[a.BC7_M6_RGB=6]="BC7_M6_RGB",a[a.BC7_M5_RGBA=7]="BC7_M5_RGBA",a[a.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",a[a.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",a[a.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",a[a.ATC_RGB=11]="ATC_RGB",a[a.ATC_RGBA=12]="ATC_RGBA",a[a.FXT1_RGB=17]="FXT1_RGB",a[a.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",a[a.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",a[a.ETC2_EAC_R11=20]="ETC2_EAC_R11",a[a.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",a[a.RGBA32=13]="RGBA32",a[a.RGB565=14]="RGB565",a[a.BGR565=15]="BGR565",a[a.RGBA4444=16]="RGBA4444"})(g||(g={}));let d=null,P=null;async function b(){return p(P)&&(P=fe(),d=await P),P}function Re(a,e){if(p(d))return a.byteLength;const r=new d.BasisFile(new Uint8Array(a)),t=k(r)?X(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),e):0;return r.close(),r.delete(),t}function we(a,e){if(p(d))return a.byteLength;const r=new d.KTX2File(new Uint8Array(a)),t=z(r)?X(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),e):0;return r.close(),r.delete(),t}function X(a,e,r,t,s){const i=de(e?_.COMPRESSED_RGBA8_ETC2_EAC:_.COMPRESSED_RGB8_ETC2),o=s&&a>1?(4**a-1)/(3*4**(a-1)):1;return Math.ceil(r*t*i*o)}function k(a){return a.getNumImages()>=1&&!a.isUASTC()}function z(a){return a.getFaces()>=1&&a.isETC1S()}async function Ce(a,e,r){p(d)&&(d=await b());const t=new d.BasisFile(new Uint8Array(r));if(!k(t))return null;t.startTranscoding();const s=q(a,e,t.getNumLevels(0),t.getHasAlpha(),t.getImageWidth(0,0),t.getImageHeight(0,0),(i,o)=>t.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>t.transcodeImage(n,0,i,o,0,0));return t.close(),t.delete(),s}async function Be(a,e,r){p(d)&&(d=await b());const t=new d.KTX2File(new Uint8Array(r));if(!z(t))return null;t.startTranscoding();const s=q(a,e,t.getLevels(),t.getHasAlpha(),t.getWidth(),t.getHeight(),(i,o)=>t.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>t.transcodeImage(n,i,0,0,o,0,-1,-1));return t.close(),t.delete(),s}function q(a,e,r,t,s,i,o,n){const{compressedTextureETC:h,compressedTextureS3TC:l}=a.capabilities,[m,E]=h?t?[g.ETC2_RGBA,_.COMPRESSED_RGBA8_ETC2_EAC]:[g.ETC1_RGB,_.COMPRESSED_RGB8_ETC2]:l?t?[g.BC3_RGBA,_.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[g.BC1_RGB,_.COMPRESSED_RGB_S3TC_DXT1_EXT]:[g.RGBA32,T.RGBA],R=e.hasMipmap?r:Math.min(1,r),u=[];for(let C=0;C<R;C++)u.push(new Uint8Array(o(C,m))),n(C,m,u[C]);const w=u.length>1,I=w?A.LINEAR_MIPMAP_LINEAR:A.LINEAR,W={...e,samplingMode:I,hasMipmap:w,internalFormat:E,width:s,height:i};return new c(a,W,{type:"compressed",levels:u})}const G=j.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),De=542327876,Me=131072,Ge=4;function N(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function xe(a){return String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)}const Ie=N("DXT1"),Se=N("DXT3"),Pe=N("DXT5"),ye=31,Fe=0,Oe=1,$e=2,Ne=3,ve=4,Le=7,He=20,Ve=21;function Ue(a,e,r){const{textureData:t,internalFormat:s,width:i,height:o}=J(be(r,e.hasMipmap??!1));return e.samplingMode=t.levels.length>1?A.LINEAR_MIPMAP_LINEAR:A.LINEAR,e.hasMipmap=t.levels.length>1,e.internalFormat=s,e.width=i,e.height=o,new c(a,e,t)}function be(a,e){const r=new Int32Array(a,0,ye);if(r[Fe]!==De)return G.error("Invalid magic number in DDS header"),null;if(!(r[He]&Ge))return G.error("Unsupported format, must contain a FourCC code"),null;const t=r[Ve];let s,i;switch(t){case Ie:s=8,i=_.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Se:s=16,i=_.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Pe:s=16,i=_.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return G.error("Unsupported FourCC code:",xe(t)),null}let o=1,n=r[ve],h=r[Ne];!(3&n)&&!(3&h)||(G.warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,h=h+3&-4);const l=n,m=h;let E,R;r[$e]&Me&&e!==!1&&(o=Math.max(1,r[Le])),o===1||F(n)&&F(h)||(G.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let u=r[Oe]+4;const w=[];for(let I=0;I<o;++I)R=(n+3>>2)*(h+3>>2)*s,E=new Uint8Array(a,u,R),w.push(E),u+=R,n=Math.max(1,n>>1),h=Math.max(1,h>>1);return{textureData:{type:"compressed",levels:w},internalFormat:i,width:l,height:m}}class y extends pe{constructor(e,r){super(),this._data=e,this.type=_e.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new Z,this._passParameters=new ie,this.params=r||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:S.REPEAT,t:S.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||O.STRETCH,this.estimatedTexMemRequired=y._estimateTexMemRequired(this._data,this.params),this._startPreload()}_startPreload(){const e=this._data;p(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(H(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const r=!e.paused;if(e.src=e.src,r&&e.autoplay){const t=()=>{e.removeEventListener("canplay",t),e.play()};e.addEventListener("canplay",t)}}}_startPreloadImageElement(e){ae(e.src)||H(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static _getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static _estimateTexMemRequired(e,r){if(p(e))return 0;if(B(e)||D(e))return r.encoding===M.KTX2_ENCODING?we(e,!!r.mipmap):r.encoding===M.BASIS_ENCODING?Re(e,!!r.mipmap):e.byteLength;const{width:t,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?y._getDataDimensions(e):r;return(r.mipmap?4/3:1)*t*s*(r.components||4)||0}dispose(){this._data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(e){return{target:V.TEXTURE_2D,pixelFormat:T.RGBA,dataType:U.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?A.LINEAR_MIPMAP_LINEAR:A.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?e.parameters.maxMaxAnisotropy:1)}}get glTexture(){return this._glTexture}load(e,r){if(f(this._glTexture))return this._glTexture;if(f(this._loadingPromise))return this._loadingPromise;const t=this._data;return p(t)?(this._glTexture=new c(e,this._createDescriptor(e),null),this._glTexture):typeof t=="string"?this._loadFromURL(e,r,t):t instanceof Image?this._loadFromImageElement(e,r,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,r,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t,r):(B(t)||D(t))&&this.params.encoding===M.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,t)):(B(t)||D(t))&&this.params.encoding===M.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,t)):(B(t)||D(t))&&this.params.encoding===M.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,t)):D(t)?this._loadFromPixelData(e,t):B(t)?this._loadFromPixelData(e,new Uint8Array(t)):null}get requiresFrameUpdates(){return this._data instanceof HTMLVideoElement}frameUpdate(e,r,t){if(!(this._data instanceof HTMLVideoElement)||p(this._glTexture)||this._data.readyState<x.HAVE_CURRENT_DATA||t===this._data.currentTime)return t;if(f(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:i,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this._data),this._drawStretchedTexture(e,r,s,i,o,this._glTexture)}else{const{videoWidth:s,videoHeight:i}=this._data,{width:o,height:n}=this._glTexture.descriptor;s!==o||i!==n?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(i,n),this._data):this._glTexture.setData(this._data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this._data.currentTime}_loadFromDDSData(e,r){return this._glTexture=Ue(e,this._createDescriptor(e),r),this._glTexture}_loadFromKTX2(e,r){return this._loadAsync(()=>Be(e,this._createDescriptor(e),r).then(t=>(this._glTexture=t,t)))}_loadFromBasis(e,r){return this._loadAsync(()=>Ce(e,this._createDescriptor(e),r).then(t=>(this._glTexture=t,t)))}_loadFromPixelData(e,r){ge(this.params.width>0&&this.params.height>0);const t=this._createDescriptor(e);return t.pixelFormat=this.params.components===1?T.LUMINANCE:this.params.components===3?T.RGB:T.RGBA,t.width=this.params.width,t.height=this.params.height,this._glTexture=new c(e,t,r),this._glTexture}_loadFromURL(e,r,t){return this._loadAsync(async s=>{const i=await Ee(t,{signal:s});return L(s),this._loadFromImage(e,i,r)})}_loadFromImageElement(e,r,t){return t.complete?this._loadFromImage(e,t,r):this._loadAsync(async s=>{const i=await se(t,t.src,!1,s);return L(s),this._loadFromImage(e,i,r)})}_loadFromVideoElement(e,r,t){return t.readyState>=x.HAVE_CURRENT_DATA?this._loadFromImage(e,t,r):this._loadFromVideoElementAsync(e,r,t)}_loadFromVideoElementAsync(e,r,t){return this._loadAsync(s=>new Promise((i,o)=>{const n=()=>{t.removeEventListener("loadeddata",h),t.removeEventListener("error",l),Q(m)},h=()=>{t.readyState>=x.HAVE_CURRENT_DATA&&(n(),i(this._loadFromImage(e,t,r)))},l=E=>{n(),o(E||new Y("Failed to load video"))};t.addEventListener("loadeddata",h),t.addEventListener("error",l);const m=ee(s,()=>l(te()))}))}_loadFromImage(e,r,t){const s=y._getDataDimensions(r);this.params.width=s.width,this.params.height=s.height;const i=this._createDescriptor(e);return i.pixelFormat=this.params.components===3?T.RGB:T.RGBA,!this._requiresPowerOfTwo(e,i)||F(s.width)&&F(s.height)?(i.width=s.width,i.height=s.height,this._glTexture=new c(e,i,r),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,r,s,i,t),this._glTexture)}_loadAsync(e){const r=new AbortController;this._loadingController=r;const t=e(r.signal);this._loadingPromise=t;const s=()=>{this._loadingController===r&&(this._loadingController=null),this._loadingPromise===t&&(this._loadingPromise=null)};return t.then(s,s),t}_requiresPowerOfTwo(e,r){const t=S.CLAMP_TO_EDGE,s=typeof r.wrapMode=="number"?r.wrapMode===t:r.wrapMode.s===t&&r.wrapMode.t===t;return e.type===Ae.WEBGL1&&(r.hasMipmap||!s)}_makePowerOfTwoTexture(e,r,t,s,i){const{width:o,height:n}=t,h=v(o),l=v(n);let m;switch(s.width=h,s.height=l,this.params.powerOfTwoResizeMode){case O.PAD:s.textureCoordinateScaleFactor=[o/h,n/l],m=new c(e,s),m.updateData(0,0,0,o,n,r);break;case O.STRETCH:case null:case void 0:m=this._stretchToPowerOfTwo(e,r,s,i());break;default:K(this.params.powerOfTwoResizeMode)}return s.hasMipmap&&m.generateMipmap(),m}_stretchToPowerOfTwo(e,r,t,s){const i=new c(e,t),o=new ce(e,{colorTarget:he.TEXTURE,depthStencilTarget:le.NONE},i),n=new c(e,{target:V.TEXTURE_2D,pixelFormat:t.pixelFormat,dataType:U.UNSIGNED_BYTE,wrapMode:S.CLAMP_TO_EDGE,samplingMode:A.LINEAR,flipped:!!t.flipped,maxAnisotropy:8,preMultiplyAlpha:t.preMultiplyAlpha},r),h=ue(e),l=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,s,o,h,n,i),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:h,sourceTexture:n,framebuffer:o}:(h.dispose(!0),n.dispose(),o.detachColorTexture(),o.dispose()),e.bindFramebuffer(l),i}_drawStretchedTexture(e,r,t,s,i,o){this._passParameters.texture=i,e.bindFramebuffer(t);const n=e.getViewport();e.setViewport(0,0,o.descriptor.width,o.descriptor.height),e.bindTechnique(r,this._passParameters,null),e.bindVAO(s),e.drawArrays(me.TRIANGLE_STRIP,0,Te(s,"geometry")),e.bindFramebuffer(null),e.setViewport(n.x,n.y,n.width,n.height),this._passParameters.texture=null}unload(){if(f(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:r,sourceTexture:t}=this._powerOfTwoStretchInfo;r.dispose(!0),t.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(f(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),f(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}var x;(function(a){a[a.HAVE_NOTHING=0]="HAVE_NOTHING",a[a.HAVE_METADATA=1]="HAVE_METADATA",a[a.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",a[a.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",a[a.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(x||(x={}));export{y as G,b as c,Ee as t};

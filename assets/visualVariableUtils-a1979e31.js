import{l as D}from"./Color-ad49dc79.js";import{g as k}from"./Graphic-96c42a4d.js";import{n as T}from"./compilerUtils-175b9e40.js";import{s as U}from"./Error-685fdf30.js";import{t as g,r as w}from"./typedArrayUtil-ce39e5f4.js";import{m as q}from"./lengthUtils-1d09729e.js";import{e as I,l as z,i as x,n as E}from"./sizeVariableUtils-d4870b0d.js";import"./colorUtils-639f4d25.js";import"./mathUtils-5b623c84.js";import"./vec3-015ca254.js";import"./common-d0b63c2d.js";import"./vec4-c7a19f0d.js";import"./ArrayPool-5813d861.js";import"./string-7a324480.js";import"./cast-8b575ab3.js";import"./nextTick-3ee5a785.js";import"./promiseUtils-e37fe75d.js";import"./geometry-bad16232.js";import"./Extent-680ef92a.js";import"./Ellipsoid-89682c5e.js";import"./Polyline-889037e7.js";import"./typeUtils-700e0da4.js";import"./PopupTemplate-8ac0cb61.js";import"./Clonable-2b8b60cc.js";import"./Collection-47946fa8.js";import"./Evented-d959ede6.js";import"./SimpleObservable-6f002ab0.js";import"./fieldUtils-1ecec444.js";import"./preload-helper-41c905a7.js";import"./arcadeOnDemand-a1bf65ec.js";import"./enumeration-4ec8d3f9.js";import"./number-134e9f14.js";import"./locale-30120714.js";import"./Identifiable-96150ecf.js";import"./symbols-0f3de684.js";import"./CIMSymbol-cdddfd9c.js";import"./screenUtils-410d12c0.js";import"./opacityUtils-6b5cbdc2.js";import"./symbolLayerUtils3D-51cc6d75.js";import"./aaBoundingBox-04c58f5a.js";import"./aaBoundingRect-41e05474.js";import"./request-fc61835a.js";import"./persistableUrlUtils-1c5d7615.js";import"./Symbol3DAnchorPosition2D-142c1e90.js";import"./collectionUtils-25147e5f.js";import"./Portal-7ecdc9f0.js";import"./Loadable-695031ac.js";import"./Promise-e757e514.js";import"./PortalGroup-ea788274.js";import"./PortalUser-a1aa49cd.js";import"./jsonUtils-03437bcd.js";const y=U.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),M=new k,S=Math.PI,He=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function A(t,a,i){const e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(c=>c.type==="color"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const n=typeof a=="number",r=n?null:a,o=r&&r.attributes;let l=n?a:null;const s=e.field,{ipData:p,hasExpression:m}=e.cache;let u=e.cache.compiledFunc;if(!s&&!m){const c=e.stops;return c&&c[0]&&c[0].color}if(typeof l!="number")if(m){if(g(i)||g(i.arcade))return void y.error("Use of arcade expressions requires an arcade context");const c={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},f=i.arcade.arcadeUtils,h=f.getViewInfo(c),V=f.createExecContext(r,h);if(!u){const F=f.createSyntaxTree(e.valueExpression);u=f.createFunction(F),e.cache.compiledFunc=u}l=f.executeFunction(u,V)}else o&&(l=o[s]);const d=e.normalizationField,v=o!=null&&d!=null?parseFloat(o[d]):void 0;if(l!=null&&(!d||n||!isNaN(v)&&v!==0)){isNaN(v)||n||(l/=v);const c=C(l,p);if(c){const f=c[0],h=c[1],V=f===h?e.stops[f].color:D.blendColors(e.stops[f].color,e.stops[h].color,c[2],w(i)?i.color:void 0);return new D(V)}}}function O(t,a,i){const e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(c=>c.type==="opacity"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const n=typeof a=="number",r=n?null:a,o=r&&r.attributes;let l=n?a:null;const s=e.field,{ipData:p,hasExpression:m}=e.cache;let u=e.cache.compiledFunc;if(!s&&!m){const c=e.stops;return c&&c[0]&&c[0].opacity}if(typeof l!="number")if(m){if(g(i)||g(i.arcade))return void y.error("Use of arcade expressions requires an arcade context");const c={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},f=i.arcade.arcadeUtils,h=f.getViewInfo(c),V=f.createExecContext(r,h);if(!u){const F=f.createSyntaxTree(e.valueExpression);u=f.createFunction(F),e.cache.compiledFunc=u}l=f.executeFunction(u,V)}else o&&(l=o[s]);const d=e.normalizationField,v=o!=null&&d!=null?parseFloat(o[d]):void 0;if(l!=null&&(!d||n||!isNaN(v)&&v!==0)){isNaN(v)||n||(l/=v);const c=C(l,p);if(c){const f=c[0],h=c[1];if(f===h)return e.stops[f].opacity;{const V=e.stops[f].opacity;return V+(e.stops[h].opacity-V)*c[2]}}}}function L(t,a,i){const e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(v=>v.type==="rotation"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const n=e.axis||"heading",r=n==="heading"&&e.rotationType==="arithmetic"?90:0,o=n==="heading"&&e.rotationType==="arithmetic"?-1:1,l=typeof a=="number"?null:a,s=l&&l.attributes,p=e.field,{hasExpression:m}=e.cache;let u=e.cache.compiledFunc,d=0;if(!p&&!m)return d;if(m){if(g(i)||g(i.arcade))return void y.error("Use of arcade expressions requires an arcade context");const v={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},c=i.arcade.arcadeUtils,f=c.getViewInfo(v),h=c.createExecContext(l,f);if(!u){const V=c.createSyntaxTree(e.valueExpression);u=c.createFunction(V),e.cache.compiledFunc=u}d=c.executeFunction(u,h)}else s&&(d=s[p]||0);return d=typeof d!="number"||isNaN(d)?null:r+o*d,d}function P(t,a,i){const e=typeof a=="number",n=e?null:a,r=n&&n.attributes;let o=e?a:null;const{isScaleDriven:l}=t.cache;let s=t.cache.compiledFunc;if(l){const m=w(i)?i.scale:void 0,u=w(i)?i.view:void 0;o=m==null||u==="3d"?$(t):m}else if(!e)switch(t.inputValueType){case E.Expression:{if(g(i)||g(i.arcade))return void y.error("Use of arcade expressions requires an arcade context");const m={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},u=i.arcade.arcadeUtils,d=u.getViewInfo(m),v=u.createExecContext(n,d);if(!s){const c=u.createSyntaxTree(t.valueExpression);s=u.createFunction(c),t.cache.compiledFunc=s}o=u.executeFunction(s,v);break}case E.Field:r&&(o=r[t.field]);break;case E.Unknown:o=null}if(!z(o))return null;if(e||!t.normalizationField)return o;const p=r?parseFloat(r[t.normalizationField]):null;return z(p)&&p!==0?o/p:null}function $(t){let a=null,i=null;const e=t.stops;return e?(a=e[0].value,i=e[e.length-1].value):(a=t.minDataValue||0,i=t.maxDataValue||0),(a+i)/2}function R(t,a,i){const e="visualVariables"in t&&t.visualVariables?t.visualVariables.find(r=>r.type==="size"):t;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const n=K(P(e,a,i),e,a,i,e.cache.ipData);return n==null||isNaN(n)?0:n}function b(t,a,i){return t==null?null:I(t)?R(t,a,i):z(t)?t:null}function N(t,a,i){return z(i)&&t>i?i:z(a)&&t<a?a:t}function B(t,a,i,e){return t+((b(a.minSize,i,e)||a.minDataValue)??0)}function W(t,a,i){const e=t.stops;let n=e&&e.length&&e[0].size;return n==null&&(n=t.minSize),b(n,a,i)}function j(t,a,i,e){const n=(t-a.minDataValue)/(a.maxDataValue-a.minDataValue),r=b(a.minSize,i,e),o=b(a.maxSize,i,e),l=w(e)?e.shape:void 0;if(t<=a.minDataValue)return r;if(t>=a.maxDataValue)return o;if(r==null||o==null)return null;if(a.scaleBy==="area"&&l){const s=l==="circle",p=s?S*(r/2)**2:r*r,m=p+n*((s?S*(o/2)**2:o*o)-p);return s?2*Math.sqrt(m/S):Math.sqrt(m)}return r+n*(o-r)}function G(t,a,i,e){const n=w(e)?e.shape:void 0,r=t/a.minDataValue,o=b(a.minSize,i,e),l=b(a.maxSize,i,e);let s=null;return s=n==="circle"?2*Math.sqrt(r*(o/2)**2):n==="square"||n==="diamond"||n==="image"?Math.sqrt(r*o**2):r*o,N(s,o,l)}function H(t,a,i,e,n){var s,p,m;const[r,o,l]=C(t,n);if(r===o)return b((s=a.stops)==null?void 0:s[r].size,i,e);{const u=b((p=a.stops)==null?void 0:p[r].size,i,e);return u+(b((m=a.stops)==null?void 0:m[o].size,i,e)-u)*l}}function J(t,a,i,e){const n=(w(e)&&e.resolution?e.resolution:1)*q[a.valueUnit],r=b(a.minSize,i,e),o=b(a.maxSize,i,e),{valueRepresentation:l}=a;let s=null;return s=l==="area"?2*Math.sqrt(t/S)/n:l==="radius"||l==="distance"?2*t/n:t/n,N(s,r,o)}function K(t,a,i,e,n){switch(a.transformationType){case x.Additive:return B(t,a,i,e);case x.Constant:return W(a,i,e);case x.ClampedLinear:return j(t,a,i,e);case x.Proportional:return G(t,a,i,e);case x.Stops:return H(t,a,i,e,n);case x.RealWorldSize:return J(t,a,i,e);case x.Identity:return t;case x.Unknown:return null}}function Je(t,a,i){const{isScaleDriven:e}=t.cache;if(!(e&&i==="3d"||a))return null;const n={scale:a,view:i};let r=b(t.minSize,M,n),o=b(t.maxSize,M,n);if(r!=null||o!=null){if(r>o){const l=o;o=r,r=l}return{minSize:r,maxSize:o}}}function Ke(t,a,i){if(!t.visualVariables)return;const e=[],n=[],r=[],o=[],l=[];for(const s of t.visualVariables)switch(s.type){case"color":n.push(s);break;case"opacity":r.push(s);break;case"rotation":l.push(s);break;case"size":o.push(s)}return n.forEach(s=>{const p=A(s,a,i);e.push({variable:s,value:p})}),r.forEach(s=>{const p=O(s,a,i);e.push({variable:s,value:p})}),l.forEach(s=>{const p=L(s,a,i);e.push({variable:s,value:p})}),o.forEach(s=>{const p=R(s,a,i);e.push({variable:s,value:p})}),e.filter(s=>s.value!=null)}function C(t,a){if(!a)return;let i=0,e=a.length-1;return a.some((n,r)=>t<n?(e=r,!0):(i=r,!1)),[i,e,(t-a[i])/(a[e]-a[i])]}function Qe(t,a,i){const e=["proportional","proportional","proportional"];for(const n of t){const r=n.useSymbolValue?"symbol-value":R(n,a,i);switch(n.axis){case"width":e[0]=r;break;case"depth":e[1]=r;break;case"height":e[2]=r;break;case"width-and-depth":e[0]=r,e[1]=r;break;case"all":case void 0:case null:e[0]=r,e[1]=r,e[2]=r;break;default:T(n.axis)}}return e}export{Qe as getAllSizes,A as getColor,O as getOpacity,L as getRotationAngle,R as getSize,K as getSizeForValue,b as getSizeFromNumberOrVariable,Je as getSizeRangeAtScale,Ke as getVisualVariableValues,He as viewScaleRE};
